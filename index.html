<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoSwap - Automate Your Trades</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ü•≠ MangoSwap</h1>
                    <p class="text-gray-600 mt-1">Automate Your Token Swaps on Base</p>
                </div>
                <button id="connectBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">Connect Wallet</button>
                <div id="accountInfo" class="hidden text-right">
                    <div class="text-sm text-gray-600">Connected</div>
                    <div id="accountAddress" class="font-mono text-sm bg-gray-100 px-3 py-1 rounded"></div>
                </div>
            </div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Total Swaps</div>
                    <div id="totalSwaps" class="text-2xl font-bold text-purple-600">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Scheduled</div>
                    <div id="scheduledCount" class="text-2xl font-bold text-blue-600">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Executed</div>
                    <div id="executedCount" class="text-2xl font-bold text-green-600">0</div>
                </div>
                <div id="ownerStats" class="bg-white rounded-lg shadow p-6 hidden">
                    <button id="withdrawBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition" style="display:none;">üí∞ Withdraw</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="flex border-b">
                    <button id="scheduleTab" class="flex-1 px-6 py-4 font-semibold bg-purple-600 text-white">Schedule Swap</button>
                    <button id="swapsTab" class="flex-1 px-6 py-4 font-semibold text-gray-600 hover:bg-gray-50">My Swaps</button>
                </div>

                <div id="scheduleContent" class="p-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-blue-800"><strong>How it works:</strong> Schedule your token swaps to execute automatically at your chosen time. Perfect for DCA strategies, timed entries/exits, or avoiding emotional trading!</p>
                    </div>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">From Token</label>
                                <select id="tokenIn" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x5F62728a88AEC4878E68DCf5c48dFf3a5d8f8b8E">AUKI</option>
                                    <option value="0x3C7f2d20C05C1Da0479D1A2B21AB899e1D7c8e3E">CLANKER</option>
                                    <option value="0x05C2ec8e2f5d1e8E05e49BdD0C8cf05c6e3FAC1B">GAME</option>
                                    <option value="0x8dEa9B7E7F3a5e6b4E9A5F6d7E3a9B4C5d6E7F8A">DRB</option>
                                    <option value="custom">üîß Custom Token Address...</option>
                                </select>
                                <input type="text" id="customTokenIn" placeholder="Paste token address (0x...)" class="hidden w-full px-4 py-2 border border-gray-300 rounded-lg mt-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">To Token</label>
                                <select id="tokenOut" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x5F62728a88AEC4878E68DCf5c48dFf3a5d8f8b8E">AUKI</option>
                                    <option value="0x3C7f2d20C05C1Da0479D1A2B21AB899e1D7c8e3E">CLANKER</option>
                                    <option value="0x05C2ec8e2f5d1e8E05e49BdD0C8cf05c6e3FAC1B">GAME</option>
                                    <option value="0x8dEa9B7E7F3a5e6b4E9A5F6d7E3a9B4C5d6E7F8A">DRB</option>
                                    <option value="custom">üîß Custom Token Address...</option>
                                </select>
                                <input type="text" id="customTokenOut" placeholder="Paste token address (0x...)" class="hidden w-full px-4 py-2 border border-gray-300 rounded-lg mt-2">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Swap</label>
                                <input type="number" step="0.001" id="amountIn" placeholder="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Receive (Slippage)</label>
                                <input type="number" step="0.001" id="minAmountOut" placeholder="0.095" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">Protection against price movement</p>
                            </div>
                        </div>

                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h3 class="font-semibold text-purple-900 mb-3">‚è∞ Execution Time</h3>
                            <div class="mb-3">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="timeOption" value="now" id="timeNow" class="w-4 h-4">
                                    <span class="font-semibold">Execute Now (Instant Swap)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer mt-2">
                                    <input type="radio" name="timeOption" value="scheduled" id="timeScheduled" checked class="w-4 h-4">
                                    <span class="font-semibold">Schedule for Later</span>
                                </label>
                            </div>
                            <div id="scheduledTimeInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                    <input type="date" id="executionDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                    <input type="time" id="executionTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <p id="scheduledTimeNote" class="text-sm text-purple-700 mt-2">Your swap will execute automatically at this time (within 1 hour window)</p>
                            <p id="instantTimeNote" class="text-sm text-purple-700 mt-2 hidden">Swap will execute immediately after confirmation</p>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Fee Structure</h4>
                            <div class="space-y-1 text-sm text-gray-600">
                                <div class="flex justify-between"><span>Platform Fee:</span><span class="font-semibold">0.3%</span></div>
                                <div class="flex justify-between"><span>Execution Fee:</span><span class="font-semibold">0.2%</span></div>
                                <div class="flex justify-between border-t border-gray-300 pt-1 mt-1"><span class="font-semibold">Total:</span><span class="font-semibold text-purple-600">0.5%</span></div>
                            </div>
                        </div>

                        <button id="scheduleSwapBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 rounded-lg transition text-lg">Schedule Swap</button>
                    </div>
                </div>

                <div id="swapsContent" class="p-6 hidden">
                    <div id="swapsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0xde6d1499acfb534b36b31e2f1efff90d5af819d7';
        const BASE_CHAIN_ID = '0x2105';
        const ABI = ["function scheduleSwap(address,address,uint256,uint256,uint256) external payable returns(uint256)","function cancelSwap(uint256) external","function getSwap(uint256) external view returns(tuple(uint256,address,address,address,uint256,uint256,uint256,uint8,uint256,uint256))","function getUserSwaps(address) external view returns(uint256[])","function getTotalSwaps() external view returns(uint256)","function withdrawFees() external","function owner() external view returns(address)"];

        const TOKENS = {'0x0000000000000000000000000000000000000000':'ETH','0x833589fcd6edb6e08f4c7c32d4f71b54bda02913':'USDC','0x50c5725949a6f0c72e6c4a641f24049a917db0cb':'DAI','0x532f27101965dd16442e59d40670faf5ebb142e4':'BRETT','0x940181a94a35a4569e4529a3cdfb74e38fd98631':'AERO','0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4':'TOSHI','0x4ed4e862860bed51a9570b96d89af5e1b0efefed':'DEGEN','0xa88594d404727625a9437c3f886c7643872296ae':'WELL','0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b':'VIRTUAL','0x78a087d713be963bf307b18f2ff8122ef9a63ae9':'ZORA','0x5f62728a88aec4878e68dcf5c48dff3a5d8f8b8e':'AUKI','0x3c7f2d20c05c1da0479d1a2b21ab899e1d7c8e3e':'CLANKER','0x05c2ec8e2f5d1e8e05e49bdd0c8cf05c6e3fac1b':'GAME','0x8dea9b7e7f3a5e6b4e9a5f6d7e3a9b4c5d6e7f8a':'DRB'};

        let provider,signer,contract,account,isOwner=false;

        document.getElementById('connectBtn').addEventListener('click',connectWallet);
        document.getElementById('scheduleTab').addEventListener('click',()=>switchTab('schedule'));
        document.getElementById('swapsTab').addEventListener('click',()=>switchTab('swaps'));
        document.getElementById('scheduleSwapBtn').addEventListener('click',scheduleSwap);
        
        document.getElementById('tokenIn').addEventListener('change',function(){
            if(this.value==='custom'){
                document.getElementById('customTokenIn').classList.remove('hidden');
            }else{
                document.getElementById('customTokenIn').classList.add('hidden');
            }
        });
        
        document.getElementById('tokenOut').addEventListener('change',function(){
            if(this.value==='custom'){
                document.getElementById('customTokenOut').classList.remove('hidden');
            }else{
                document.getElementById('customTokenOut').classList.add('hidden');
            }
        });
        
        document.getElementById('timeNow').addEventListener('change',function(){
            if(this.checked){
                document.getElementById('scheduledTimeInputs').classList.add('hidden');
                document.getElementById('scheduledTimeNote').classList.add('hidden');
                document.getElementById('instantTimeNote').classList.remove('hidden');
            }
        });
        
        document.getElementById('timeScheduled').addEventListener('change',function(){
            if(this.checked){
                document.getElementById('scheduledTimeInputs').classList.remove('hidden');
                document.getElementById('scheduledTimeNote').classList.remove('hidden');
                document.getElementById('instantTimeNote').classList.add('hidden');
            }
        });

        async function connectWallet(){
            if(!window.ethereum){alert('Install MetaMask!');return;}
            try{
                const accounts=await window.ethereum.request({method:'eth_requestAccounts'});
                const chainId=await window.ethereum.request({method:'eth_chainId'});
                if(chainId!==BASE_CHAIN_ID){
                    try{
                        await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:BASE_CHAIN_ID}]});
                    }catch(e){
                        if(e.code===4902){
                            await window.ethereum.request({method:'wallet_addEthereumChain',params:[{chainId:BASE_CHAIN_ID,chainName:'Base',nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18},rpcUrls:['https://mainnet.base.org'],blockExplorerUrls:['https://basescan.org']}]});
                        }
                    }
                }
                account=accounts[0];
                provider=new ethers.providers.Web3Provider(window.ethereum);
                signer=provider.getSigner();
                contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('accountInfo').classList.remove('hidden');
                document.getElementById('accountAddress').textContent=account.slice(0,6)+'...'+account.slice(-4);
                document.getElementById('mainContent').classList.remove('hidden');
                const owner=await contract.owner();
                isOwner=owner.toLowerCase()===account.toLowerCase();
                if(isOwner){
                    document.getElementById('ownerStats').classList.remove('hidden');
                    document.getElementById('withdrawBtn').style.display='block';
                }
                loadData();
            }catch(e){
                alert('Failed: '+e.message);
            }
        }

        async function loadData(){
            try{
                const total=await contract.getTotalSwaps();
                document.getElementById('totalSwaps').textContent=total.toString();
                const ids=await contract.getUserSwaps(account);
                const swaps=await Promise.all(ids.map(async id=>{
                    const s=await contract.getSwap(id);
                    return {id:s[0].toString(),user:s[1],tokenIn:s[2],tokenOut:s[3],amountIn:ethers.utils.formatEther(s[4]),minAmountOut:ethers.utils.formatEther(s[5]),executionTime:new Date(s[6].toNumber()*1000),status:['Scheduled','Executed','Cancelled','Failed'][s[7]],executedAt:s[8].toNumber(),amountOut:ethers.utils.formatEther(s[9])};
                }));
                const scheduled=swaps.filter(s=>s.status==='Scheduled').length;
                const executed=swaps.filter(s=>s.status==='Executed').length;
                document.getElementById('scheduledCount').textContent=scheduled;
                document.getElementById('executedCount').textContent=executed;
                displaySwaps(swaps);
            }catch(e){
                console.error(e);
            }
        }

        function displaySwaps(swaps){
            const list=document.getElementById('swapsList');
            if(swaps.length===0){
                list.innerHTML='<div class="text-center py-12 text-gray-500"><p>No swaps scheduled yet!</p></div>';
                return;
            }
            list.innerHTML=swaps.map(s=>{
                const tokenInName=TOKENS[s.tokenIn.toLowerCase()]||s.tokenIn.slice(0,6)+'...';
                const tokenOutName=TOKENS[s.tokenOut.toLowerCase()]||s.tokenOut.slice(0,6)+'...';
                return `
                <div class="border rounded-lg p-6 mb-4">
                    <div class="flex justify-between mb-4">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${s.status==='Scheduled'?'bg-blue-100 text-blue-800':s.status==='Executed'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}">${s.status}</span>
                        <div class="text-right">
                            <div class="font-bold">${s.amountIn} ${tokenInName} ‚Üí ${tokenOutName}</div>
                            <div class="text-sm text-gray-600">Min: ${s.minAmountOut} ${tokenOutName}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div><span class="text-gray-600">Executes:</span><div class="font-semibold">${s.executionTime.toLocaleString()}</div></div>
                        ${s.status==='Executed'?`<div><span class="text-gray-600">Received:</span><div class="font-semibold text-green-600">${s.amountOut} ${tokenOutName}</div></div>`:''}
                    </div>
                    ${s.status==='Scheduled'?`<button onclick="cancelSwap(${s.id})" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded">Cancel Swap</button>`:''}
                </div>
            `;}).join('');
        }

        async function scheduleSwap(){
            let tokenIn=document.getElementById('tokenIn').value;
            let tokenOut=document.getElementById('tokenOut').value;
            
            if(tokenIn==='custom'){
                tokenIn=document.getElementById('customTokenIn').value.trim();
                if(!tokenIn || !tokenIn.startsWith('0x') || tokenIn.length!==42){
                    alert('Invalid token address for From Token');
                    return;
                }
            }
            
            if(tokenOut==='custom'){
                tokenOut=document.getElementById('customTokenOut').value.trim();
                if(!tokenOut || !tokenOut.startsWith('0x') || tokenOut.length!==42){
                    alert('Invalid token address for To Token');
                    return;
                }
            }
            
            const amount=document.getElementById('amountIn').value;
            const minOut=document.getElementById('minAmountOut').value;
            
            if(!amount||!minOut){alert('Fill all fields');return;}
            if(tokenIn===tokenOut){alert('Select different tokens');return;}
            
            const isInstant=document.getElementById('timeNow').checked;
            let execTime;
            
            if(isInstant){
                execTime=Math.floor(Date.now()/1000) + 60;
            }else{
                const date=document.getElementById('executionDate').value;
                const time=document.getElementById('executionTime').value;
                if(!date||!time){alert('Please set execution date and time');return;}
                execTime=Math.floor(new Date(date+' '+time).getTime()/1000);
            }
            
            try{
                const amountWei=ethers.utils.parseEther(amount);
                const minOutWei=ethers.utils.parseEther(minOut);
                const tx=tokenIn==='0x0000000000000000000000000000000000000000'?
                    await contract.scheduleSwap(tokenIn,tokenOut,amountWei,minOutWei,execTime,{value:amountWei}):
                    await contract.scheduleSwap(tokenIn,tokenOut,amountWei,minOutWei,execTime);
                await tx.wait();
                alert(isInstant?'Swap scheduled for immediate execution!':'Swap scheduled!');
                document.getElementById('amountIn').value='';
                document.getElementById('minAmountOut').value='';
                document.getElementById('executionDate').value='';
                document.getElementById('executionTime').value='';
                loadData();
            }catch(e){
                alert('Failed: '+e.message);
            }
        }

        async function cancelSwap(id){
            try{
                const tx=await contract.cancelSwap(id);
                await tx.wait();
                alert('Cancelled!');
                loadData();
            }catch(e){
                alert('Failed: '+e.message);
            }
        }

        function switchTab(tab){
            if(tab==='schedule'){
                document.getElementById('scheduleTab').classList.add('bg-purple-600','text-white');
                document.getElementById('scheduleTab').classList.remove('text-gray-600');
                document.getElementById('swapsTab').classList.remove('bg-purple-600','text-white');
                document.getElementById('swapsTab').classList.add('text-gray-600');
                document.getElementById('scheduleContent').classList.remove('hidden');
                document.getElementById('swapsContent').classList.add('hidden');
            }else{
                document.getElementById('swapsTab').classList.add('bg-purple-600','text-white');
                document.getElementById('swapsTab').classList.remove('text-gray-600');
                document.getElementById('scheduleTab').classList.remove('bg-purple-600','text-white');
                document.getElementById('scheduleTab').classList.add('text-gray-600');
                document.getElementById('swapsContent').classList.remove('hidden');
                document.getElementById('scheduleContent').classList.add('hidden');
            }
        }

        document.getElementById('withdrawBtn')?.addEventListener('click',async()=>{
            try{
                const tx=await contract.withdrawFees();
                await tx.wait();
                alert('Fees withdrawn!');
            }catch(e){
                alert('Failed: '+e.message);
            }
        });
    </script>
</body>
</html>
