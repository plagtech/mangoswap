<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoSwap - Sweet Swaps On Base</title>
    <link rel="icon" type="image/png" href="mango-logo.png">
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/viem@2.21.0/dist/viem.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk@0.1.2/dist/index.umd.js"></script>
    
    <!-- Alternative ESM loading for better compatibility -->
    <script type="module">
        import { sdk as farcasterSdk } from 'https://esm.sh/@farcaster/miniapp-sdk@0.1.2';
        window.farcasterSdkESM = farcasterSdk;
        
        // Call ready() immediately with ESM version
        if (farcasterSdk && farcasterSdk.actions && farcasterSdk.actions.ready) {
            farcasterSdk.actions.ready().then(() => {
                console.log('‚úÖ ESM ready() called successfully');
            }).catch(e => {
                console.error('ESM ready() failed:', e);
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
<!-- Open Graph Meta Tags -->
  <meta property="og:title" content="MangoSwap" />
  <meta property="og:description" content="Sweet Swaps on Base" />
  <meta property="og:image" content="https://mangoswap.xyz/og-image.png" />
  <meta property="og:url" content="https://mangoswap.xyz" />
  <meta property="og:type" content="website" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MangoSwap" />
  <meta name="twitter:description" content="Dex trading on Base with scheduled swaps" />
  <meta name="twitter:image" content="https://mangoswap.xyz/og-image.png" />
  <meta name="twitter:site" content="@Mangoswap_xyz" />
  
  <!-- Farcaster Mini App Embed Metadata -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://mangoswap.xyz/preview.png","button":{"title":"Launch MangoSwap","action":{"type":"launch_frame","name":"MangoSwap","url":"https://mangoswap.xyz","splashImageUrl":"https://mangoswap.xyz/splash.png","splashBackgroundColor":"#f18435"}}}' />
</head>
    <style>
        /* Base styles with smooth transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Dark mode variables */
        :root {
            --bg-primary: #fef3c7;
            --bg-secondary: #ffffff;
            --bg-gradient-start: #fed7aa;
            --bg-gradient-mid: #fef3c7;
            --bg-gradient-end: #d9f99d;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #fdba74;
            --card-bg: #ffffff;
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
        }
        
        body.dark-mode {
            --bg-primary: #006D77;
            --bg-secondary: #006D77;
            --bg-gradient-start: #006D77;
            --bg-gradient-mid: #006D77;
            --bg-gradient-end: #006D77;
            --text-primary: #e5e7eb;
            --text-secondary: #d1d5db;
            --border-color: #ff8c42;
            --card-bg: #006D77;
            --modal-bg: #006D77;
            --input-bg: #0f3460;
        }
        
        /* Dark mode content area background */
        body.dark-mode #scheduleContent {
            background: #006d77 !important;
        }
        
        /* Dark mode label colors - make From, To white */
        body.dark-mode #scheduleContent label {
            color: #ffffff !important;
        }
        
        /* Dark mode select/option text fix */
        body.dark-mode select {
            color: #1f2937 !important;
        }
        
        body.dark-mode select option {
            color: #1f2937 !important;
            background-color: #fef3c7 !important;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .card-bg {
            background-color: var(--card-bg);
        }
        
        .modal-bg {
            background-color: var(--modal-bg);
        }
        
        .input-bg {
            background-color: var(--input-bg);
        }
        
        .text-primary {
            color: var(--text-primary);
        }
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        .border-custom {
            border-color: var(--border-color);
        }
        
        /* Onboarding Modal Styles */
        .onboarding-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(8px); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 99999; 
            animation: fadeIn 0.3s ease-in; 
        }
        .onboarding-overlay.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .onboarding-container { 
            max-width: 340px; 
            width: 85%; 
            background: rgba(255, 140, 66, 0.95); 
            backdrop-filter: blur(10px); 
            border: 2px solid rgba(255, 107, 53, 0.3); 
            border-radius: 20px; 
            padding: 20px; 
            position: relative; 
            box-shadow: 0 20px 60px rgba(255, 107, 53, 0.3); 
        }
        .onboarding-close-btn { 
            position: absolute; 
            top: 12px; 
            right: 12px; 
            width: 32px; 
            height: 32px; 
            border: none; 
            background: rgba(26, 26, 46, 0.15); 
            border-radius: 50%; 
            color: #1a1a2e; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s ease; 
            z-index: 10; 
        }
        .onboarding-close-btn:hover { 
            background: rgba(26, 26, 46, 0.3); 
            color: #1a1a2e; 
            transform: rotate(90deg); 
        }
        .onboarding-logo { display: flex; justify-content: center; margin-bottom: 12px; }
        .onboarding-logo img { width: 64px; height: 64px; object-fit: contain; }
        .onboarding-screen { display: none; text-align: center; animation: slideIn 0.5s ease-in; color: #1a1a2e; }
        .onboarding-screen.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .onboarding-screen h1 { font-size: 28px; margin-bottom: 8px; font-weight: 700; }
        .onboarding-subtitle { font-size: 15px; color: rgba(26, 26, 46, 0.8); margin-bottom: 18px; line-height: 1.4; }
        .onboarding-feature { background: rgba(255, 255, 255, 0.5); border-radius: 12px; padding: 12px; margin-bottom: 10px; text-align: left; }
        .onboarding-feature-content { display: flex; align-items: flex-start; }
        .onboarding-number { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 24px; 
            height: 24px; 
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); 
            border-radius: 50%; 
            font-weight: 700; 
            font-size: 12px; 
            margin-right: 10px; 
            flex-shrink: 0; 
        }
        .onboarding-feature h3 { font-size: 15px; margin-bottom: 4px; font-weight: 600; color: #1a1a2e; }
        .onboarding-feature p { font-size: 13px; color: rgba(26, 26, 46, 0.75); line-height: 1.3; }
        .onboarding-dots { display: flex; justify-content: center; gap: 6px; margin: 16px 0 12px; }
        .onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(26, 26, 46, 0.3); transition: all 0.3s ease; }
        .onboarding-dot.active { background: #1a1a2e; width: 24px; border-radius: 4px; }
        .onboarding-buttons { display: flex; gap: 12px; justify-content: center; }
        .onboarding-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .onboarding-btn-skip { background: rgba(255, 255, 255, 0.6); color: #1a1a2e; border: 2px solid rgba(26, 26, 46, 0.2); }
        .onboarding-btn-skip:hover { background: rgba(255, 255, 255, 0.9); color: #1a1a2e; border-color: rgba(26, 26, 46, 0.4); }
        .onboarding-btn-next { background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%); color: white; flex: 1; max-width: 160px; }
        .onboarding-btn-next:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4); }
        @media (max-width: 480px) {
            .onboarding-container { width: 90%; padding: 16px; }
            .onboarding-screen h1 { font-size: 24px; }
            .onboarding-logo img { width: 56px; height: 56px; }
        }
        
        /* Modal styles - simplified to avoid conflicts */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        .modal-content {
            background-color: var(--modal-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 28rem;
            width: 90%;
            margin: 1rem;
            border: 4px solid var(--border-color);
        }
        
        /* Success Modal Animation */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-modal-content {
            animation: slideUp 0.4s ease-out;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confettiFall 3s linear forwards;
        }
        
        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 140, 66, 0.3);
            border-top: 3px solid #ff8c42;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Touch targets - minimum 44px */
        button, .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* User avatar styles */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Custom token validation styles */
        .custom-token-input {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .custom-token-input.valid {
            border-color: #86efac !important;
            box-shadow: 0 0 0 3px rgba(134, 239, 172, 0.3);
        }
        .custom-token-input.invalid {
            border-color: #fca5a5 !important;
            box-shadow: 0 0 0 3px rgba(252, 165, 165, 0.3);
        }
        .custom-token-input.loading {
            border-color: #fdba74 !important;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeInUp 0.3s ease-out;
        }
    </style>
<body>

    <!-- CRITICAL: Call ready() as early as possible -->
    <script>
        (function() {
            // Try to call ready() immediately when body starts loading
            function attemptReady() {
                try {
                    if (window.FarcasterMiniAppSDK && window.FarcasterMiniAppSDK.sdk) {
                        window.FarcasterMiniAppSDK.sdk.actions.ready().then(() => {
                            console.log('‚úÖ Early ready() call successful');
                        }).catch(e => console.log('Early ready() call failed:', e));
                        return true;
                    }
                } catch (e) {
                    console.log('Early ready() attempt failed:', e);
                }
                return false;
            }
            
            // Try immediately
            if (!attemptReady()) {
                // If not available, keep trying
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if (attemptReady() || attempts > 20) {
                        clearInterval(interval);
                    }
                }, 100);
            }
        })();
    </script>

    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingModal">
        <div class="onboarding-container">
            <button class="onboarding-close-btn" onclick="closeOnboarding()" title="Close">√ó</button>
            
            <div class="onboarding-logo">
                <img src="white-outline-mango.png" alt="MangoSwap">
            </div>

            <!-- Screen 1: Instant Swaps -->
            <div class="onboarding-screen active" data-screen="1">
                <h1>Welcome to MangoSwap</h1>
                <p class="onboarding-subtitle">Trade tokens on Base in seconds</p>
                
                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">1</span>
                        <div>
                            <h3>Select your tokens</h3>
                            <p>Choose what you want to swap (ETH, USDC, or any Base token)</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">2</span>
                        <div>
                            <h3>Enter amount</h3>
                            <p>Type how much you want to trade</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">3</span>
                        <div>
                            <h3>Swap instantly üîÑ</h3>
                            <p>Your trade executes in seconds at the best price</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-dots">
                    <div class="onboarding-dot active"></div>
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot"></div>
                </div>

                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-skip" onclick="closeOnboarding()">Skip</button>
                    <button class="onboarding-btn onboarding-btn-next" onclick="nextOnboardingScreen()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Screen 2: Limit Orders -->
            <div class="onboarding-screen" data-screen="2">
                <h1>Swap Any Token</h1>
                <p class="onboarding-subtitle">Trade any token on Base</p>
                
                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">1</span>
                        <div>
                            <h3>Popular tokens built-in ü™ô</h3>
                            <p>ETH, USDC, BRETT, DEGEN & more ready to trade</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">2</span>
                        <div>
                            <h3>Custom tokens üìã</h3>
                            <p>Paste any contract address to trade it instantly</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">3</span>
                        <div>
                            <h3>Best prices üí∞</h3>
                            <p>Powered by Uniswap V3 liquidity on Base</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-dots">
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot active"></div>
                    <div class="onboarding-dot"></div>
                </div>

                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-skip" onclick="closeOnboarding()">Skip</button>
                    <button class="onboarding-btn onboarding-btn-next" onclick="nextOnboardingScreen()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Screen 3: Scheduled Swaps -->
            <div class="onboarding-screen" data-screen="3">
                <h1>Schedule Your Trades</h1>
                <p class="onboarding-subtitle">Buy automatically on a regular schedule</p>
                
                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">1</span>
                        <div>
                            <h3>Pick your schedule üìÖ</h3>
                            <p>Choose daily, weekly, or monthly trades</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">2</span>
                        <div>
                            <h3>Set the amount</h3>
                            <p>Decide how much to invest each time</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">3</span>
                        <div>
                            <h3>Sit back and relax</h3>
                            <p>Your trades execute automatically‚Äîno need to watch the market</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-dots">
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot active"></div>
                </div>

                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-next" style="max-width: 100%;" onclick="closeOnboarding()">Get Started ü•≠</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End Onboarding Modal -->

    <style>
        .token-row { cursor: pointer; transition: all 0.2s ease; }
        .token-row:hover { background: rgba(255, 140, 66, 0.15); transform: translateX(4px); }
        .trending-section { max-height: 160px; overflow-y: auto; }
        .trending-section::-webkit-scrollbar { width: 4px; }
        .trending-section::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
        .trending-section::-webkit-scrollbar-thumb { background: #ff8c42; border-radius: 4px; }
        @media (max-width: 1024px) { .main-layout { flex-direction: column !important; } .swap-column { max-width: 100% !important; width: 100% !important; flex: 1 !important; } .trending-column { max-width: 100% !important; min-width: 100% !important; margin-top: 1rem; } }
    </style>
    <div class="container mx-auto px-4 py-4 max-w-6xl">
        <div class="card-bg rounded-xl shadow-lg p-4 mb-4 border-2 border-custom">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-1">
                        <img src="mango-logo.png" alt="MangoSwap" class="w-10 h-10 inline-block"> 
                        <span class="bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 bg-clip-text text-transparent">MangoSwap</span>
                    </h1>
                    <p class="text-secondary text-sm font-medium">Sweet Swaps on Base üü¶</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="shareBtn" class="touch-target bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105" title="Share on Farcaster" style="display:none;">
                        üì¢
                    </button>
                    <button id="themeToggle" class="touch-target bg-gradient-to-r from-orange-400 to-yellow-400 hover:from-orange-500 hover:to-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105" title="Toggle Dark Mode">
                        <span id="themeIcon">üåô</span>
                    </button>
                    <button id="connectBtn" class="touch-target bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white px-5 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105">Connect Wallet</button>
                </div>
                
                <!-- Slippage Settings Modal -->
                <div id="settingsModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-primary mb-4">üìä Slippage Settings</h3>
                        <div class="mb-6 p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl border-2 border-custom">
                            <label class="block text-sm font-bold text-primary mb-3">Slippage Tolerance</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold transition border-2 border-custom hover:border-orange-400" data-value="0.5">0.5%</button>
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold transition border-2 border-custom hover:border-orange-400" data-value="1">1%</button>
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold transition bg-orange-500 text-white border-2 border-orange-500" data-value="5">5%</button>
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold transition border-2 border-custom hover:border-orange-400" data-value="10">10%</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="customSlippage" placeholder="Custom" step="0.1" min="0" max="50" class="flex-1 px-3 py-2 border-2 border-custom rounded-lg font-semibold text-center input-bg text-primary">
                                <span class="font-bold text-primary">%</span>
                            </div>
                            <p class="text-xs text-orange-700 mt-2">‚ö†Ô∏è High slippage may result in unfavorable rates</p>
                        </div>
                        <button id="closeSettings" class="touch-target w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition">
                            Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- Wallet Modal -->
                <div id="walletModal" class="modal-overlay hidden">
                    <div class="modal-content max-w-sm">
                        <h3 class="text-2xl font-bold text-primary mb-4">Connect Wallet</h3>
                        <div class="space-y-3">
                            <button id="connectMetaMask" class="touch-target w-full bg-gradient-to-r from-orange-400 to-yellow-400 hover:from-orange-500 hover:to-yellow-500 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                ü¶ä MetaMask
                            </button>
                            <button id="connectCoinbase" class="touch-target w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                üîµ Base Wallet
                            </button>
                            <button id="connectPhantom" class="touch-target w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                üëª Phantom
                            </button>
                        </div>
                        <button id="closeModal" class="touch-target mt-4 w-full text-secondary hover:text-primary font-semibold">Cancel</button>
                    </div>
                </div>
                
                <!-- Success Modal -->
                <div id="successModal" class="modal-overlay hidden">
                    <div class="modal-content max-w-md success-modal-content relative overflow-hidden">
                        <!-- Confetti animation -->
                        <div class="absolute inset-0 pointer-events-none" id="confettiContainer"></div>
                        
                        <div class="text-center relative z-10">
                            <div class="text-6xl mb-4 animate-bounce">üéâ</div>
                            <h3 class="text-2xl font-bold text-primary mb-2">Swap Successful!</h3>
                            <p class="text-secondary mb-4" id="successMessage">Your swap has been completed</p>
                            
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border-2 border-green-200">
                                <div class="text-sm text-gray-600 mb-1">You received</div>
                                <div class="text-2xl font-bold text-green-600" id="successAmount">-</div>
                            </div>
                            
                            <button id="basescanLink" class="touch-target block w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition mb-3">
                                View on Basescan üîç
                            </button>
                            
                            <button id="closeSuccessModal" class="touch-target w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition">
                                Done ü•≠
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="accountInfo" class="hidden flex items-center gap-2">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="text-right">
                        <div class="text-xs text-secondary">Connected</div>
                        <div id="accountUsername" class="font-semibold text-sm text-primary flex items-center gap-1">
                            <span id="usernameText">User</span>
                            <span id="authBadge" class="hidden text-green-500 text-xs" title="Authenticated">‚úì</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Two-Column Layout -->
        <div class="main-layout flex gap-4" style="align-items: flex-start;">
            <!-- LEFT COLUMN: Swap Interface (2/3 width) -->
            <div class="swap-column" style="flex: 2; max-width: 640px;">
        <div id="mainContent">
            <div class="card-bg rounded-xl shadow-xl overflow-hidden border-2 border-custom">
                <div class="flex border-b-2 border-custom">
    <button id="scheduleTab" class="touch-target flex-1 px-3 py-2 font-bold bg-gradient-to-r from-orange-500 to-yellow-500 text-white text-xs sm:text-sm cursor-pointer" style="pointer-events: auto;">Swap</button>
    <button id="swapsTab" class="touch-target flex-1 px-3 py-2 font-bold text-secondary hover:bg-orange-50 transition text-xs sm:text-sm cursor-pointer" style="pointer-events: auto;">My Orders</button>
</div>

                <div id="scheduleContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50">
                    <div class="max-w-md mx-auto space-y-3">
                        <div class="card-bg border-2 border-custom rounded-xl p-3 shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-orange-700">From</label>
                                <div class="text-right" id="balanceSection" style="display:none;">
                                    <div class="text-xs text-secondary">Balance: <span id="balanceFrom" class="font-semibold">-</span></div>
                                    <button id="maxBtn" class="touch-target text-xs bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold px-2 py-0.5 rounded transition">MAX</button>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <input type="number" step="0.001" id="amountIn" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none text-primary">
                                    <div id="usdValueIn" class="text-xs text-secondary mt-1">$0.00</div>
                                </div>
                                <select id="tokenIn" class="touch-target bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-custom rounded-lg px-3 py-2 font-bold hover:border-orange-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[120px]">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom Token...</option>
                                </select>
                            </div>
                            <!-- Custom Token Input for From -->
                            <div id="customTokenInContainer" class="hidden mt-3">
                                <input type="text" id="customTokenIn" placeholder="Paste token contract address (0x...)" class="custom-token-input w-full px-3 py-2 border-2 border-orange-200 rounded-lg text-sm input-bg text-primary font-mono" autocomplete="off" spellcheck="false">
                                <div id="customTokenInInfo" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="flex justify-center -my-1 relative z-10">
                            <button id="swapArrow" class="touch-target bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white rounded-lg p-2 shadow-lg transition transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="card-bg border-2 border-green-300 rounded-xl p-3 shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-green-700">To (estimated)</label>
                                <div id="priceLoading" class="hidden text-xs text-orange-600 font-semibold flex items-center gap-2">
                                    <span class="spinner"></span> Fetching...
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <div class="text-2xl font-bold text-primary" id="estimatedAmount">0.0</div>
                                    <div id="usdValueOut" class="text-xs text-secondary mt-1">$0.00</div>
                                </div>
                                <input type="number" step="0.001" id="minAmountOut" placeholder="0.0" class="hidden">
                                <select id="tokenOut" class="touch-target bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold hover:border-green-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[120px]">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom Token...</option>
                                </select>
                            </div>
                            <!-- Custom Token Input for To -->
                            <div id="customTokenOutContainer" class="hidden mt-3">
                                <input type="text" id="customTokenOut" placeholder="Paste token contract address (0x...)" class="custom-token-input w-full px-3 py-2 border-2 border-green-200 rounded-lg text-sm input-bg text-primary font-mono" autocomplete="off" spellcheck="false">
                                <div id="customTokenOutInfo" class="mt-2"></div>
                            </div>
                            <div id="priceInfo" class="mt-2 space-y-1 text-xs hidden bg-green-50 p-2 rounded border border-green-200">
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Rate:</span>
                                    <span id="exchangeRate" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Min (<span id="slippageDisplay">5</span>% slippage) <button id="editSlippageBtn" class="text-orange-600 hover:text-orange-700">‚öôÔ∏è</button>:</span>
                                    <span id="minReceived" class="font-bold">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3 shadow-md">
                            <h3 class="font-bold text-orange-800 mb-2 text-sm">‚è∞ Execution Time</h3>
                            <div class="space-y-2 mb-2">
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg hover:bg-yellow-50 transition border border-yellow-200">
                                    <input type="radio" name="timeOption" value="now" id="timeNow" checked class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Swap Now ‚ö°</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg hover:bg-yellow-50 transition border border-yellow-200">
                                    <input type="radio" name="timeOption" value="scheduled" id="timeScheduled" class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Schedule for Later üìÖ</span>
                                </label>
                            </div>
                            <div id="scheduledTimeInputs" class="grid grid-cols-2 gap-2 hidden">
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">Date</label>
                                    <input type="date" id="executionDate" class="touch-target w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm font-semibold input-bg text-primary">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">Time</label>
                                    <input type="time" id="executionTime" class="touch-target w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm font-semibold input-bg text-primary">
                                </div>
                            </div>
                            <p id="instantTimeNote" class="text-xs text-orange-800 mt-2">‚ú® Swap executes immediately</p>
                            <p id="scheduledTimeNote" class="text-xs text-orange-800 mt-2 hidden">üìÖ Swap will execute at the time you select (your local timezone)</p>
                        </div>

                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg p-3 border border-green-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-green-800">Fee Breakdown</span>
                                <div class="flex gap-2">
                                    <span id="gasFreeLabel" class="hidden bg-gradient-to-r from-green-500 to-emerald-500 text-white px-2 py-0.5 rounded-full text-xs font-bold">‚ú® GAS FREE</span>
                                    <span id="oneClickLabel" class="hidden bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-2 py-0.5 rounded-full text-xs font-bold">‚ö° ONE-CLICK</span>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-800 font-semibold">Platform Fee</span>
                                <span class="font-bold text-green-900">0.5%</span>
                            </div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-800 font-semibold">Network Fee</span>
                                <span class="font-bold text-green-900" id="networkFeeText">~0.3%</span>
                            </div>
                            <div class="flex justify-between text-xs pt-1 border-t border-green-300">
                                <span class="font-bold text-green-900">Total Fee</span>
                                <span class="font-bold text-orange-600" id="totalFeeText">~0.8%</span>
                            </div>
                        </div>

                        <button id="scheduleSwapBtn" class="touch-target w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 hover:from-orange-600 hover:via-yellow-600 hover:to-green-600 text-white font-black py-3 rounded-xl transition shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btnText">üîó Connect Wallet to Swap</span>
                        </button>
                        
                        <!-- Approval Flow Indicator -->
                        <div id="approvalIndicator" class="hidden mt-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div id="step1" class="flex items-center gap-1">
                                        <div class="w-6 h-6 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">1</div>
                                        <span class="font-semibold text-blue-900 text-xs">Approve</span>
                                    </div>
                                    <div class="text-blue-400 text-xs">‚Üí</div>
                                    <div id="step2" class="flex items-center gap-1 opacity-50">
                                        <div class="w-6 h-6 rounded-full bg-gray-300 text-white flex items-center justify-center font-bold text-xs">2</div>
                                        <span class="font-semibold text-gray-600 text-xs">Swap</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-blue-800">üí° First time? Approve token once.</p>
                        </div>
                    </div>
                </div>

                <div id="swapsContent" class="p-4 hidden">
                    <!-- Stats Bar on My Swaps Page -->
                    <div class="flex justify-end gap-3 mb-4 text-xs flex-wrap">
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom">
                            <span class="text-secondary">Total Swaps:</span>
                            <span id="totalSwaps" class="font-bold text-orange-600 ml-1">0</span>
                        </div>
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom">
                            <span class="text-secondary">Limit Orders:</span>
                            <span id="totalLimitOrders" class="font-bold text-indigo-600 ml-1">0</span>
                        </div>
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom">
                            <span class="text-secondary">Scheduled:</span>
                            <span id="scheduledCount" class="font-bold text-yellow-600 ml-1">0</span>
                        </div>
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom">
                            <span class="text-secondary">Executed:</span>
                            <span id="executedCount" class="font-bold text-green-600 ml-1">0</span>
                        </div>
                        <div id="ownerStats" class="card-bg rounded-lg shadow px-3 py-1 border border-custom hidden">
                            <button id="withdrawBtn" class="touch-target text-xs bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-2 py-1 rounded font-bold transition" style="display:none;">üí∞ Withdraw</button>
                        </div>
                    </div>
                    
                    <div id="swapsList"></div>
                </div>
            </div>
        </div>
            </div><!-- End swap-column -->
            
            <!-- RIGHT COLUMN: Trending Sections (1/3 width) -->
            <div class="trending-column" style="flex: 1; max-width: 320px; min-width: 280px;">
                <div class="space-y-3">
                
                <!-- üî• Trending on Base -->
                <div class="card-bg rounded-xl shadow-lg border-2 border-orange-300 overflow-hidden">
                    <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-4 py-2">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">üî• Trending on Base</h3>
                    </div>
                    <div id="trendingList" class="trending-section p-2">
                        <div class="text-center py-4 text-secondary text-sm"><span class="spinner"></span> Loading...</div>
                    </div>
                    <div class="px-2 pb-2 text-xs text-orange-600 text-center">üëÜ Click any token to swap</div>
                </div>
                
                <!-- üìà Top Gainers -->
                <div class="card-bg rounded-xl shadow-lg border-2 border-orange-300 overflow-hidden">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-400 px-4 py-2">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">üìà Top Gainers</h3>
                    </div>
                    <div id="gainersList" class="trending-section p-2">
                        <div class="text-center py-4 text-secondary text-sm"><span class="spinner"></span> Loading...</div>
                    </div>
                </div>
                
               
                
                <!-- üíé New Listings -->
                <div class="card-bg rounded-xl shadow-lg border-2 border-orange-300 overflow-hidden">
                    <div class="bg-gradient-to-r from-orange-500 to-yellow-400 px-4 py-2">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">üíé New Listings</h3>
                    </div>
                    <div id="newListingsList" class="trending-section p-2">
                        <div class="text-center py-4 text-secondary text-sm"><span class="spinner"></span> Loading...</div>
                    </div>
                </div>
                
               
                </div><!-- End space-y-3 -->
            </div><!-- End trending-column -->
        </div><!-- End main-layout -->

        <!-- Security Info Banner -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-md p-3 mt-6 border-2 border-green-300">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üîí</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Smart Contract V4</div>
                            <button id="contractLink" class="font-mono text-xs text-green-700 hover:text-green-900 hover:underline bg-transparent border-none cursor-pointer p-0">
                                0xb81f...4D16
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">‚úÖ</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Verified Contract</div>
                            <div class="text-xs text-green-700">View on Basescan</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">üìä</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Total Swaps</div>
                            <div class="text-xs text-green-700" id="totalSwapsHeader">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0xb81fea65B45D743AB62a1A2B351f4f92fb1d4D16'; // MangoSwap V4 - NEW CONTRACT
        const BASE_CHAIN_ID = '0x2105';

        // Gas buffer constant - reserves 0.001 ETH for gas estimation
        const GAS_BUFFER_ETH = 0.001;

        // PAYMASTER CONFIGURATION
        const PAYMASTER_URL = 'https://api.developer.coinbase.com/rpc/v1/base/0XFTXVSOwf0H30PN84h07BmJgiJhNtRw';
        
        // Farcaster Mini App SDK - with safe initialization
        let sdk = null;
        let miniAppContext = null;
        let isInMiniApp = false;
        
        // Quick Auth state
        let authToken = null;
        let authenticatedUserData = null;
        let authenticatedUser = null;
        let isAuthenticated = false;
        
        // Load Mini App context on page load
        async function loadMiniAppContext() {
            try {
                if (window.FarcasterMiniAppSDK && window.FarcasterMiniAppSDK.sdk) {
                    sdk = window.FarcasterMiniAppSDK.sdk;
                    isInMiniApp = await sdk.isInMiniApp();
                    if (isInMiniApp) {
                        miniAppContext = await sdk.context;
                        console.log('Mini App Context loaded:', miniAppContext);
                        if (miniAppContext.user) {
                            updateUserDisplay(miniAppContext.user);
                        }
                        await quickAuthSignIn();
                    }
                } else {
                    console.log('Not running in Mini App context or SDK not available');
                }
            } catch (error) {
                console.error('Error loading Mini App context:', error);
            }
        }
        
        function updateUserDisplay(user) {
            const displayName = user.displayName || user.username || 'User';
            const pfpUrl = user.pfpUrl;
            const usernameTextEl = document.getElementById('usernameText');
            if (usernameTextEl) usernameTextEl.textContent = displayName;
            const avatarEl = document.getElementById('userAvatar');
            if (avatarEl && pfpUrl) {
                avatarEl.innerHTML = `<img src="${pfpUrl}" alt="${displayName}" class="w-full h-full rounded-full object-cover">`;
            } else if (avatarEl) {
                avatarEl.textContent = displayName.charAt(0).toUpperCase();
            }
        }
        
        async function quickAuthSignIn() {
            if (!sdk) return false;
            try {
                console.log('Initiating Quick Auth...');
                const { token } = await sdk.quickAuth.getToken();
                if (token) {
                    authToken = token;
                    const verified = await verifyAuthToken(token);
                    if (verified) {
                        isAuthenticated = true;
                        return true;
                    }
                }
            } catch (error) {
                console.error('Quick Auth failed:', error);
            }
            return false;
        }
        
        async function verifyAuthToken(token) {
            try {
                const payload = parseJwt(token);
                if (payload && payload.sub) {
                    authenticatedUser = { fid: payload.sub, authenticated: true, token: token };
                    updateAuthenticatedUI();
                    return true;
                }
            } catch (error) {
                console.error('Token verification failed:', error);
            }
            return false;
        }
        
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }
        
        function updateAuthenticatedUI() {
            const authBadge = document.getElementById('authBadge');
            if (authBadge && isAuthenticated) authBadge.classList.remove('hidden');
        }
        
        function signOut() {
            authToken = null;
            authenticatedUser = null;
            isAuthenticated = false;
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadMiniAppContext();
                setupNavigationHandlers();
                initializeApp();
                loadTrendingData();
            });
        } else {
            setTimeout(() => {
                loadMiniAppContext();
                setupNavigationHandlers();
                initializeApp();
                loadTrendingData();
            }, 100);
        }
        
        window.addEventListener('load', () => {
            setTimeout(async () => {
                try {
                    if (window.FarcasterMiniAppSDK?.sdk?.actions?.ready) {
                        await window.FarcasterMiniAppSDK.sdk.actions.ready();
                    }
                } catch (e) {}
            }, 200);
        });
        
        async function initializeApp() {
            await new Promise(resolve => setTimeout(resolve, 500));
            try {
                if (window.FarcasterMiniAppSDK && window.FarcasterMiniAppSDK.sdk) {
                    await window.FarcasterMiniAppSDK.sdk.actions.ready();
                } else if (sdk) {
                    await sdk.actions.ready();
                }
            } catch (error) {
                try {
                    if (window.FarcasterMiniAppSDK?.sdk?.actions?.ready) {
                        await window.FarcasterMiniAppSDK.sdk.actions.ready();
                    }
                } catch (e) {}
            }
        }
        
        function setupNavigationHandlers() {
            const contractLink = document.getElementById('contractLink');
            if (contractLink) {
                contractLink.onclick = () => {
                    const contractUrl = 'https://basescan.org/address/0xb81fea65B45D743AB62a1A2B351f4f92fb1d4D16';
                    if (sdk && isInMiniApp) sdk.actions.openUrl(contractUrl);
                    else window.open(contractUrl, '_blank');
                };
            }
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn && sdk && isInMiniApp) {
                shareBtn.style.display = 'block';
                shareBtn.onclick = () => {
                    sdk.actions.composeCast({
                        text: 'ü•≠ Just discovered MangoSwap - gas-free swaps on Base with limit orders and scheduled trades!',
                        embeds: [window.location.href]
                    });
                };
            }
        }
        
        const ABI = [
            "function instantSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut) external payable returns (uint256)",
            "function scheduleSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minOut, uint256 time) external payable returns (uint256)",
            "function createLimitOrder(address tokenIn, address tokenOut, uint256 amountIn, uint256 price, uint256 expiry) external payable returns (uint256)",
            "function executeScheduledSwap(uint256 swapId) external",
            "function executeLimitOrder(uint256 orderId) external",
            "function cancelSwap(uint256 swapId) external",
            "function cancelLimitOrder(uint256 orderId) external",
            "function getSwap(uint256 id) external view returns (tuple(address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut, uint256 executionTime, uint8 status, uint256 amountOut))",
            "function getLimitOrder(uint256 id) external view returns (tuple(address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 targetPrice, uint256 expiryTime, uint8 status, uint256 amountOut))",
            "function getUserSwaps(address user) external view returns (uint256[])",
            "function getUserLimitOrders(address user) external view returns (uint256[])",
            "function getTotalSwaps() external view returns (uint256)",
            "function getTotalLimitOrders() external view returns (uint256)",
            "function updatePlatformFee(uint256 newFee) external",
            "function withdrawFees() external",
            "function owner() external view returns (address)",
            "function platformFee() external view returns (uint256)"
        ];

        const TOKENS = {'0x0000000000000000000000000000000000000000':'ETH','0x4200000000000000000000000000000000000006':'WETH','0x833589fcd6edb6e08f4c7c32d4f71b54bda02913':'USDC','0x50c5725949a6f0c72e6c4a641f24049a917db0cb':'DAI','0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf':'cbBTC','0x532f27101965dd16442e59d40670faf5ebb142e4':'BRETT','0x940181a94a35a4569e4529a3cdfb74e38fd98631':'AERO','0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4':'TOSHI','0x4ed4e862860bed51a9570b96d89af5e1b0efefed':'DEGEN','0xa88594d404727625a9437c3f886c7643872296ae':'WELL','0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b':'VIRTUAL','0x78a087d713be963bf307b18f2ff8122ef9a63ae9':'ZORA','0x58d97b57bb95320f9a05dc918aef65434969c2b2':'MORPHO','0x22af33fe49fd1fa80c7149773dde5890d3c76f3b':'BANKR','0xb1a03eda10342529bbf8eb700a06c60441fef25d':'MIGGLES'};

        const WETH = '0x4200000000000000000000000000000000000006';
        let provider, signer, contract, account, isOwner = false;
        let quoteTimeout;
        let selectedWallet = null;
        let isConnected = false;
        
        let baseAccountCapabilities = { atomicBatch: false, paymasterService: false, auxiliaryFunds: false };
        let slippageTolerance = 5;
        let userBalanceFrom = 0;
        let currentPriceUSD = 0;
        let currentMarketPriceValue = 0;

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) returns (bool)"
        ];

        // ============================================
        // CUSTOM TOKEN VALIDATION SYSTEM
        // ============================================
        const customTokenCache = {};

        function isValidAddress(address) {
            return address && /^0x[a-fA-F0-9]{40}$/i.test(address);
        }

        async function fetchTokenMetadata(address) {
            if (!isValidAddress(address)) {
                return { valid: false, error: 'Invalid address format. Must be 0x followed by 40 hex characters.' };
            }
            const cacheKey = address.toLowerCase();
            if (customTokenCache[cacheKey]) return customTokenCache[cacheKey];

            try {
                const rpcProvider = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const tokenContract = new ethers.Contract(address, [
                    "function name() view returns (string)",
                    "function symbol() view returns (string)",
                    "function decimals() view returns (uint8)"
                ], rpcProvider);
                
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000));
                const [name, symbol, decimals] = await Promise.race([
                    Promise.all([
                        tokenContract.name().catch(() => 'Unknown Token'),
                        tokenContract.symbol().catch(() => '???'),
                        tokenContract.decimals().catch(() => 18)
                    ]),
                    timeoutPromise
                ]);
                
                const result = { valid: true, address: address, name: name, symbol: symbol, decimals: decimals };
                customTokenCache[cacheKey] = result;
                TOKENS[cacheKey] = symbol;
                return result;
            } catch (error) {
                return { valid: false, error: 'Unable to read token contract. Make sure this is a valid ERC20 token on Base.' };
            }
        }

        function displayTokenInfo(inputElement, infoContainerId, metadata) {
            const infoContainer = document.getElementById(infoContainerId);
            if (!infoContainer) return;
            infoContainer.innerHTML = '';
            inputElement.classList.remove('valid', 'invalid', 'loading');
            
            if (metadata.valid) {
                inputElement.classList.add('valid');
                infoContainer.innerHTML = `
                    <div class="animate-fadeIn p-2 bg-green-50 border border-green-300 rounded-lg text-xs">
                        <div class="flex items-center gap-2">
                            <span class="text-green-600 font-bold">‚úì Token Found:</span>
                            <span class="font-bold text-gray-800">${metadata.symbol}</span>
                        </div>
                        <div class="text-gray-600 mt-1">${metadata.name}</div>
                    </div>
                `;
                inputElement.dataset.symbol = metadata.symbol;
                inputElement.dataset.name = metadata.name;
                inputElement.dataset.decimals = metadata.decimals;
                inputElement.dataset.validAddress = metadata.address;
            } else {
                inputElement.classList.add('invalid');
                infoContainer.innerHTML = `
                    <div class="animate-fadeIn p-2 bg-red-50 border border-red-300 rounded-lg text-xs">
                        <div class="text-red-600 font-bold">‚úó Error</div>
                        <div class="text-red-700 mt-1">${metadata.error}</div>
                    </div>
                `;
                delete inputElement.dataset.validAddress;
            }
        }

        function debounceValidation(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // KEY FUNCTION: Get the actual token address (handles custom tokens)
        function getTokenAddress(selectId, customInputId) {
            const select = document.getElementById(selectId);
            const customInput = document.getElementById(customInputId);
            if (!select) return null;
            
            if (select.value === 'custom') {
                if (!customInput) return null;
                const address = customInput.value.trim();
                if (!isValidAddress(address)) return null;
                return customInput.dataset.validAddress || address;
            }
            return select.value;
        }

        function getTokenSymbol(address) {
            if (!address) return 'Token';
            const lowerAddress = address.toLowerCase();
            return TOKENS[lowerAddress] || (address.slice(0, 6) + '...' + address.slice(-4));
        }

        function setupCustomTokenHandler(selectId, containerId, inputId, infoId, onValidCallback) {
            const select = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            if (!select || !container || !input) return;
            
            select.addEventListener('change', function() {
                if (this.value === 'custom') {
                    container.classList.remove('hidden');
                    input.focus();
                } else {
                    container.classList.add('hidden');
                    const infoContainer = document.getElementById(infoId);
                    if (infoContainer) infoContainer.innerHTML = '';
                    input.value = '';
                    input.classList.remove('valid', 'invalid', 'loading');
                    delete input.dataset.validAddress;
                }
                if (onValidCallback) setTimeout(onValidCallback, 100);
            });
            
            const validateInput = debounceValidation(async function() {
                const address = input.value.trim();
                if (!address) {
                    input.classList.remove('valid', 'invalid', 'loading');
                    const infoContainer = document.getElementById(infoId);
                    if (infoContainer) infoContainer.innerHTML = '';
                    delete input.dataset.validAddress;
                    return;
                }
                if (address.length < 42) return;
                
                input.classList.remove('valid', 'invalid');
                input.classList.add('loading');
                const infoContainer = document.getElementById(infoId);
                if (infoContainer) {
                    infoContainer.innerHTML = '<div class="p-2 text-xs text-orange-600 flex items-center gap-2"><span class="spinner"></span> Validating token...</div>';
                }
                
                const metadata = await fetchTokenMetadata(address);
                displayTokenInfo(input, infoId, metadata);
                if (metadata.valid && onValidCallback) onValidCallback();
            }, 800);
            
            input.addEventListener('input', validateInput);
            input.addEventListener('paste', () => setTimeout(validateInput, 100));
        }

        function updateUsernameDisplay(address) {
            if (miniAppContext && miniAppContext.user) {
                const user = miniAppContext.user;
                const displayName = user.displayName || user.username || 'User';
                const pfpUrl = user.pfpUrl;
                document.getElementById('accountUsername').textContent = displayName;
                const avatarEl = document.getElementById('userAvatar');
                if (pfpUrl) {
                    avatarEl.innerHTML = `<img src="${pfpUrl}" alt="${displayName}" class="w-full h-full rounded-full object-cover">`;
                } else {
                    avatarEl.textContent = displayName.charAt(0).toUpperCase();
                }
            } else {
                const shortAddress = address.slice(0, 6) + '...' + address.slice(-4);
                const username = 'User ' + shortAddress;
                const initial = address.slice(2, 3).toUpperCase();
                document.getElementById('userAvatar').textContent = initial;
                document.getElementById('accountUsername').textContent = username;
            }
        }


        async function detectBaseAccountCapabilities(address) {
            try {
                const capabilities = await window.ethereum.request({ method: 'wallet_getCapabilities', params: [address] }).catch(() => null);
                if (capabilities && capabilities['0x2105']) {
                    const baseCapabilities = capabilities['0x2105'];
                    baseAccountCapabilities = {
                        atomicBatch: baseCapabilities.atomicBatch?.supported || false,
                        paymasterService: baseCapabilities.paymasterService?.supported || false,
                        auxiliaryFunds: baseCapabilities.auxiliaryFunds?.supported || false
                    };
                    updateCapabilityUI();
                }
            } catch (error) {
                console.error('Error detecting capabilities:', error);
            }
        }
        
        function updateCapabilityUI() {
            const gasFreeLabel = document.getElementById('gasFreeLabel');
            const oneClickLabel = document.getElementById('oneClickLabel');
            const networkFeeText = document.getElementById('networkFeeText');
            const totalFeeText = document.getElementById('totalFeeText');
            if (baseAccountCapabilities.paymasterService) {
                if (gasFreeLabel) gasFreeLabel.classList.remove('hidden');
                if (networkFeeText) networkFeeText.innerHTML = '<span class="line-through">~0.3%</span> <span class="text-green-600 font-bold">FREE</span>';
                if (totalFeeText) totalFeeText.textContent = '0.5%';
            }
            if (baseAccountCapabilities.atomicBatch) {
                if (oneClickLabel) oneClickLabel.classList.remove('hidden');
            }
            if (baseAccountCapabilities.paymasterService && baseAccountCapabilities.atomicBatch) {
                const btnText = document.getElementById('btnText');
                if (btnText && isConnected) btnText.textContent = '‚ú® Swap Now (Gas Free)';
            }
        }
        
        function updateButtonStates() {
            if (isConnected) {
                document.getElementById('scheduleSwapBtn').disabled = false;
                if (baseAccountCapabilities.paymasterService && baseAccountCapabilities.atomicBatch) {
                    document.getElementById('btnText').textContent = '‚ú® Swap Now (Gas Free)';
                } else {
                    document.getElementById('btnText').textContent = 'ü•≠ Swap Now üå¥';
                }
            } else {
                document.getElementById('scheduleSwapBtn').disabled = true;
                document.getElementById('btnText').textContent = 'üîó Connect Wallet to Swap';
            }
        }

        document.getElementById('editSlippageBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('hidden');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        function updateSlippageUI() {
            document.getElementById('slippageDisplay').textContent = slippageTolerance;
            document.querySelectorAll('.slippage-btn').forEach(btn => {
                if (parseFloat(btn.dataset.value) === slippageTolerance) {
                    btn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.remove('border-custom');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.add('border-custom');
                }
            });
        }

        document.querySelectorAll('.slippage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                slippageTolerance = parseFloat(btn.dataset.value);
                updateSlippageUI();
                getQuote();
            });
        });

        document.getElementById('customSlippage').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value && value > 0 && value <= 50) {
                slippageTolerance = value;
                updateSlippageUI();
                getQuote();
            }
        });

        document.getElementById('connectBtn').addEventListener('click', showWalletModal);
        document.getElementById('closeModal').addEventListener('click', hideWalletModal);
        document.getElementById('connectMetaMask').addEventListener('click', () => connectWallet('metamask'));
        document.getElementById('connectCoinbase').addEventListener('click', () => connectWallet('coinbase'));
        document.getElementById('connectPhantom').addEventListener('click', () => connectWallet('phantom'));
        document.getElementById('scheduleTab').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('swapsTab').addEventListener('click', () => switchTab('swaps'));
        document.getElementById('scheduleSwapBtn').addEventListener('click', scheduleSwap);
        
        document.getElementById('amountIn').addEventListener('input', debounceQuote);
        document.getElementById('tokenIn').addEventListener('change', () => {
            getQuote();
            if (isConnected) updateBalance();
        });
        document.getElementById('tokenOut').addEventListener('change', getQuote);
        
        document.getElementById('maxBtn').addEventListener('click', () => {
            if (!isConnected) {
                alert('Please connect your wallet first');
                return;
            }
            const tokenIn = getTokenAddress('tokenIn', 'customTokenIn');
            const isNativeToken = tokenIn === '0x0000000000000000000000000000000000000000';
            const gasBuffer = isNativeToken ? GAS_BUFFER_ETH : 0;
            const maxAmount = Math.max(0, userBalanceFrom - gasBuffer);
            if (maxAmount <= 0 && isNativeToken) {
                alert(`Please leave ${GAS_BUFFER_ETH} ETH for gas fees.\n\nYour balance: ${userBalanceFrom.toFixed(4)} ETH\nGas buffer needed: ${GAS_BUFFER_ETH} ETH`);
                return;
            }
            document.getElementById('amountIn').value = maxAmount.toFixed(6);
            getQuote();
        });
        
        document.getElementById('swapArrow').addEventListener('click', function() {
            const tokenInSelect = document.getElementById('tokenIn');
            const tokenOutSelect = document.getElementById('tokenOut');
            const tempValue = tokenInSelect.value;
            tokenInSelect.value = tokenOutSelect.value;
            tokenOutSelect.value = tempValue;
            // Handle custom token containers swap
            if (tokenInSelect.value === 'custom') {
                document.getElementById('customTokenInContainer').classList.remove('hidden');
            } else {
                document.getElementById('customTokenInContainer').classList.add('hidden');
            }
            if (tokenOutSelect.value === 'custom') {
                document.getElementById('customTokenOutContainer').classList.remove('hidden');
            } else {
                document.getElementById('customTokenOutContainer').classList.add('hidden');
            }
            getQuote();
        });
        
        document.getElementById('timeNow').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.add('hidden');
                document.getElementById('scheduledTimeNote').classList.add('hidden');
                document.getElementById('instantTimeNote').classList.remove('hidden');
                updateButtonStates();
            }
        });
        
        document.getElementById('timeScheduled').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.remove('hidden');
                document.getElementById('scheduledTimeNote').classList.remove('hidden');
                document.getElementById('instantTimeNote').classList.add('hidden');
                if (isConnected) document.getElementById('btnText').textContent = 'üìÖ Schedule Swap';
            }
        });

        function showWalletModal() {
            document.getElementById('walletModal').classList.remove('hidden');
        }

        function hideWalletModal() {
            document.getElementById('walletModal').classList.add('hidden');
        }
        
        function showSuccessModal(txHash, amountOut, tokenOutSymbol) {
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successAmount').textContent = `${parseFloat(amountOut).toFixed(6)} ${tokenOutSymbol}`;
            const basescanBtn = document.getElementById('basescanLink');
            const basescanUrl = `https://basescan.org/tx/${txHash}`;
            basescanBtn.onclick = () => {
                if (sdk && isInMiniApp) sdk.actions.openUrl(basescanUrl);
                else window.open(basescanUrl, '_blank');
            };
            createConfetti();
        }
        
        function hideSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }
        
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            container.innerHTML = '';
            const colors = ['#ff6b35', '#f7931e', '#fdc830', '#37b34a', '#4facfe', '#a78bfa'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
            setTimeout(() => { container.innerHTML = ''; }, 3000);
        }
        
        document.getElementById('closeSuccessModal').addEventListener('click', hideSuccessModal);

        // Dark Mode Toggle
        document.getElementById('themeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('themeIcon');
            if (document.body.classList.contains('dark-mode')) {
                icon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('mangoswapTheme', 'dark');
            } else {
                icon.textContent = 'üåô';
                localStorage.setItem('mangoswapTheme', 'light');
            }
        });

        // Load saved theme preference
        if (localStorage.getItem('mangoswapTheme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
        }

        async function connectWallet(walletType) {
            console.log('Attempting to connect:', walletType);
            selectedWallet = walletType;
            hideWalletModal();

            let ethereum;
            if (walletType === 'phantom') {
                if (window.phantom?.ethereum) ethereum = window.phantom.ethereum;
                else { alert('Phantom wallet not installed!'); return; }
            } else if (walletType === 'coinbase') {
                if (window.ethereum?.isCoinbaseWallet) ethereum = window.ethereum;
                else { alert('Base Wallet not detected!'); return; }
            } else {
                if (!window.ethereum) { alert('No wallet detected!'); return; }
                ethereum = window.ethereum;
            }

            if (!ethereum) { alert('Wallet provider not found!'); return; }
            
            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== BASE_CHAIN_ID) {
                    try {
                        await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_CHAIN_ID }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{ chainId: BASE_CHAIN_ID, chainName: 'Base', nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }, rpcUrls: ['https://mainnet.base.org'], blockExplorerUrls: ['https://basescan.org'] }]
                            });
                        } else throw switchError;
                    }
                }
                
                account = accounts[0];
                provider = new ethers.providers.Web3Provider(ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                isConnected = true;
                
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('accountInfo').classList.remove('hidden');
                updateUsernameDisplay(account);
                document.getElementById('balanceSection').style.display = 'block';
                updateButtonStates();
                
                const owner = await contract.owner();
                isOwner = owner.toLowerCase() === account.toLowerCase();
                if (isOwner) {
                    document.getElementById('ownerStats').classList.remove('hidden');
                    document.getElementById('withdrawBtn').style.display = 'block';
                }
                
                loadData();
                updateBalance();
                await detectBaseAccountCapabilities(account);
                
                if (isInMiniApp && !isAuthenticated) await quickAuthSignIn();
            } catch (e) {
                console.error('Connection error:', e);
                alert('Failed to connect: ' + e.message);
            }
        }

        async function loadData() {
            try {
                const total = await contract.getTotalSwaps();
                const totalOrders = await contract.getTotalLimitOrders();
                document.getElementById('totalSwaps').textContent = total.toString();
                document.getElementById('totalLimitOrders').textContent = totalOrders.toString();
                document.getElementById('totalSwapsHeader').textContent = total.toString() + ' completed';
                
                const ids = await contract.getUserSwaps(account);
                const swaps = await Promise.all(ids.map(async id => {
                    const s = await contract.getSwap(id);
                    return { id: id.toString(), user: s[0], tokenIn: s[1], tokenOut: s[2], amountIn: ethers.utils.formatEther(s[3]), minAmountOut: ethers.utils.formatEther(s[4]), executionTime: new Date(s[5].toNumber() * 1000), status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][s[6]], amountOut: ethers.utils.formatEther(s[7]), type: 'swap' };
                }));
                
                const limitIds = await contract.getUserLimitOrders(account);
                const limitOrders = await Promise.all(limitIds.map(async id => {
                    const lo = await contract.getLimitOrder(id);
                    return { id: id.toString(), user: lo[0], tokenIn: lo[1], tokenOut: lo[2], amountIn: ethers.utils.formatEther(lo[3]), targetPrice: ethers.utils.formatEther(lo[4]), expiryTime: lo[5].toNumber() === 0 ? 0 : new Date(lo[5].toNumber() * 1000), status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][lo[6]], amountOut: ethers.utils.formatEther(lo[7]), type: 'limit' };
                }));

                const allOrders = [...swaps, ...limitOrders].sort((a, b) => {
                    const timeA = a.type === 'swap' ? a.executionTime : (a.expiryTime || new Date());
                    const timeB = b.type === 'swap' ? b.executionTime : (b.expiryTime || new Date());
                    return timeB - timeA;
                });

                const scheduled = swaps.filter(s => s.status === 'Scheduled').length + limitOrders.filter(lo => lo.status === 'Scheduled').length;
                const executed = swaps.filter(s => s.status === 'Executed').length + limitOrders.filter(lo => lo.status === 'Executed').length;
                
                document.getElementById('scheduledCount').textContent = scheduled;
                document.getElementById('executedCount').textContent = executed;
                displaySwaps(allOrders);
            } catch (e) {
                console.error('Load data error:', e);
            }
        }

        function displaySwaps(orders) {
            const list = document.getElementById('swapsList');
            if (orders.length === 0) {
                list.innerHTML = '<div class="text-center py-12 text-secondary"><p>No orders yet! ü•≠</p><p class="text-sm mt-2">Create your first swap or limit order to get started</p></div>';
                return;
            }
            list.innerHTML = orders.map(s => {
                const tokenInName = TOKENS[s.tokenIn.toLowerCase()] || s.tokenIn.slice(0, 6) + '...';
                const tokenOutName = TOKENS[s.tokenOut.toLowerCase()] || s.tokenOut.slice(0, 6) + '...';
                
                if (s.type === 'limit') {
                    const statusColor = s.status === 'Scheduled' ? 'indigo' : s.status === 'Executed' ? 'green' : 'gray';
                    const expiryText = s.expiryTime === 0 ? 'Never expires' : `Expires: ${s.expiryTime.toLocaleString()}`;
                    return `<div class="border-2 border-${statusColor}-200 rounded-xl p-4 mb-3 bg-gradient-to-r from-${statusColor}-50 to-purple-50 shadow-lg card-bg">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-800">üéØ ${s.status} Limit Order</span>
                            <div class="text-right">
                                <div class="font-bold text-lg text-primary">${parseFloat(s.amountIn).toFixed(4)} ${tokenInName} ‚Üí ${tokenOutName}</div>
                                <div class="text-sm text-${statusColor}-700">Target: ${parseFloat(s.targetPrice).toFixed(6)} ${tokenOutName}</div>
                            </div>
                        </div>
                        <div class="text-xs text-secondary mb-2">${expiryText}</div>
                        ${s.status === 'Executed' ? `<div class="text-xs text-green-700 font-semibold mb-2">‚úÖ Received: ${parseFloat(s.amountOut).toFixed(6)} ${tokenOutName}</div>` : ''}
                        ${s.status === 'Scheduled' ? `<button onclick="cancelLimitOrder(${s.id})" class="touch-target w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition text-sm">Cancel Order</button>` : ''}
                    </div>`;
                }
                
                const statusColor = s.status === 'Scheduled' ? 'yellow' : s.status === 'Executed' ? 'green' : 'gray';
                return `<div class="border-2 border-${statusColor}-200 rounded-xl p-4 mb-3 card-bg shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-800">${s.status} Swap</span>
                        <div class="text-right">
                            <div class="font-bold text-lg text-primary">${parseFloat(s.amountIn).toFixed(4)} ${tokenInName} ‚Üí ${tokenOutName}</div>
                            <div class="text-sm text-secondary">Min: ${parseFloat(s.minAmountOut).toFixed(6)} ${tokenOutName}</div>
                        </div>
                    </div>
                    <div class="text-xs text-secondary mb-2">Executes: ${s.executionTime.toLocaleString()}</div>
                    ${s.status === 'Executed' ? `<div class="text-xs text-green-700 font-semibold mb-2">‚úÖ Received: ${parseFloat(s.amountOut).toFixed(6)} ${tokenOutName}</div>` : ''}
                    ${s.status === 'Scheduled' ? `<button onclick="cancelSwap(${s.id})" class="touch-target w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition text-sm">Cancel Swap</button>` : ''}
                </div>`;
            }).join('');
        }

        async function executeBatchedSwap(tokenIn, tokenOut, amountWei, minOutWei) {
            try {
                const calls = [];
                const isNativeToken = tokenIn === '0x0000000000000000000000000000000000000000';
                if (!isNativeToken) {
                    const approvalData = viem.encodeFunctionData({
                        abi: [{ inputs: [{ name: 'spender', type: 'address' }, { name: 'amount', type: 'uint256' }], name: 'approve', outputs: [{ name: '', type: 'bool' }], stateMutability: 'nonpayable', type: 'function' }],
                        functionName: 'approve',
                        args: [CONTRACT_ADDRESS, amountWei.toString()]
                    });
                    calls.push({ to: tokenIn, data: approvalData, value: '0x0' });
                }
                const swapData = viem.encodeFunctionData({
                    abi: [{ inputs: [{ name: 'tokenIn', type: 'address' }, { name: 'tokenOut', type: 'address' }, { name: 'amountIn', type: 'uint256' }, { name: 'minAmountOut', type: 'uint256' }], name: 'instantSwap', outputs: [{ name: '', type: 'uint256' }], stateMutability: 'payable', type: 'function' }],
                    functionName: 'instantSwap',
                    args: [tokenIn, tokenOut, amountWei.toString(), minOutWei.toString()]
                });
                calls.push({ to: CONTRACT_ADDRESS, data: swapData, value: isNativeToken ? `0x${amountWei.toString(16)}` : '0x0' });
                
                const capabilities = await window.ethereum.request({ method: 'wallet_getCapabilities', params: [account] }).catch(() => null);
                const supportsBatching = capabilities?.['0x2105']?.['atomicBatch']?.supported || false;
                if (supportsBatching && PAYMASTER_URL !== 'YOUR_PAYMASTER_URL_HERE') {
                    const result = await window.ethereum.request({
                        method: 'wallet_sendCalls',
                        params: [{ from: account, calls: calls, capabilities: { paymasterService: { url: PAYMASTER_URL } } }]
                    });
                    return { hash: result, batched: true };
                }
                return null;
            } catch (error) {
                console.error('Batched swap error:', error);
                return null;
            }
        }

        async function scheduleSwap() {
            if (!isConnected) {
                alert('Please connect your wallet first');
                showWalletModal();
                return;
            }
            
            if (isInMiniApp && !isAuthenticated) {
                const authenticated = await quickAuthSignIn();
                if (!authenticated) console.log('Authentication not available, proceeding with wallet-only verification');
            }
            
            // Get token addresses using the custom token helper
            let tokenIn = getTokenAddress('tokenIn', 'customTokenIn');
            let tokenOut = getTokenAddress('tokenOut', 'customTokenOut');
            
            if (!tokenIn || !isValidAddress(tokenIn)) {
                alert('Please enter a valid From token address');
                return;
            }
            if (!tokenOut || !isValidAddress(tokenOut)) {
                alert('Please enter a valid To token address');
                return;
            }
            
            const amount = document.getElementById('amountIn').value;
            const minOut = document.getElementById('minAmountOut').value;
            
            if (!amount || !minOut) {
                alert('Please fill all fields and wait for price quote');
                return;
            }
            
            if (parseFloat(amount) > userBalanceFrom && document.getElementById('tokenIn').value !== 'custom') {
                alert(`Insufficient balance. You have ${userBalanceFrom.toFixed(4)} tokens.`);
                return;
            }
            
            if (tokenIn.toLowerCase() === tokenOut.toLowerCase()) {
                alert('Please select different tokens');
                return;
            }
            
            const isInstant = document.getElementById('timeNow').checked;
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                const minOutWei = ethers.utils.parseEther(minOut);
                
                if (isInstant) {
                    const isNativeToken = tokenIn === '0x0000000000000000000000000000000000000000';
                    if (isNativeToken) {
                        const amountFloat = parseFloat(amount);
                        if (amountFloat > (userBalanceFrom - GAS_BUFFER_ETH)) {
                            const available = Math.max(0, userBalanceFrom - GAS_BUFFER_ETH);
                            alert(`‚ùå Insufficient Balance\n\nYour balance: ${userBalanceFrom.toFixed(4)} ETH\nTrying to swap: ${amountFloat.toFixed(4)} ETH\nGas buffer needed: ${GAS_BUFFER_ETH} ETH\n\nüí° Maximum you can swap: ${available.toFixed(4)} ETH`);
                            return;
                        }
                    }
                    
                    document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Swapping...';
                    document.getElementById('scheduleSwapBtn').disabled = true;
                    
                    const batchedResult = await executeBatchedSwap(tokenIn, tokenOut, amountWei, minOutWei);
                    
                    if (batchedResult && batchedResult.batched) {
                        updateButtonStates();
                        const tokenOutName = getTokenSymbol(tokenOut);
                        const estimatedOut = document.getElementById('estimatedAmount').textContent;
                        showSuccessModal(batchedResult.hash, estimatedOut, tokenOutName);
                    } else {
                        if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                            const tokenContract = new ethers.Contract(tokenIn, ['function approve(address spender, uint256 amount) external returns (bool)'], signer);
                            const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                            document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Approving...';
                            await approveTx.wait();
                        }
                        
                        document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Swapping...';
                        const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                            await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, { value: amountWei, gasLimit: 500000 }) :
                            await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, { gasLimit: 500000 });
                        
                        await tx.wait();
                        updateButtonStates();
                        const tokenOutName = getTokenSymbol(tokenOut);
                        const estimatedOut = document.getElementById('estimatedAmount').textContent;
                        showSuccessModal(tx.hash, estimatedOut, tokenOutName);
                    }
                } else {
                    const date = document.getElementById('executionDate').value;
                    const time = document.getElementById('executionTime').value;
                    if (!date || !time) {
                        alert('Please set execution date and time');
                        return;
                    }
                    const execTime = Math.floor(new Date(date + ' ' + time).getTime() / 1000);
                    if (execTime <= Math.floor(Date.now() / 1000)) {
                        alert('Execution time must be in the future');
                        return;
                    }
                    
                    if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                        const tokenContract = new ethers.Contract(tokenIn, ['function approve(address spender, uint256 amount) external returns (bool)'], signer);
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                        document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Approving...';
                        document.getElementById('scheduleSwapBtn').disabled = true;
                        await approveTx.wait();
                    }
                    
                    document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Scheduling...';
                    const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                        await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime, { value: amountWei }) :
                        await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime);
                    
                    await tx.wait();
                    updateButtonStates();
                    alert('üìÖ Swap scheduled! It will execute automatically at the scheduled time.');
                }
                
                document.getElementById('amountIn').value = '';
                document.getElementById('minAmountOut').value = '';
                document.getElementById('executionDate').value = '';
                document.getElementById('executionTime').value = '';
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                
                if (isConnected) {
                    loadData();
                    updateBalance();
                }
            } catch (e) {
                console.error('Swap error:', e);
                updateButtonStates();
                let errorMsg = 'Swap failed: ';
                if (e.code === 'INSUFFICIENT_FUNDS') errorMsg += 'Insufficient funds for gas or swap amount';
                else if (e.message.includes('user rejected')) errorMsg += 'Transaction was rejected';
                else if (e.reason) errorMsg += e.reason;
                else if (e.error?.message) errorMsg += e.error.message;
                else errorMsg += e.message || 'Unknown error';
                alert(errorMsg);
            }
        }

        async function cancelSwap(id) {
            try {
                const tx = await contract.cancelSwap(id);
                await tx.wait();
                alert('Swap cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel swap error:', e);
                alert('Failed: ' + e.message);
            }
        }

        async function cancelLimitOrder(id) {
            try {
                const tx = await contract.cancelLimitOrder(id);
                await tx.wait();
                alert('Limit order cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel limit order error:', e);
                alert('Failed: ' + e.message);
            }
        }

        function switchTab(tab) {
            document.getElementById('scheduleTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
            document.getElementById('swapsTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
            document.getElementById('scheduleTab').classList.add('text-secondary');
            document.getElementById('swapsTab').classList.add('text-secondary');
            document.getElementById('scheduleContent').classList.add('hidden');
            document.getElementById('swapsContent').classList.add('hidden');
            
            if (tab === 'schedule') {
                document.getElementById('scheduleTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.remove('text-secondary');
                document.getElementById('scheduleContent').classList.remove('hidden');
            } else {
                document.getElementById('swapsTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.remove('text-secondary');
                document.getElementById('swapsContent').classList.remove('hidden');
                if (isConnected) loadData();
            }
        }
        
        document.getElementById('withdrawBtn')?.addEventListener('click', async () => {
            try {
                const tx = await contract.withdrawFees();
                await tx.wait();
                alert('Fees withdrawn!');
            } catch (e) {
                console.error('Withdraw error:', e);
                alert('Failed: ' + e.message);
            }
        });

        function debounceQuote() {
            clearTimeout(quoteTimeout);
            quoteTimeout = setTimeout(getQuote, 500);
        }

        async function updateBalance() {
            if (!provider || !account) return;
            const tokenIn = getTokenAddress('tokenIn', 'customTokenIn');
            if (!tokenIn) return;
            
            try {
                let balance;
                if (tokenIn === '0x0000000000000000000000000000000000000000') {
                    balance = await provider.getBalance(account);
                    userBalanceFrom = parseFloat(ethers.utils.formatEther(balance));
                } else {
                    const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, provider);
                    balance = await tokenContract.balanceOf(account);
                    const decimals = await tokenContract.decimals();
                    userBalanceFrom = parseFloat(ethers.utils.formatUnits(balance, decimals));
                }
                const tokenName = getTokenSymbol(tokenIn);
                document.getElementById('balanceFrom').textContent = `${userBalanceFrom.toFixed(4)} ${tokenName}`;
                
                if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                    document.getElementById('approvalIndicator').classList.remove('hidden');
                } else {
                    document.getElementById('approvalIndicator').classList.add('hidden');
                }
            } catch (e) {
                console.error('Balance fetch error:', e);
                document.getElementById('balanceFrom').textContent = '-';
            }
        }

        async function getQuote() {
            const amountIn = document.getElementById('amountIn').value;
            let tokenIn = getTokenAddress('tokenIn', 'customTokenIn');
            let tokenOut = getTokenAddress('tokenOut', 'customTokenOut');

            if (!amountIn || amountIn <= 0 || !tokenIn || !tokenOut || tokenIn.toLowerCase() === tokenOut.toLowerCase()) {
                document.getElementById('estimatedAmount').textContent = '0.0';
                document.getElementById('priceInfo').classList.add('hidden');
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                return;
            }

            try {
                document.getElementById('priceLoading').classList.remove('hidden');
                document.getElementById('priceInfo').classList.add('hidden');

                const tokenInAddr = tokenIn === '0x0000000000000000000000000000000000000000' ? WETH : tokenIn;
                const tokenOutAddr = tokenOut === '0x0000000000000000000000000000000000000000' ? WETH : tokenOut;

                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenInAddr}`);
                const data = await response.json();
                let price = 0;
                if (data && data.pairs && data.pairs.length > 0) price = parseFloat(data.pairs[0].priceUsd);

                const response2 = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenOutAddr}`);
                const data2 = await response2.json();
                let price2 = 0;
                if (data2 && data2.pairs && data2.pairs.length > 0) price2 = parseFloat(data2.pairs[0].priceUsd);

                if (price > 0 && price2 > 0) {
                    const estimated = (parseFloat(amountIn) * price) / price2;
                    const slippageMultiplier = (100 - slippageTolerance) / 100;
                    const minOut = estimated * slippageMultiplier;
                    
                    currentPriceUSD = price;
                    const usdIn = parseFloat(amountIn) * price;
                    const usdOut = estimated * price2;
                    document.getElementById('usdValueIn').textContent = `$${usdIn.toFixed(2)}`;
                    document.getElementById('usdValueOut').textContent = `$${usdOut.toFixed(2)}`;
                    
                    document.getElementById('estimatedAmount').textContent = estimated.toFixed(6);
                    document.getElementById('minAmountOut').value = minOut.toFixed(6);
                    
                    const tokenInName = getTokenSymbol(tokenIn);
                    const tokenOutName = getTokenSymbol(tokenOut);
                    const rate = (estimated / parseFloat(amountIn)).toFixed(6);
                    
                    document.getElementById('exchangeRate').textContent = `1 ${tokenInName} = ${rate} ${tokenOutName}`;
                    document.getElementById('minReceived').textContent = `${minOut.toFixed(6)} ${tokenOutName}`;
                    document.getElementById('priceInfo').classList.remove('hidden');
                } else {
                    document.getElementById('estimatedAmount').textContent = '0.0';
                    document.getElementById('usdValueIn').textContent = '$0.00';
                    document.getElementById('usdValueOut').textContent = '$0.00';
                }
                document.getElementById('priceLoading').classList.add('hidden');
            } catch (error) {
                console.error('Price fetch error:', error);
                document.getElementById('estimatedAmount').textContent = '~';
                document.getElementById('priceLoading').classList.add('hidden');
            }
        }

        // Setup custom token handlers for swap tab
        document.addEventListener('DOMContentLoaded', function() {
            setupCustomTokenHandler('tokenIn', 'customTokenInContainer', 'customTokenIn', 'customTokenInInfo', () => { getQuote(); if (isConnected) updateBalance(); });
            setupCustomTokenHandler('tokenOut', 'customTokenOutContainer', 'customTokenOut', 'customTokenOutInfo', getQuote);
        });

        // ============================================
        // TRENDING DATA FUNCTIONS (GeckoTerminal API)
        // ============================================
        async function loadTrendingData() {
            try {
                // GeckoTerminal trending pools endpoint
                const response = await fetch('https://api.geckoterminal.com/api/v2/networks/base/trending_pools');
                const data = await response.json();
                if (data && data.data) {
                    const pools = data.data.slice(0, 20);
                    renderTokenList('trendingList', pools.slice(0, 5), 'volume');
                    
                    // Gainers: filter positive 24h change, sort descending
                    const gainers = [...pools].filter(p => {
                        const change = parseFloat(p.attributes?.price_change_percentage?.h24 || 0);
                        return change > 0;
                    }).sort((a, b) => {
                        return parseFloat(b.attributes?.price_change_percentage?.h24 || 0) - parseFloat(a.attributes?.price_change_percentage?.h24 || 0);
                    }).slice(0, 5);
                    renderTokenList('gainersList', gainers, 'change');
                    
                    
                    
                    
                    
                    // New listings: sort by creation date
                    const newListings = [...pools].sort((a, b) => {
                        const aDate = new Date(a.attributes?.pool_created_at || 0).getTime();
                        const bDate = new Date(b.attributes?.pool_created_at || 0).getTime();
                        return bDate - aDate;
                    }).slice(0, 5);
                    renderTokenList('newListingsList', newListings, 'age');
                }
            } catch (error) { 
                console.error('Error loading trending:', error);
                document.getElementById('trendingList').innerHTML = '<div class="text-center py-4 text-secondary text-xs">Failed to load</div>';
            }
        }

        function renderTokenList(containerId, pools, displayType) {
            const container = document.getElementById(containerId);
            if (!container || !pools || pools.length === 0) { 
                if (container) container.innerHTML = '<div class="text-center py-4 text-secondary text-xs">No data</div>'; 
                return; 
            }
            container.innerHTML = pools.map(pool => {
                const attrs = pool.attributes || {};
                const name = attrs.name || 'Unknown';
                const symbol = name.split(' / ')[0] || '???';
                // Extract token address from relationships
                const tokenId = pool.relationships?.base_token?.data?.id || '';
                const address = tokenId.replace('base_', '');
                const price = attrs.base_token_price_usd ? '$' + parseFloat(attrs.base_token_price_usd).toFixed(6) : '-';
                const change = parseFloat(attrs.price_change_percentage?.h24 || 0);
                const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                const changeIcon = change >= 0 ? '‚Üë' : '‚Üì';
                const volume = attrs.volume_usd?.h24 ? '$' + formatNumber(parseFloat(attrs.volume_usd.h24)) : '-';
                const txns = (attrs.transactions?.h24?.buys || 0) + (attrs.transactions?.h24?.sells || 0);
                let secondaryInfo = '';
                if (displayType === 'volume') secondaryInfo = 'Vol: ' + volume;
                else if (displayType === 'change') secondaryInfo = '<span class="' + changeClass + '">' + changeIcon + ' ' + Math.abs(change).toFixed(2) + '%</span>';
                else if (displayType === 'txns') secondaryInfo = formatNumber(txns) + ' txns';
                else if (displayType === 'age') secondaryInfo = attrs.pool_created_at ? getTimeAgo(new Date(attrs.pool_created_at).getTime()) : 'Unknown';
               return '<div class="token-row flex items-center justify-between p-2 rounded-lg border border-transparent hover:border-orange-200" onclick="selectToken(\'' + address + '\', \'' + symbol + '\')">' +
    '<div class="flex items-center gap-2 flex-1 min-w-0">' +
    '<div class="min-w-0"><div class="font-bold text-sm text-primary truncate">' + symbol + '</div><div class="text-xs text-secondary truncate">' + name.slice(0, 20) + '</div></div></div>' +
    '<div class="text-right flex-shrink-0 ml-2"><div class="font-semibold text-xs text-primary">' + price + '</div><div class="text-xs">' + secondaryInfo + '</div></div></div>';
            }).join('');
        }

        function formatNumber(num) { if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'K'; return num.toFixed(0); }
        function getTimeAgo(timestamp) { const diff = Date.now() - timestamp; const hours = Math.floor(diff / (1000 * 60 * 60)); const days = Math.floor(hours / 24); if (days > 0) return days + 'd ago'; if (hours > 0) return hours + 'h ago'; return 'Just now'; }

        function selectToken(address, symbol) {
            if (!address) return;
            TOKENS[address.toLowerCase()] = symbol;
            const tokenOutSelect = document.getElementById('tokenOut');
            tokenOutSelect.value = 'custom';
            document.getElementById('customTokenOutContainer').classList.remove('hidden');
            document.getElementById('customTokenOut').value = address;
            document.getElementById('customTokenOut').dataset.validAddress = address;
            document.getElementById('customTokenOut').dataset.symbol = symbol;
            document.getElementById('customTokenOutInfo').innerHTML = '<div class="animate-fadeIn p-2 bg-green-50 border border-green-300 rounded-lg text-xs"><span class="text-green-600 font-bold">‚úì</span> <span class="font-bold">' + symbol + '</span></div>';
            document.getElementById('customTokenOut').classList.add('valid');
            getQuote();
            document.getElementById('scheduleContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Refresh trending data every 60 seconds
        setInterval(loadTrendingData, 60000);
    </script>

<script>
// Onboarding Modal Functions
let currentOnboardingScreen = 1;

function closeOnboarding() {
    document.getElementById('onboardingModal').classList.add('hidden');
    localStorage.setItem('mangoswapOnboardingComplete', 'true');
}

function nextOnboardingScreen() {
    const currentElement = document.querySelector('.onboarding-screen.active');
    currentElement.classList.remove('active');
    currentOnboardingScreen++;
    const nextElement = document.querySelector(`[data-screen="${currentOnboardingScreen}"]`);
    nextElement.classList.add('active');
}

window.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('mangoswapOnboardingComplete') === 'true') {
        document.getElementById('onboardingModal').classList.add('hidden');
    }
});
</script>
    
</body>
</html>
