<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoSwap - Automate Your Trades</title>
    <link rel="icon" type="image/png" href="mango-logo.png">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
<!-- Open Graph Meta Tags -->
  <meta property="og:title" content="MangoSwap" />
  <meta property="og:description" content="Automated trading on Base with limit orders and scheduled swaps" />
  <meta property="og:image" content="https://mangoswap.xyz/og-image.png" />
  <meta property="og:url" content="https://mangoswap.xyz" />
  <meta property="og:type" content="website" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MangoSwap" />
  <meta name="twitter:description" content="Automated trading on Base with limit orders and scheduled swaps" />
  <meta name="twitter:image" content="https://mangoswap.xyz/og-image.png" />
  <meta name="twitter:site" content="@YourTwitterHandle" />
  
  <!-- Existing Farcaster Frame metadata -->
  <meta property="fc:frame" content='{"version":"1","imageUrl":"https://mangoswap.xyz/preview.png","button":{"title":"Launch MangoSwap","action":{"type":"launch_frame","name":"MangoSwap","url":"https://mangoswap.xyz","splashImageUrl":"https://mangoswap.xyz/splash.png","splashBackgroundColor":"#f18435"}}}' />
</head>
    <style>
        /* Onboarding Modal Styles */
        .onboarding-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 99999; animation: fadeIn 0.3s ease-in; }
        .onboarding-overlay.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .onboarding-container { max-width: 340px; width: 85%; background: rgba(255, 140, 66, 0.95); backdrop-filter: blur(10px); border: 2px solid rgba(255, 107, 53, 0.3); border-radius: 20px; padding: 20px; position: relative; box-shadow: 0 20px 60px rgba(255, 107, 53, 0.3); }
        .onboarding-close-btn { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border: none; background: rgba(26, 26, 46, 0.15); border-radius: 50%; color: #1a1a2e; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10; }
        .onboarding-close-btn:hover { background: rgba(26, 26, 46, 0.3); color: #1a1a2e; transform: rotate(90deg); }
        .onboarding-logo { display: flex; justify-content: center; margin-bottom: 12px; }
        .onboarding-logo img { width: 64px; height: 64px; object-fit: contain; }
        .onboarding-screen { display: none; text-align: center; animation: slideIn 0.5s ease-in; color: #1a1a2e; }
        .onboarding-screen.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .onboarding-screen h1 { font-size: 28px; margin-bottom: 8px; font-weight: 700; }
        .onboarding-subtitle { font-size: 15px; color: rgba(26, 26, 46, 0.8); margin-bottom: 18px; line-height: 1.4; }
        .onboarding-feature { background: rgba(255, 255, 255, 0.5); border-radius: 12px; padding: 12px; margin-bottom: 10px; text-align: left; }
        .onboarding-feature-content { display: flex; align-items: flex-start; }
        .onboarding-number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); border-radius: 50%; font-weight: 700; font-size: 12px; margin-right: 10px; flex-shrink: 0; }
        .onboarding-feature h3 { font-size: 15px; margin-bottom: 4px; font-weight: 600; color: #1a1a2e; }
        .onboarding-feature p { font-size: 13px; color: rgba(26, 26, 46, 0.75); line-height: 1.3; }
        .onboarding-dots { display: flex; justify-content: center; gap: 6px; margin: 16px 0 12px; }
        .onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(26, 26, 46, 0.3); transition: all 0.3s ease; }
        .onboarding-dot.active { background: #1a1a2e; width: 24px; border-radius: 4px; }
        .onboarding-buttons { display: flex; gap: 12px; justify-content: center; }
        .onboarding-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .onboarding-btn-skip { background: rgba(255, 255, 255, 0.6); color: #1a1a2e; border: 2px solid rgba(26, 26, 46, 0.2); }
        .onboarding-btn-skip:hover { background: rgba(255, 255, 255, 0.9); color: #1a1a2e; border-color: rgba(26, 26, 46, 0.4); }
        .onboarding-btn-next { background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%); color: white; flex: 1; max-width: 160px; }
        .onboarding-btn-next:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4); }
        @media (max-width: 480px) {
            .onboarding-container { width: 90%; padding: 16px; }
            .onboarding-screen h1 { font-size: 24px; }
            .onboarding-logo img { width: 56px; height: 56px; }
        }
        
        /* Dark Mode Styles */
        body.dark-mode { background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%) !important; }
        body.dark-mode .bg-white { background-color: rgba(255, 255, 255, 0.95) !important; backdrop-filter: blur(10px); border: 2px solid rgba(255, 107, 53, 0.3); }
        body.dark-mode .text-gray-600, body.dark-mode .text-gray-700, body.dark-mode .text-gray-800 { color: #1a1a2e !important; }
        body.dark-mode .border-orange-300, body.dark-mode .border-orange-200 { border-color: rgba(255, 107, 53, 0.5) !important; }
        body.dark-mode .bg-gradient-to-br { background: rgba(255, 140, 66, 0.3) !important; }
        body.dark-mode #mainContent .bg-white { background-color: rgba(255, 255, 255, 0.9) !important; backdrop-filter: blur(10px); }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background-color: rgba(255, 255, 255, 0.6) !important; color: #1a1a2e !important; border-color: rgba(255, 107, 53, 0.4) !important; }
        body.dark-mode select option { color: #1a1a2e !important; background-color: rgba(255, 255, 255, 0.95) !important; }
        body.dark-mode input::placeholder { color: rgba(26, 26, 46, 0.5) !important; }
        body.dark-mode .bg-orange-100, body.dark-mode .bg-yellow-100 { background-color: rgba(255, 255, 255, 0.5) !important; }
        body.dark-mode .text-orange-700, body.dark-mode .text-orange-900 { color: #AA4D00 !important; }
        body.dark-mode label { color: #1a1a2e !important; font-weight: 600; }
        body.dark-mode #settingsModal > div, body.dark-mode #walletModal > div { background-color: rgba(255, 140, 66, 0.95) !important; backdrop-filter: blur(10px); border-color: rgba(255, 140, 66, 0.5) !important; }
        body.dark-mode #settingsModal h3, body.dark-mode #walletModal h3 { color: #1a1a2e !important; }
        body.dark-mode .shadow-lg { box-shadow: 0 20px 60px rgba(255, 107, 53, 0.3) !important; }
        body.dark-mode .shadow-md { box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2) !important; }
        
        /* Success Modal Animation */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #successModal > div {
            animation: slideUp 0.4s ease-out;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confettiFall 3s linear forwards;
        }
        
        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
<body class="bg-gradient-to-br from-orange-100 via-yellow-50 to-green-100 min-h-screen transition-colors duration-300">

    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingModal">
        <div class="onboarding-container">
            <button class="onboarding-close-btn" onclick="closeOnboarding()" title="Close">×</button>
            
            <div class="onboarding-logo">
                <img src="white-outline-mango.png" alt="MangoSwap">
            </div>

            <!-- Screen 1: Instant Swaps -->
            <div class="onboarding-screen active" data-screen="1">
                <h1>Welcome to MangoSwap</h1>
                <p class="onboarding-subtitle">Trade tokens on Base in seconds</p>
                
                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">1</span>
                        <div>
                            <h3>Select your tokens</h3>
                            <p>Choose what you want to swap (ETH, USDC, or any Base token)</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">2</span>
                        <div>
                            <h3>Enter amount</h3>
                            <p>Type how much you want to trade</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">3</span>
                        <div>
                            <h3>Swap instantly</h3>
                            <p>Your trade executes in seconds at the best price</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-dots">
                    <div class="onboarding-dot active"></div>
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot"></div>
                </div>

                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-skip" onclick="closeOnboarding()">Skip</button>
                    <button class="onboarding-btn onboarding-btn-next" onclick="nextOnboardingScreen()">Next →</button>
                </div>
            </div>

            <!-- Screen 2: Limit Orders -->
            <div class="onboarding-screen" data-screen="2">
                <h1>Set Your Price</h1>
                <p class="onboarding-subtitle">Buy or sell at exactly the price you want</p>
                
                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">1</span>
                        <div>
                            <h3>Choose your target price</h3>
                            <p>Set the exact price where you want to trade</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">2</span>
                        <div>
                            <h3>Create the order</h3>
                            <p>Your order waits until the market hits your price</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">3</span>
                        <div>
                            <h3>Automatic execution</h3>
                            <p>When the price matches, your trade happens automatically</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-dots">
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot active"></div>
                    <div class="onboarding-dot"></div>
                </div>

                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-skip" onclick="closeOnboarding()">Skip</button>
                    <button class="onboarding-btn onboarding-btn-next" onclick="nextOnboardingScreen()">Next →</button>
                </div>
            </div>

            <!-- Screen 3: Scheduled Swaps -->
            <div class="onboarding-screen" data-screen="3">
                <h1>Schedule Your Trades</h1>
                <p class="onboarding-subtitle">Buy automatically on a regular schedule</p>
                
                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">1</span>
                        <div>
                            <h3>Pick your schedule</h3>
                            <p>Choose daily, weekly, or monthly trades</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">2</span>
                        <div>
                            <h3>Set the amount</h3>
                            <p>Decide how much to invest each time</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-feature">
                    <div class="onboarding-feature-content">
                        <span class="onboarding-number">3</span>
                        <div>
                            <h3>Sit back and relax</h3>
                            <p>Your trades execute automatically—no need to watch the market</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-dots">
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot"></div>
                    <div class="onboarding-dot active"></div>
                </div>

                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-next" style="max-width: 100%;" onclick="closeOnboarding()">Get Started 🥭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End Onboarding Modal -->

    <div class="container mx-auto px-4 py-4 max-w-3xl">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4 border-2 border-orange-300 transition-colors duration-300">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-1">
                        <img src="mango-logo.png" alt="MangoSwap" class="w-10 h-10 inline-block"> 
                        <span class="bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 bg-clip-text text-transparent">MangoSwap</span>
                    </h1>
                    <p class="text-gray-600 text-sm font-medium">Sweet Swaps on Base ⛽ <span class="bg-green-500 text-white px-2 py-0.5 rounded-full text-xs font-bold">GAS FREE</span></p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="themeToggle" class="bg-gradient-to-r from-orange-400 to-yellow-400 hover:from-orange-500 hover:to-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105" title="Toggle Dark Mode">
                        <span id="themeIcon">🌙</span>
                    </button>
                    <button id="connectBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white px-5 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105">Connect Wallet</button>
                </div>
                
                <!-- Slippage Settings Modal -->
                <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 border-4 border-orange-300 transition-colors duration-300">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">📊 Slippage Settings</h3>
                        <div class="mb-6 p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl border-2 border-orange-200">
                            <label class="block text-sm font-bold text-orange-900 mb-3">Slippage Tolerance</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="0.5">0.5%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="1">1%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition bg-orange-500 text-white border-2 border-orange-500" data-value="5">5%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="10">10%</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="customSlippage" placeholder="Custom" step="0.1" min="0" max="50" class="flex-1 px-3 py-2 border-2 border-orange-200 rounded-lg font-semibold text-center">
                                <span class="font-bold text-orange-900">%</span>
                            </div>
                            <p class="text-xs text-orange-700 mt-2">⚠️ High slippage may result in unfavorable rates</p>
                        </div>
                        <button id="closeSettings" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition">
                            Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- Wallet Modal -->
                <div id="walletModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 border-4 border-orange-300 transition-colors duration-300">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Connect Wallet</h3>
                        <div class="space-y-3">
                            <button id="connectMetaMask" class="w-full bg-gradient-to-r from-orange-400 to-yellow-400 hover:from-orange-500 hover:to-yellow-500 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                🦊 MetaMask
                            </button>
                            <button id="connectCoinbase" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                🔵 Base Wallet
                            </button>
                            <button id="connectPhantom" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                👻 Phantom
                            </button>
                        </div>
                        <button id="closeModal" class="mt-4 w-full text-gray-600 hover:text-gray-800 font-semibold">Cancel</button>
                    </div>
                </div>
                
                <!-- Success Modal -->
                <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 border-4 border-green-300 transition-colors duration-300 relative overflow-hidden">
                        <!-- Confetti animation -->
                        <div class="absolute inset-0 pointer-events-none" id="confettiContainer"></div>
                        
                        <div class="text-center relative z-10">
                            <div class="text-6xl mb-4 animate-bounce">🎉</div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Swap Successful!</h3>
                            <p class="text-gray-600 mb-4" id="successMessage">Your swap has been completed</p>
                            
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border-2 border-green-200">
                                <div class="text-sm text-gray-600 mb-1">You received</div>
                                <div class="text-2xl font-bold text-green-600" id="successAmount">-</div>
                            </div>
                            
                            <a id="basescanLink" href="#" target="_blank" rel="noopener noreferrer" class="block w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition mb-3">
                                View on Basescan 🔍
                            </a>
                            
                            <button id="closeSuccessModal" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition">
                                Done 🥭
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="accountInfo" class="hidden text-right">
                    <div class="text-xs text-gray-600">Connected</div>
                    <div id="accountAddress" class="font-mono text-xs bg-orange-100 px-2 py-1 rounded border border-orange-300"></div>
                </div>
            </div>
        </div>

        <div id="mainContent">
            <div class="bg-white rounded-xl shadow-xl overflow-hidden border-2 border-orange-300 transition-colors duration-300">
                <div class="flex border-b-2 border-orange-200">
    <button id="scheduleTab" class="flex-1 px-3 py-2 font-bold bg-gradient-to-r from-orange-500 to-yellow-500 text-white text-xs sm:text-sm">Swap</button>
    <button id="limitTab" class="flex-1 px-3 py-2 font-bold text-gray-600 hover:bg-orange-50 transition text-xs sm:text-sm">Limit Order</button>
    <button id="swapsTab" class="flex-1 px-3 py-2 font-bold text-gray-600 hover:bg-orange-50 transition text-xs sm:text-sm">My Orders</button>
</div>

                <div id="scheduleContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 transition-colors duration-300">
                    <div class="max-w-md mx-auto space-y-3">
                        <div class="bg-white border-2 border-orange-300 rounded-xl p-3 shadow-md transition-colors duration-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-orange-700">From</label>
                                <div class="text-right" id="balanceSection" style="display:none;">
                                    <div class="text-xs text-gray-600">Balance: <span id="balanceFrom" class="font-semibold">-</span></div>
                                    <button id="maxBtn" class="text-xs bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold px-2 py-0.5 rounded transition">MAX</button>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <input type="number" step="0.001" id="amountIn" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none text-gray-800">
                                    <div id="usdValueIn" class="text-xs text-gray-500 mt-1">$0.00</div>
                                </div>
                                <select id="tokenIn" class="bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-orange-300 rounded-lg px-3 py-2 font-bold hover:border-orange-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[120px]">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <input type="text" id="customTokenIn" placeholder="Paste token address (0x...)" class="hidden w-full mt-2 px-2 py-1 border border-orange-200 rounded text-xs">
                        </div>

                        <div class="flex justify-center -my-1 relative z-10">
                            <button id="swapArrow" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white rounded-lg p-2 shadow-lg transition transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="bg-white border-2 border-green-300 rounded-xl p-3 shadow-md transition-colors duration-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-green-700">To (estimated)</label>
                                <div id="priceLoading" class="hidden text-xs text-orange-600 font-semibold">Fetching...</div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <div class="text-2xl font-bold text-gray-800" id="estimatedAmount">0.0</div>
                                    <div id="usdValueOut" class="text-xs text-gray-500 mt-1">$0.00</div>
                                </div>
                                <input type="number" step="0.001" id="minAmountOut" placeholder="0.0" class="hidden">
                                <select id="tokenOut" class="bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold hover:border-green-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[120px]">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <input type="text" id="customTokenOut" placeholder="Paste token address (0x...)" class="hidden w-full mt-2 px-2 py-1 border border-green-200 rounded text-xs">
                            <div id="priceInfo" class="mt-2 space-y-1 text-xs hidden bg-green-50 p-2 rounded border border-green-200">
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Rate:</span>
                                    <span id="exchangeRate" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Min (<span id="slippageDisplay">5</span>% slippage) <button id="editSlippageBtn" class="text-orange-600 hover:text-orange-700">⚙️</button>:</span>
                                    <span id="minReceived" class="font-bold">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3 shadow-md transition-colors duration-300">
                            <h3 class="font-bold text-orange-800 mb-2 text-sm">⏰ Execution Time</h3>
                            <div class="space-y-2 mb-2">
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg hover:bg-yellow-50 transition border border-yellow-200">
                                    <input type="radio" name="timeOption" value="now" id="timeNow" checked class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Swap Now ⚡</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg hover:bg-yellow-50 transition border border-yellow-200">
                                    <input type="radio" name="timeOption" value="scheduled" id="timeScheduled" class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Schedule for Later 📅</span>
                                </label>
                            </div>
                            <div id="scheduledTimeInputs" class="grid grid-cols-2 gap-2 hidden">
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">Date</label>
                                    <input type="date" id="executionDate" class="w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm font-semibold">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">Time</label>
                                    <input type="time" id="executionTime" class="w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm font-semibold">
                                </div>
                            </div>
                            <p id="instantTimeNote" class="text-xs text-orange-800 mt-2">✨ Swap executes immediately</p>
                            <p id="scheduledTimeNote" class="text-xs text-orange-800 mt-2 hidden">📅 Swap will execute at the time you select (your local timezone)</p>
                        </div>

                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg p-3 border border-green-300 transition-colors duration-300">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-800 font-semibold">Platform Fee</span>
                                <span class="font-bold text-green-900">0.5%</span>
                            </div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-800 font-semibold">Network Fee</span>
                                <span class="font-bold text-green-900">~0.3%</span>
                            </div>
                            <div class="flex justify-between text-xs pt-1 border-t border-green-300">
                                <span class="font-bold text-green-900">Total Fee</span>
                                <span class="font-bold text-orange-600">~0.8%</span>
                            </div>
                        </div>

                        <button id="scheduleSwapBtn" class="w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 hover:from-orange-600 hover:via-yellow-600 hover:to-green-600 text-white font-black py-3 rounded-xl transition shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btnText">🔗 Connect Wallet to Swap</span>
                        </button>
                    </div>
                </div>

                <div id="swapsContent" class="p-4 hidden transition-colors duration-300">
                    <!-- Stats Bar on My Swaps Page -->
                    <div class="flex justify-end gap-3 mb-4 text-xs flex-wrap">
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-orange-200">
                            <span class="text-gray-600">Total Swaps:</span>
                            <span id="totalSwaps" class="font-bold text-orange-600 ml-1">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-indigo-200">
                            <span class="text-gray-600">Limit Orders:</span>
                            <span id="totalLimitOrders" class="font-bold text-indigo-600 ml-1">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-yellow-200">
                            <span class="text-gray-600">Scheduled:</span>
                            <span id="scheduledCount" class="font-bold text-yellow-600 ml-1">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-green-200">
                            <span class="text-gray-600">Executed:</span>
                            <span id="executedCount" class="font-bold text-green-600 ml-1">0</span>
                        </div>
                        <div id="ownerStats" class="bg-white rounded-lg shadow px-3 py-1 border border-emerald-200 hidden">
                            <button id="withdrawBtn" class="text-xs bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-2 py-1 rounded font-bold transition" style="display:none;">💰 Withdraw</button>
                        </div>
                    </div>
                    
                    <div id="swapsList"></div>
                </div>
                <!-- LIMIT ORDER TAB -->
<div id="limitContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 transition-colors duration-300 hidden">
    <div class="max-w-md mx-auto space-y-3">
        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-300 rounded-xl p-3 mb-3">
            <div class="flex items-center gap-2">
                <span class="text-2xl">🎯</span>
                <div>
                    <h3 class="font-bold text-orange-900 text-sm">Limit Order</h3>
                    <p class="text-xs text-orange-700">Set your target price, execute automatically</p>
                </div>
            </div>
        </div>

        <div class="bg-white border-2 border-orange-300 rounded-xl p-3 shadow-md">
            <label class="text-xs font-bold text-orange-700 mb-2 block">You Pay</label>
            <div class="flex flex-col gap-2">
                <input type="number" step="0.001" id="amountInLimit" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none">
                <select id="tokenInLimit" class="w-full bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-orange-300 rounded-lg px-3 py-2 font-bold">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                </select>
            </div>
        </div>

        <div class="flex justify-center -my-1 relative z-10">
            <button id="swapArrowLimit" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white rounded-lg p-2 shadow-lg transition transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                </svg>
            </button>
        </div>

        <div class="bg-white border-2 border-green-300 rounded-xl p-3 shadow-md">
            <label class="text-xs font-bold text-green-700 mb-2 block">You Receive</label>
            <select id="tokenOutLimit" class="w-full bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
            </select>
        </div>

        <!-- Current Market Price Display -->
        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-blue-800">📊 Current Market Price</span>
                <button id="refreshPriceBtn" class="text-blue-600 hover:text-blue-800 transition text-xs">🔄</button>
            </div>
            <div id="currentMarketPrice" class="text-center">
                <div class="text-xs text-blue-600 mb-1">
                    1 <span id="marketTokenIn">ETH</span> =
                </div>
                <div class="text-2xl font-bold text-blue-900" id="marketPriceValue">Loading...</div>
                <div class="text-xs text-blue-600">
                    <span id="marketTokenOut">USDC</span>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3">
            <h3 class="font-bold text-orange-800 mb-2 text-sm">🎯 Target Price</h3>
            <div class="flex items-center gap-1 sm:gap-2 mb-2 flex-wrap sm:flex-nowrap">
                <span class="text-xs font-semibold text-orange-700 whitespace-nowrap">When 1</span>
                <span id="targetTokenIn" class="text-xs font-bold text-orange-900 whitespace-nowrap">ETH</span>
                <span class="text-xs font-semibold text-orange-700">=</span>
                <input type="number" step="0.000001" id="targetPrice" placeholder="0.0" class="w-24 sm:w-32 px-2 sm:px-3 py-2 border-2 border-yellow-200 rounded-lg font-bold text-center text-sm sm:text-base">
                <span id="targetTokenOut" class="text-xs font-bold text-orange-900 whitespace-nowrap">USDC</span>
            </div>
            
            <!-- Your Order Rate Display -->
            <div id="orderRateInfo" class="bg-white border-2 border-orange-200 rounded-lg p-2 mb-2 hidden">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold text-gray-700">Your Order Rate:</span>
                    <span class="text-xs font-bold text-orange-900" id="orderRateValue">-</span>
                </div>
                <div id="priceDifference" class="text-xs text-center mt-1 font-semibold">-</div>
            </div>
            
            <p class="text-xs text-orange-700 bg-yellow-100 p-2 rounded mb-2">💡 Order executes automatically when market reaches your target price</p>
            
            <!-- Expiration Options -->
            <div class="mt-3">
                <label class="text-xs font-bold text-orange-800 mb-2 block">⏰ Order Expiration</label>
                <select id="expirationSelect" class="w-full bg-white border-2 border-yellow-200 rounded-lg px-3 py-2 text-sm font-semibold">
                    <option value="0">Never (Good til Cancelled)</option>
                    <option value="600">10 Minutes</option>
                    <option value="3600">1 Hour</option>
                    <option value="86400">1 Day</option>
                    <option value="259200">3 Days</option>
                    <option value="604800">7 Days</option>
                    <option value="custom">Custom...</option>
                </select>
                <div id="customExpirationInput" class="mt-2 hidden">
                    <label class="text-xs text-orange-700 block mb-1">Custom Expiration (hours):</label>
                    <input type="number" id="customExpirationHours" min="1" max="720" placeholder="Hours" class="w-full px-3 py-2 border-2 border-yellow-200 rounded-lg text-sm">
                </div>
                <div id="expirationPreview" class="text-xs text-orange-600 mt-1 hidden"></div>
            </div>
        </div>

        <button id="createLimitBtn" class="w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-orange-500 hover:from-orange-600 hover:via-yellow-600 hover:to-orange-600 text-white font-black py-3 rounded-xl transition shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="limitBtnText">🔗 Connect Wallet</span>
        </button>
    </div>
</div>
            </div>
        </div>

        <!-- Security Info Banner -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-md p-3 mt-6 border-2 border-green-300">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">🔒</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Smart Contract V4</div>
                            <a href="https://basescan.org/address/0xb81fea65B45D743AB62a1A2B351f4f92fb1d4D16" target="_blank" rel="noopener noreferrer" class="font-mono text-xs text-green-700 hover:text-green-900 hover:underline">
                                0xb81f...4D16
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">✅</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Verified Contract</div>
                            <div class="text-xs text-green-700">View on Basescan</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">📊</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Total Swaps</div>
                            <div class="text-xs text-green-700" id="totalSwapsHeader">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0xb81fea65B45D743AB62a1A2B351f4f92fb1d4D16'; // MangoSwap V4 - NEW CONTRACT
        const BASE_CHAIN_ID = '0x2105';
        
        // Updated ABI for MangoSwap V4
        const ABI = [
            "function instantSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut) external payable returns (uint256)",
            "function scheduleSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minOut, uint256 time) external payable returns (uint256)",
            "function createLimitOrder(address tokenIn, address tokenOut, uint256 amountIn, uint256 price, uint256 expiry) external payable returns (uint256)",
            "function executeScheduledSwap(uint256 swapId) external",
            "function executeLimitOrder(uint256 orderId) external",
            "function cancelSwap(uint256 swapId) external",
            "function cancelLimitOrder(uint256 orderId) external",
            "function getSwap(uint256 id) external view returns (tuple(address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut, uint256 executionTime, uint8 status, uint256 amountOut))",
            "function getLimitOrder(uint256 id) external view returns (tuple(address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 targetPrice, uint256 expiryTime, uint8 status, uint256 amountOut))",
            "function getUserSwaps(address user) external view returns (uint256[])",
            "function getUserLimitOrders(address user) external view returns (uint256[])",
            "function getTotalSwaps() external view returns (uint256)",
            "function getTotalLimitOrders() external view returns (uint256)",
            "function updatePlatformFee(uint256 newFee) external",
            "function withdrawFees() external",
            "function owner() external view returns (address)",
            "function platformFee() external view returns (uint256)"
        ];

        const TOKENS = {'0x0000000000000000000000000000000000000000':'ETH','0x4200000000000000000000000000000000000006':'WETH','0x833589fcd6edb6e08f4c7c32d4f71b54bda02913':'USDC','0x50c5725949a6f0c72e6c4a641f24049a917db0cb':'DAI','0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf':'cbBTC','0x532f27101965dd16442e59d40670faf5ebb142e4':'BRETT','0x940181a94a35a4569e4529a3cdfb74e38fd98631':'AERO','0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4':'TOSHI','0x4ed4e862860bed51a9570b96d89af5e1b0efefed':'DEGEN','0xa88594d404727625a9437c3f886c7643872296ae':'WELL','0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b':'VIRTUAL','0x78a087d713be963bf307b18f2ff8122ef9a63ae9':'ZORA','0x58d97b57bb95320f9a05dc918aef65434969c2b2':'MORPHO','0x22af33fe49fd1fa80c7149773dde5890d3c76f3b':'BANKR','0xb1a03eda10342529bbf8eb700a06c60441fef25d':'MIGGLES'};

        const WETH = '0x4200000000000000000000000000000000000006';
        let provider, signer, contract, account, isOwner = false;
        let quoteTimeout;
        let selectedWallet = null;
        let isConnected = false;
        
        // Settings state
        let slippageTolerance = 5;
        let userBalanceFrom = 0;
        let currentPriceUSD = 0;
        let currentMarketPriceValue = 0;

        // ERC20 ABI for balance and approval
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) returns (bool)"
        ];

        // Load saved settings
        function loadSettings() {
            const savedSlippage = localStorage.getItem('mangoswap_slippage') || '5';
            slippageTolerance = parseFloat(savedSlippage);
            updateSlippageUI();
        }

        // Update slippage UI
        function updateSlippageUI() {
            document.querySelectorAll('.slippage-btn').forEach(btn => {
                const value = parseFloat(btn.dataset.value);
                if (value === slippageTolerance) {
                    btn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.remove('border-orange-200');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.add('border-orange-200');
                }
            });
            document.getElementById('slippageDisplay').textContent = slippageTolerance;
            localStorage.setItem('mangoswap_slippage', slippageTolerance.toString());
        }

        // Initialize settings
        loadSettings();
        
        // Disable button initially
        document.getElementById('scheduleSwapBtn').disabled = true;
        document.getElementById('createLimitBtn').disabled = true;

        // Function to update all button states when wallet connects/disconnects
        function updateButtonStates() {
            if (isConnected) {
                document.getElementById('scheduleSwapBtn').disabled = false;
                document.getElementById('btnText').textContent = '🥭 Swap Now 🌴';
                document.getElementById('createLimitBtn').disabled = false;
                document.getElementById('limitBtnText').textContent = '🎯 Create Limit Order';
            } else {
                document.getElementById('scheduleSwapBtn').disabled = true;
                document.getElementById('btnText').textContent = '🔗 Connect Wallet to Swap';
                document.getElementById('createLimitBtn').disabled = true;
                document.getElementById('limitBtnText').textContent = '🔗 Connect Wallet';
            }
        }

        // Function to update target price labels
        function updateTargetPriceLabels() {
            const tokenInLimit = document.getElementById('tokenInLimit').value;
            const tokenOutLimit = document.getElementById('tokenOutLimit').value;
            
            const tokenInName = TOKENS[tokenInLimit.toLowerCase()] || 'Token';
            const tokenOutName = TOKENS[tokenOutLimit.toLowerCase()] || 'Token';
            
            document.getElementById('targetTokenIn').textContent = tokenInName;
            document.getElementById('targetTokenOut').textContent = tokenOutName;
            document.getElementById('marketTokenIn').textContent = tokenInName;
            document.getElementById('marketTokenOut').textContent = tokenOutName;
        }

        // Edit slippage button
        document.getElementById('editSlippageBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('hidden');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        // Slippage buttons
        document.querySelectorAll('.slippage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                slippageTolerance = parseFloat(btn.dataset.value);
                updateSlippageUI();
                getQuote();
            });
        });

        // Custom slippage input
        document.getElementById('customSlippage').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value && value > 0 && value <= 50) {
                slippageTolerance = value;
                updateSlippageUI();
                getQuote();
            }
        });

        document.getElementById('connectBtn').addEventListener('click', showWalletModal);
        document.getElementById('closeModal').addEventListener('click', hideWalletModal);
        document.getElementById('connectMetaMask').addEventListener('click', () => connectWallet('metamask'));
        document.getElementById('connectCoinbase').addEventListener('click', () => connectWallet('coinbase'));
        document.getElementById('connectPhantom').addEventListener('click', () => connectWallet('phantom'));
        document.getElementById('scheduleTab').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('swapsTab').addEventListener('click', () => switchTab('swaps'));
        document.getElementById('limitTab').addEventListener('click', () => switchTab('limit'));
        document.getElementById('createLimitBtn').addEventListener('click', createLimitOrder);
        document.getElementById('scheduleSwapBtn').addEventListener('click', scheduleSwap);
        
        // Update target price labels when limit order tokens change
        document.getElementById('tokenInLimit').addEventListener('change', () => {
            updateTargetPriceLabels();
            updateMarketPrice();
        });
        document.getElementById('tokenOutLimit').addEventListener('change', () => {
            updateTargetPriceLabels();
            updateMarketPrice();
        });
        
        document.getElementById('amountIn').addEventListener('input', debounceQuote);
        document.getElementById('tokenIn').addEventListener('change', () => {
            getQuote();
            if (isConnected) updateBalance();
        });
        document.getElementById('tokenOut').addEventListener('change', getQuote);
        
        document.getElementById('maxBtn').addEventListener('click', () => {
            if (!isConnected) {
                alert('Please connect your wallet first');
                return;
            }
            document.getElementById('amountIn').value = userBalanceFrom;
            getQuote();
        });
        
        document.getElementById('swapArrow').addEventListener('click', function() {
            const tokenInSelect = document.getElementById('tokenIn');
            const tokenOutSelect = document.getElementById('tokenOut');
            const tempValue = tokenInSelect.value;
            tokenInSelect.value = tokenOutSelect.value;
            tokenOutSelect.value = tempValue;
            getQuote();
        });
        
        // Swap arrow for limit order page
        document.getElementById('swapArrowLimit').addEventListener('click', function() {
            const tokenInSelect = document.getElementById('tokenInLimit');
            const tokenOutSelect = document.getElementById('tokenOutLimit');
            const tempValue = tokenInSelect.value;
            tokenInSelect.value = tokenOutSelect.value;
            tokenOutSelect.value = tempValue;
            updateTargetPriceLabels();
            updateMarketPrice();
        });
        
        document.getElementById('tokenIn').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customTokenIn').classList.remove('hidden');
            } else {
                document.getElementById('customTokenIn').classList.add('hidden');
            }
        });
        
        document.getElementById('tokenOut').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customTokenOut').classList.remove('hidden');
            } else {
                document.getElementById('customTokenOut').classList.add('hidden');
            }
        });
        
        document.getElementById('timeNow').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.add('hidden');
                document.getElementById('scheduledTimeNote').classList.add('hidden');
                document.getElementById('instantTimeNote').classList.remove('hidden');
                updateButtonStates();
            }
        });
        
        document.getElementById('timeScheduled').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.remove('hidden');
                document.getElementById('scheduledTimeNote').classList.remove('hidden');
                document.getElementById('instantTimeNote').classList.add('hidden');
                if (isConnected) {
                    document.getElementById('btnText').textContent = '📅 Schedule Swap';
                }
            }
        });

        function showWalletModal() {
            document.getElementById('walletModal').classList.remove('hidden');
        }

        function hideWalletModal() {
            document.getElementById('walletModal').classList.add('hidden');
        }
        
        function showSuccessModal(txHash, amountOut, tokenOutSymbol) {
            // Show modal
            document.getElementById('successModal').classList.remove('hidden');
            
            // Set content
            document.getElementById('successAmount').textContent = `${parseFloat(amountOut).toFixed(6)} ${tokenOutSymbol}`;
            document.getElementById('basescanLink').href = `https://basescan.org/tx/${txHash}`;
            
            // Create confetti
            createConfetti();
        }
        
        function hideSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }
        
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            container.innerHTML = ''; // Clear previous confetti
            
            const colors = ['#ff6b35', '#f7931e', '#fdc830', '#37b34a', '#4facfe', '#a78bfa'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
            
            // Remove confetti after animation
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
        
        document.getElementById('closeSuccessModal').addEventListener('click', hideSuccessModal);

        async function connectWallet(walletType) {
            console.log('Attempting to connect:', walletType);
            selectedWallet = walletType;
            hideWalletModal();

            let ethereum;
            
            if (walletType === 'phantom') {
                if (window.phantom?.ethereum) {
                    ethereum = window.phantom.ethereum;
                } else {
                    alert('Phantom wallet not installed! Visit phantom.app to install.');
                    return;
                }
            } else if (walletType === 'coinbase') {
                if (window.ethereum?.isCoinbaseWallet) {
                    ethereum = window.ethereum;
                } else {
                    alert('Base Wallet not detected! Please install it from wallet.coinbase.com');
                    return;
                }
            } else {
                if (!window.ethereum) {
                    alert('No wallet detected! Please install MetaMask from metamask.io');
                    return;
                }
                ethereum = window.ethereum;
            }

            if (!ethereum) {
                alert('Wallet provider not found!');
                return;
            }
            
            try {
                console.log('Requesting accounts...');
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                console.log('Accounts received:', accounts);
                
                console.log('Checking chain ID...');
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId, 'Expected:', BASE_CHAIN_ID);
                
                if (chainId !== BASE_CHAIN_ID) {
                    console.log('Wrong network, switching to Base...');
                    try {
                        await ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        console.log('Switch error:', switchError);
                        if (switchError.code === 4902) {
                            console.log('Network not added, adding Base network...');
                            await ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                account = accounts[0];
                console.log('Connected account:', account);
                
                provider = new ethers.providers.Web3Provider(ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                isConnected = true;
                
                console.log('Provider initialized');
                
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('accountInfo').classList.remove('hidden');
                document.getElementById('accountAddress').textContent = account.slice(0, 6) + '...' + account.slice(-4);
                document.getElementById('balanceSection').style.display = 'block';
                
                // Update all button states
                updateButtonStates();
                
                console.log('Checking if owner...');
                const owner = await contract.owner();
                isOwner = owner.toLowerCase() === account.toLowerCase();
                if (isOwner) {
                    document.getElementById('ownerStats').classList.remove('hidden');
                    document.getElementById('withdrawBtn').style.display = 'block';
                }
                
                console.log('Loading data...');
                loadData();
                updateBalance();
                console.log('Connection complete!');
            } catch (e) {
                console.error('Connection error details:', e);
                alert('Failed to connect: ' + e.message + '\n\nCheck browser console (F12) for details.');
            }
        }

        async function loadData() {
            try {
                const total = await contract.getTotalSwaps();
                const totalOrders = await contract.getTotalLimitOrders();
                
                document.getElementById('totalSwaps').textContent = total.toString();
                document.getElementById('totalLimitOrders').textContent = totalOrders.toString();
                document.getElementById('totalSwapsHeader').textContent = total.toString() + ' completed';
                
                const ids = await contract.getUserSwaps(account);
                const swaps = await Promise.all(ids.map(async id => {
                    const s = await contract.getSwap(id);
                    return {
                        id: id.toString(),
                        user: s[0],
                        tokenIn: s[1],
                        tokenOut: s[2],
                        amountIn: ethers.utils.formatEther(s[3]),
                        minAmountOut: ethers.utils.formatEther(s[4]),
                        executionTime: new Date(s[5].toNumber() * 1000),
                        status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][s[6]],
                        amountOut: ethers.utils.formatEther(s[7]),
                        type: 'swap'
                    };
                }));
                
                const limitIds = await contract.getUserLimitOrders(account);
                const limitOrders = await Promise.all(limitIds.map(async id => {
                    const lo = await contract.getLimitOrder(id);
                    return {
                        id: id.toString(),
                        user: lo[0],
                        tokenIn: lo[1],
                        tokenOut: lo[2],
                        amountIn: ethers.utils.formatEther(lo[3]),
                        targetPrice: ethers.utils.formatEther(lo[4]),
                        expiryTime: lo[5].toNumber() === 0 ? 0 : new Date(lo[5].toNumber() * 1000),
                        status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][lo[6]],
                        amountOut: ethers.utils.formatEther(lo[7]),
                        type: 'limit'
                    };
                }));

                const allOrders = [...swaps, ...limitOrders].sort((a, b) => {
                    const timeA = a.type === 'swap' ? a.executionTime : (a.expiryTime || new Date());
                    const timeB = b.type === 'swap' ? b.executionTime : (b.expiryTime || new Date());
                    return timeB - timeA;
                });

                const scheduled = swaps.filter(s => s.status === 'Scheduled').length + 
                                limitOrders.filter(lo => lo.status === 'Scheduled').length;
                const executed = swaps.filter(s => s.status === 'Executed').length + 
                                limitOrders.filter(lo => lo.status === 'Executed').length;
                
                document.getElementById('scheduledCount').textContent = scheduled;
                document.getElementById('executedCount').textContent = executed;
                displaySwaps(allOrders);
            } catch (e) {
                console.error('Load data error:', e);
            }
        }

        function displaySwaps(orders) {
            const list = document.getElementById('swapsList');
            if (orders.length === 0) {
                list.innerHTML = '<div class="text-center py-12 text-gray-500"><p>No orders yet! 🥭</p><p class="text-sm mt-2">Create your first swap or limit order to get started</p></div>';
                return;
            }
            list.innerHTML = orders.map(s => {
                const tokenInName = TOKENS[s.tokenIn.toLowerCase()] || s.tokenIn.slice(0, 6) + '...';
                const tokenOutName = TOKENS[s.tokenOut.toLowerCase()] || s.tokenOut.slice(0, 6) + '...';
                
                if (s.type === 'limit') {
                    const statusColor = s.status === 'Scheduled' ? 'indigo' : s.status === 'Executed' ? 'green' : 'gray';
                    const expiryText = s.expiryTime === 0 ? 'Never expires' : `Expires: ${s.expiryTime.toLocaleString()}`;
                    
                    return `
                    <div class="border-2 border-${statusColor}-200 rounded-xl p-4 mb-3 bg-gradient-to-r from-${statusColor}-50 to-purple-50 shadow-lg">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-800">🎯 ${s.status} Limit Order</span>
                            <div class="text-right">
                                <div class="font-bold text-lg">${parseFloat(s.amountIn).toFixed(4)} ${tokenInName} → ${tokenOutName}</div>
                                <div class="text-sm text-${statusColor}-700">Target: ${parseFloat(s.targetPrice).toFixed(6)} ${tokenOutName}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">${expiryText}</div>
                        ${s.status === 'Executed' ? `<div class="text-xs text-green-700 font-semibold mb-2">✅ Received: ${parseFloat(s.amountOut).toFixed(6)} ${tokenOutName}</div>` : ''}
                        ${s.status === 'Scheduled' ? `<button onclick="cancelLimitOrder(${s.id})" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition text-sm">Cancel Order</button>` : ''}
                    </div>
                    `;
                }
                
                const statusColor = s.status === 'Scheduled' ? 'yellow' : s.status === 'Executed' ? 'green' : 'gray';
                
                return `
                <div class="border-2 border-${statusColor}-200 rounded-xl p-4 mb-3 bg-white shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-800">${s.status} Swap</span>
                        <div class="text-right">
                            <div class="font-bold text-lg">${parseFloat(s.amountIn).toFixed(4)} ${tokenInName} → ${tokenOutName}</div>
                            <div class="text-sm text-gray-600">Min: ${parseFloat(s.minAmountOut).toFixed(6)} ${tokenOutName}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">Executes: ${s.executionTime.toLocaleString()}</div>
                    ${s.status === 'Executed' ? `<div class="text-xs text-green-700 font-semibold mb-2">✅ Received: ${parseFloat(s.amountOut).toFixed(6)} ${tokenOutName}</div>` : ''}
                    ${s.status === 'Scheduled' ? `<button onclick="cancelSwap(${s.id})" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition text-sm">Cancel Swap</button>` : ''}
                </div>
            `;
            }).join('');
        }

        async function scheduleSwap() {
            if (!isConnected) {
                alert('Please connect your wallet first');
                showWalletModal();
                return;
            }
            
            let tokenIn = document.getElementById('tokenIn').value;
            let tokenOut = document.getElementById('tokenOut').value;
            
            if (tokenIn === 'custom') {
                tokenIn = document.getElementById('customTokenIn').value.trim();
                if (!tokenIn || !tokenIn.startsWith('0x') || tokenIn.length !== 42) {
                    alert('Invalid token address for From Token');
                    return;
                }
            }
            
            if (tokenOut === 'custom') {
                tokenOut = document.getElementById('customTokenOut').value.trim();
                if (!tokenOut || !tokenOut.startsWith('0x') || tokenOut.length !== 42) {
                    alert('Invalid token address for To Token');
                    return;
                }
            }
            
            const amount = document.getElementById('amountIn').value;
            const minOut = document.getElementById('minAmountOut').value;
            
            if (!amount || !minOut) {
                alert('Fill all fields');
                return;
            }
            
            if (parseFloat(amount) > userBalanceFrom && tokenIn !== 'custom') {
                alert(`Insufficient balance. You have ${userBalanceFrom.toFixed(4)} tokens.`);
                return;
            }
            
            if (tokenIn === tokenOut) {
                alert('Select different tokens');
                return;
            }
            
            const isInstant = document.getElementById('timeNow').checked;
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                const minOutWei = ethers.utils.parseEther(minOut);
                
                if (isInstant) {
                    console.log('Executing instant swap...');
                    
                    document.getElementById('btnText').textContent = 'Swapping... ⏳';
                    document.getElementById('scheduleSwapBtn').disabled = true;
                    
                    if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                        console.log('Approving token...');
                        const tokenContract = new ethers.Contract(
                            tokenIn,
                            ['function approve(address spender, uint256 amount) external returns (bool)'],
                            signer
                        );
                        
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                        document.getElementById('btnText').textContent = 'Approving... ⏳';
                        await approveTx.wait();
                        console.log('Token approved');
                    }
                    
                    document.getElementById('btnText').textContent = 'Swapping... ⏳';
                    
                    const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                        await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, { 
                            value: amountWei,
                            gasLimit: 500000 
                        }) :
                        await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, {
                            gasLimit: 500000
                        });
                    
                    console.log('Transaction sent:', tx.hash);
                    const receipt = await tx.wait();
                    console.log('Transaction confirmed:', receipt);
                    
                    updateButtonStates();
                    
                    // Show success modal instead of alert
                    const tokenOutName = TOKENS[tokenOut.toLowerCase()] || 'tokens';
                    const estimatedOut = document.getElementById('estimatedAmount').textContent;
                    showSuccessModal(tx.hash, estimatedOut, tokenOutName);
                    
                } else {
                    const date = document.getElementById('executionDate').value;
                    const time = document.getElementById('executionTime').value;
                    if (!date || !time) {
                        alert('Please set execution date and time');
                        return;
                    }
                    const execTime = Math.floor(new Date(date + ' ' + time).getTime() / 1000);
                    
                    if (execTime <= Math.floor(Date.now() / 1000)) {
                        alert('Execution time must be in the future');
                        return;
                    }
                    
                    if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                        console.log('Approving token for scheduled swap...');
                        const tokenContract = new ethers.Contract(
                            tokenIn,
                            ['function approve(address spender, uint256 amount) external returns (bool)'],
                            signer
                        );
                        
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                        document.getElementById('btnText').textContent = 'Approving... ⏳';
                        document.getElementById('scheduleSwapBtn').disabled = true;
                        await approveTx.wait();
                        console.log('Token approved');
                    }
                    
                    document.getElementById('btnText').textContent = 'Scheduling... ⏳';
                    
                    const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                        await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime, { value: amountWei }) :
                        await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime);
                    
                    await tx.wait();
                    
                    updateButtonStates();
                    
                    alert('📅 Swap scheduled! It will execute automatically at the scheduled time.');
                }
                
                document.getElementById('amountIn').value = '';
                document.getElementById('minAmountOut').value = '';
                document.getElementById('executionDate').value = '';
                document.getElementById('executionTime').value = '';
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                
                if (isConnected) {
                    loadData();
                    updateBalance();
                }
            } catch (e) {
                console.error('Swap error:', e);
                
                updateButtonStates();
                
                let errorMsg = 'Swap failed: ';
                
                if (e.code === 'INSUFFICIENT_FUNDS') {
                    errorMsg += 'Insufficient funds for gas or swap amount';
                } else if (e.message.includes('user rejected')) {
                    errorMsg += 'Transaction was rejected';
                } else if (e.reason) {
                    errorMsg += e.reason;
                } else if (e.error?.message) {
                    errorMsg += e.error.message;
                } else {
                    errorMsg += e.message || 'Unknown error';
                }
                
                alert(errorMsg);
            }
        }

        async function createLimitOrder() {
            if (!isConnected) {
                alert('Please connect your wallet first');
                showWalletModal();
                return;
            }
            
            const tokenIn = document.getElementById('tokenInLimit').value;
            const tokenOut = document.getElementById('tokenOutLimit').value;
            const amount = document.getElementById('amountInLimit').value;
            const targetPrice = document.getElementById('targetPrice').value;
            
            if (!amount || !targetPrice) {
                alert('Please fill in all fields');
                return;
            }
            
            if (tokenIn === tokenOut) {
                alert('Please select different tokens');
                return;
            }
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                const targetPriceWei = ethers.utils.parseEther(targetPrice);
                
                document.getElementById('limitBtnText').textContent = 'Creating...⏳';
                document.getElementById('createLimitBtn').disabled = true;
                
                if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                    console.log('Approving token...');
                    const tokenContract = new ethers.Contract(
                        tokenIn,
                        ['function approve(address spender, uint256 amount) external returns (bool)'],
                        signer
                    );
                    
                    const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                    document.getElementById('limitBtnText').textContent = 'Approving...⏳';
                    await approveTx.wait();
                    console.log('Token approved');
                }
                
                document.getElementById('limitBtnText').textContent = 'Creating Order...⏳';
                
                const expiryTime = getExpirationTime();
                
                const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                    await contract.createLimitOrder(tokenIn, tokenOut, amountWei, targetPriceWei, expiryTime, {
                        value: amountWei,
                        gasLimit: 500000
                    }) :
                    await contract.createLimitOrder(tokenIn, tokenOut, amountWei, targetPriceWei, expiryTime, {
                        gasLimit: 500000
                    });
                
                console.log('Transaction sent:', tx.hash);
                await tx.wait();
                console.log('Limit order created!');
                
                // Show success modal for limit order
                hideSuccessModal(); // Just use regular success message for limit orders
                alert('🎯 Limit order created successfully! It will execute automatically when the price reaches your target.');
                
                document.getElementById('amountInLimit').value = '';
                document.getElementById('targetPrice').value = '';
                
                loadData();
            } catch (e) {
                console.error('Limit order error:', e);
                alert('Failed to create limit order: ' + (e.reason || e.message));
            } finally {
                document.getElementById('limitBtnText').textContent = '🎯 Create Limit Order';
                document.getElementById('createLimitBtn').disabled = false;
            }
        }

        async function cancelSwap(id) {
            try {
                const tx = await contract.cancelSwap(id);
                await tx.wait();
                alert('Swap cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel swap error:', e);
                alert('Failed: ' + e.message);
            }
        }

        async function cancelLimitOrder(id) {
            try {
                const tx = await contract.cancelLimitOrder(id);
                await tx.wait();
                alert('Limit order cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel limit order error:', e);
                alert('Failed: ' + e.message);
            }
        }

        function switchTab(tab) {
            if (tab === 'schedule') {
                document.getElementById('scheduleTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.remove('text-gray-600');
                document.getElementById('limitTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('limitTab').classList.add('text-gray-600');
                document.getElementById('swapsTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.add('text-gray-600');
                document.getElementById('scheduleContent').classList.remove('hidden');
                document.getElementById('limitContent').classList.add('hidden');
                document.getElementById('swapsContent').classList.add('hidden');
            } else if (tab === 'limit') {
                document.getElementById('limitTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('limitTab').classList.remove('text-gray-600');
                document.getElementById('scheduleTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.add('text-gray-600');
                document.getElementById('swapsTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.add('text-gray-600');
                document.getElementById('limitContent').classList.remove('hidden');
                document.getElementById('scheduleContent').classList.add('hidden');
                document.getElementById('swapsContent').classList.add('hidden');
                updateMarketPrice();
            } else {
                document.getElementById('swapsTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.remove('text-gray-600');
                document.getElementById('scheduleTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.add('text-gray-600');
                document.getElementById('limitTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('limitTab').classList.add('text-gray-600');
                document.getElementById('swapsContent').classList.remove('hidden');
                document.getElementById('scheduleContent').classList.add('hidden');
                document.getElementById('limitContent').classList.add('hidden');
                if (isConnected) loadData();
            }
        }
        
        document.getElementById('withdrawBtn')?.addEventListener('click', async () => {
            try {
                const tx = await contract.withdrawFees();
                await tx.wait();
                alert('Fees withdrawn!');
            } catch (e) {
                console.error('Withdraw error:', e);
                alert('Failed: ' + e.message);
            }
        });

        function debounceQuote() {
            clearTimeout(quoteTimeout);
            quoteTimeout = setTimeout(getQuote, 500);
        }

        async function updateBalance() {
            if (!provider || !account) return;
            
            const tokenIn = document.getElementById('tokenIn').value;
            if (tokenIn === 'custom') return;
            
            try {
                let balance;
                if (tokenIn === '0x0000000000000000000000000000000000000000') {
                    balance = await provider.getBalance(account);
                    userBalanceFrom = parseFloat(ethers.utils.formatEther(balance));
                } else {
                    const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, provider);
                    balance = await tokenContract.balanceOf(account);
                    const decimals = await tokenContract.decimals();
                    userBalanceFrom = parseFloat(ethers.utils.formatUnits(balance, decimals));
                }
                
                const tokenName = TOKENS[tokenIn.toLowerCase()] || 'Token';
                document.getElementById('balanceFrom').textContent = `${userBalanceFrom.toFixed(4)} ${tokenName}`;
            } catch (e) {
                console.error('Balance fetch error:', e);
                document.getElementById('balanceFrom').textContent = '-';
            }
        }

        async function getQuote() {
            const amountIn = document.getElementById('amountIn').value;
            let tokenIn = document.getElementById('tokenIn').value;
            let tokenOut = document.getElementById('tokenOut').value;

            if (!amountIn || amountIn <= 0 || tokenIn === tokenOut) {
                document.getElementById('estimatedAmount').textContent = '0.0';
                document.getElementById('priceInfo').classList.add('hidden');
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                return;
            }

            if (tokenIn === 'custom') tokenIn = document.getElementById('customTokenIn').value.trim();
            if (tokenOut === 'custom') tokenOut = document.getElementById('customTokenOut').value.trim();
            if (!tokenIn || !tokenOut) return;

            try {
                document.getElementById('priceLoading').classList.remove('hidden');
                document.getElementById('priceInfo').classList.add('hidden');

                const tokenInAddr = tokenIn === '0x0000000000000000000000000000000000000000' ? WETH : tokenIn;
                const tokenOutAddr = tokenOut === '0x0000000000000000000000000000000000000000' ? WETH : tokenOut;

                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenInAddr}`);
                const data = await response.json();
                
                let price = 0;
                if (data && data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    price = parseFloat(pair.priceUsd);
                }

                const response2 = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenOutAddr}`);
                const data2 = await response2.json();
                
                let price2 = 0;
                if (data2 && data2.pairs && data2.pairs.length > 0) {
                    const pair2 = data2.pairs[0];
                    price2 = parseFloat(pair2.priceUsd);
                }

                if (price > 0 && price2 > 0) {
                    const estimated = (parseFloat(amountIn) * price) / price2;
                    const slippageMultiplier = (100 - slippageTolerance) / 100;
                    const minOut = estimated * slippageMultiplier;
                    
                    currentPriceUSD = price;
                    const outputPriceUSD = price2;
                    
                    const usdIn = parseFloat(amountIn) * price;
                    const usdOut = estimated * outputPriceUSD;
                    document.getElementById('usdValueIn').textContent = `$${usdIn.toFixed(2)}`;
                    document.getElementById('usdValueOut').textContent = `$${usdOut.toFixed(2)}`;
                    
                    document.getElementById('estimatedAmount').textContent = estimated.toFixed(6);
                    document.getElementById('minAmountOut').value = minOut.toFixed(6);
                    
                    const tokenInName = TOKENS[tokenIn.toLowerCase()] || 'Token';
                    const tokenOutName = TOKENS[tokenOut.toLowerCase()] || 'Token';
                    const rate = (estimated / parseFloat(amountIn)).toFixed(6);
                    
                    document.getElementById('exchangeRate').textContent = `1 ${tokenInName} = ${rate} ${tokenOutName}`;
                    document.getElementById('minReceived').textContent = `${minOut.toFixed(6)} ${tokenOutName}`;
                    document.getElementById('priceInfo').classList.remove('hidden');
                } else {
                    document.getElementById('estimatedAmount').textContent = '0.0';
                    document.getElementById('usdValueIn').textContent = '$0.00';
                    document.getElementById('usdValueOut').textContent = '$0.00';
                }

                document.getElementById('priceLoading').classList.add('hidden');
            } catch (error) {
                console.error('Price fetch error:', error);
                document.getElementById('estimatedAmount').textContent = '~';
                document.getElementById('priceLoading').classList.add('hidden');
            }
        }

        // Market Price and Limit Order Features
        async function updateMarketPrice() {
            const tokenIn = document.getElementById('tokenInLimit').value;
            const tokenOut = document.getElementById('tokenOutLimit').value;
            
            const tokenInName = TOKENS[tokenIn.toLowerCase()] || 'Token';
            const tokenOutName = TOKENS[tokenOut.toLowerCase()] || 'Token';
            
            document.getElementById('marketTokenIn').textContent = tokenInName;
            document.getElementById('marketTokenOut').textContent = tokenOutName;
            document.getElementById('marketPriceValue').textContent = 'Loading...';
            
            try {
                const tokenInAddr = tokenIn === '0x0000000000000000000000000000000000000000' ? WETH : tokenIn;
                const tokenOutAddr = tokenOut === '0x0000000000000000000000000000000000000000' ? WETH : tokenOut;

                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenInAddr}`);
                const data = await response.json();
                
                let priceIn = 0;
                if (data && data.pairs && data.pairs.length > 0) {
                    priceIn = parseFloat(data.pairs[0].priceUsd);
                }

                const response2 = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenOutAddr}`);
                const data2 = await response2.json();
                
                let priceOut = 0;
                if (data2 && data2.pairs && data2.pairs.length > 0) {
                    priceOut = parseFloat(data2.pairs[0].priceUsd);
                }

                if (priceIn > 0 && priceOut > 0) {
                    currentMarketPriceValue = priceIn / priceOut;
                    
                    let displayPrice;
                    if (currentMarketPriceValue >= 1) {
                        displayPrice = currentMarketPriceValue.toFixed(6);
                    } else if (currentMarketPriceValue >= 0.000001) {
                        displayPrice = currentMarketPriceValue.toFixed(8);
                    } else {
                        displayPrice = currentMarketPriceValue.toExponential(4);
                    }
                    
                    document.getElementById('marketPriceValue').textContent = displayPrice;
                } else {
                    document.getElementById('marketPriceValue').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Failed to get market price:', error);
                document.getElementById('marketPriceValue').textContent = 'Error';
            }
        }

        function updateOrderRateInfo() {
            const targetPrice = parseFloat(document.getElementById('targetPrice').value);
            const tokenInName = TOKENS[document.getElementById('tokenInLimit').value.toLowerCase()] || 'Token';
            const tokenOutName = TOKENS[document.getElementById('tokenOutLimit').value.toLowerCase()] || 'Token';
            
            if (targetPrice > 0 && currentMarketPriceValue > 0) {
                document.getElementById('orderRateInfo').classList.remove('hidden');
                document.getElementById('orderRateValue').textContent = `1 ${tokenInName} = ${targetPrice.toFixed(6)} ${tokenOutName}`;
                
                // Calculate difference
                const difference = ((targetPrice - currentMarketPriceValue) / currentMarketPriceValue) * 100;
                const diffElement = document.getElementById('priceDifference');
                
                if (Math.abs(difference) < 0.1) {
                    diffElement.textContent = '≈ At Market Price';
                    diffElement.className = 'text-xs text-center mt-1 font-semibold text-gray-600';
                } else if (difference > 0) {
                    diffElement.textContent = `${difference.toFixed(2)}% above market 📈`;
                    diffElement.className = 'text-xs text-center mt-1 font-semibold text-green-600';
                } else {
                    diffElement.textContent = `${Math.abs(difference).toFixed(2)}% below market 📉`;
                    diffElement.className = 'text-xs text-center mt-1 font-semibold text-red-600';
                }
            } else {
                document.getElementById('orderRateInfo').classList.add('hidden');
            }
        }

        function updateExpirationPreview() {
            const select = document.getElementById('expirationSelect');
            const customInput = document.getElementById('customExpirationInput');
            const preview = document.getElementById('expirationPreview');
            
            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                preview.classList.add('hidden');
            } else {
                customInput.classList.add('hidden');
                
                if (select.value === '0') {
                    preview.classList.add('hidden');
                } else {
                    const seconds = parseInt(select.value);
                    const expiryDate = new Date(Date.now() + seconds * 1000);
                    preview.textContent = `Expires: ${expiryDate.toLocaleString()}`;
                    preview.classList.remove('hidden');
                }
            }
        }

        function getExpirationTime() {
            const select = document.getElementById('expirationSelect');
            
            if (select.value === 'custom') {
                const hours = parseInt(document.getElementById('customExpirationHours').value) || 0;
                if (hours > 0) {
                    return Math.floor(Date.now() / 1000) + (hours * 3600);
                }
                return 0;
            } else if (select.value === '0') {
                return 0; // Never expires
            } else {
                return Math.floor(Date.now() / 1000) + parseInt(select.value);
            }
        }

        // Event listeners for limit order features
        document.getElementById('targetPrice').addEventListener('input', updateOrderRateInfo);
        
        document.getElementById('refreshPriceBtn').addEventListener('click', updateMarketPrice);
        
        document.getElementById('expirationSelect').addEventListener('change', updateExpirationPreview);
        
        document.getElementById('customExpirationHours').addEventListener('input', () => {
            const hours = parseInt(document.getElementById('customExpirationHours').value);
            if (hours > 0) {
                const expiryDate = new Date(Date.now() + hours * 3600000);
                document.getElementById('expirationPreview').textContent = `Expires: ${expiryDate.toLocaleString()}`;
                document.getElementById('expirationPreview').classList.remove('hidden');
            }
        });

        // Initialize
        updateTargetPriceLabels();
    </script>
</body>
</html>

<script>
// Onboarding Modal Functions
let currentOnboardingScreen = 1;

function closeOnboarding() {
    document.getElementById('onboardingModal').classList.add('hidden');
    localStorage.setItem('mangoswapOnboardingComplete', 'true');
}

function nextOnboardingScreen() {
    const currentElement = document.querySelector('.onboarding-screen.active');
    currentElement.classList.remove('active');
    
    currentOnboardingScreen++;
    const nextElement = document.querySelector(`[data-screen="${currentOnboardingScreen}"]`);
    nextElement.classList.add('active');
}

// Check if user already completed onboarding
window.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('mangoswapOnboardingComplete') === 'true') {
        document.getElementById('onboardingModal').classList.add('hidden');
    }
    
    // Dark Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const body = document.body;
    
    // Check for saved theme preference or default to light mode
    const currentTheme = localStorage.getItem('mangoswapTheme') || 'light';
    if (currentTheme === 'dark') {
        body.classList.add('dark-mode');
        themeIcon.textContent = '☀️';
    }
    
    // Toggle theme
    themeToggle.addEventListener('click', function() {
        body.classList.toggle('dark-mode');
        
        if (body.classList.contains('dark-mode')) {
            themeIcon.textContent = '☀️';
            localStorage.setItem('mangoswapTheme', 'dark');
        } else {
            themeIcon.textContent = '🌙';
            localStorage.setItem('mangoswapTheme', 'light');
        }
    });
});
</script>
