<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoSwap - Automate Your Trades</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-100 via-yellow-50 to-green-100 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-xl shadow-xl p-6 mb-8 border-4 border-orange-300 transition-colors duration-300">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 bg-clip-text text-transparent">ü•≠ MangoSwap</h1>
                    <p class="text-gray-700 mt-1 font-medium">Sweet Swaps on Base üå¥</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="connectBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition transform hover:scale-105">Connect Wallet</button>
                </div>
                
                <!-- Slippage Settings Modal -->
                <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 border-4 border-orange-300 transition-colors duration-300">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">üìä Slippage Settings</h3>
                        
                        <!-- Slippage Settings -->
                        <div class="mb-6 p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl border-2 border-orange-200">
                            <label class="block text-sm font-bold text-orange-900 mb-3">Slippage Tolerance</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="0.5">0.5%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="1">1%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition bg-orange-500 text-white border-2 border-orange-500" data-value="5">5%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="10">10%</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="customSlippage" placeholder="Custom" step="0.1" min="0" max="50" class="flex-1 px-3 py-2 border-2 border-orange-200 rounded-lg font-semibold text-center">
                                <span class="font-bold text-orange-900">%</span>
                            </div>
                            <p class="text-xs text-orange-700 mt-2">‚ö†Ô∏è High slippage may result in unfavorable rates</p>
                        </div>
                        
                        <button id="closeSettings" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition">
                            Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- Wallet Modal -->
                <div id="walletModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 border-4 border-orange-300 transition-colors duration-300">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Connect Wallet</h3>
                        <div class="space-y-3">
                            <button id="connectMetaMask" class="w-full bg-gradient-to-r from-orange-400 to-yellow-400 hover:from-orange-500 hover:to-yellow-500 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                ü¶ä MetaMask
                            </button>
                            <button id="connectPhantom" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                üëª Phantom
                            </button>
                        </div>
                        <button id="closeModal" class="mt-4 w-full text-gray-600 hover:text-gray-800 font-semibold">Cancel</button>
                    </div>
                </div>
                <div id="accountInfo" class="hidden text-right">
                    <div class="text-sm text-gray-600">Connected</div>
                    <div id="accountAddress" class="font-mono text-sm bg-orange-100 px-3 py-1 rounded-lg border-2 border-orange-300"></div>
                </div>
            </div>
        </div>

        <div id="mainContent">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-orange-200 transition-colors duration-300">
                    <div class="text-sm text-orange-700 font-semibold">Total Swaps</div>
                    <div id="totalSwaps" class="text-3xl font-bold text-orange-600">0</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-yellow-200 transition-colors duration-300">
                    <div class="text-sm text-yellow-700 font-semibold">Scheduled</div>
                    <div id="scheduledCount" class="text-3xl font-bold text-yellow-600">0</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-green-200 transition-colors duration-300">
                    <div class="text-sm text-green-700 font-semibold">Executed</div>
                    <div id="executedCount" class="text-3xl font-bold text-green-600">0</div>
                </div>
                <div id="ownerStats" class="bg-white rounded-xl shadow-lg p-6 border-2 border-emerald-200 hidden transition-colors duration-300">
                    <button id="withdrawBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-2 rounded-lg text-sm transition font-bold shadow-md" style="display:none;">üí∞ Withdraw</button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border-4 border-orange-300 transition-colors duration-300">
                <div class="flex border-b-4 border-orange-200">
                    <button id="scheduleTab" class="flex-1 px-6 py-4 font-bold bg-gradient-to-r from-orange-500 to-yellow-500 text-white text-lg">Schedule Swap</button>
                    <button id="swapsTab" class="flex-1 px-6 py-4 font-bold text-gray-600 hover:bg-orange-50 text-lg transition">My Swaps</button>
                </div>

                <div id="scheduleContent" class="p-6 bg-gradient-to-br from-orange-50 to-yellow-50 transition-colors duration-300">
                    <div class="bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-orange-300 rounded-xl p-4 mb-6">
                        <p class="text-sm text-orange-900 font-medium">üå¥ <strong>How it works:</strong> Schedule your token swaps to execute automatically at your chosen time. Perfect for DCA strategies, timed entries/exits, or avoiding emotional trading!</p>
                    </div>

                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white border-3 border-orange-300 rounded-2xl p-4 shadow-lg transition-colors duration-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-bold text-orange-700">From</label>
                                <div class="text-right" id="balanceSection" style="display:none;">
                                    <div class="text-xs text-gray-600">Balance: <span id="balanceFrom" class="font-semibold">-</span></div>
                                    <button id="maxBtn" class="text-xs bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold px-2 py-1 rounded transition">MAX</button>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                                <div class="flex-1">
                                    <input type="number" step="0.001" id="amountIn" placeholder="0.0" class="w-full text-3xl font-bold bg-transparent border-none outline-none text-gray-800">
                                    <div id="usdValueIn" class="text-sm text-gray-500 mt-1">$0.00</div>
                                </div>
                                <select id="tokenIn" class="bg-gradient-to-r from-orange-100 to-yellow-100 border-3 border-orange-300 rounded-xl px-4 py-3 font-bold text-lg hover:border-orange-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[140px]">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <input type="text" id="customTokenIn" placeholder="Paste token address (0x...)" class="hidden w-full mt-3 px-3 py-2 border-2 border-orange-200 rounded-lg text-sm">
                        </div>

                        <div class="flex justify-center -my-2 relative z-10">
                            <button id="swapArrow" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white rounded-xl p-3 shadow-xl transition transform hover:scale-110 hover:rotate-180 duration-300 border-3 border-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="bg-white border-3 border-green-300 rounded-2xl p-4 shadow-lg transition-colors duration-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-bold text-green-700">To (estimated)</label>
                                <div id="priceLoading" class="hidden text-xs text-orange-600 font-semibold">Fetching price...</div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                                <div class="flex-1">
                                    <div class="text-3xl font-bold text-gray-800" id="estimatedAmount">0.0</div>
                                    <div id="usdValueOut" class="text-sm text-gray-500 mt-1">$0.00</div>
                                </div>
                                <input type="number" step="0.001" id="minAmountOut" placeholder="0.0" class="hidden">
                                <select id="tokenOut" class="bg-gradient-to-r from-green-100 to-emerald-100 border-3 border-green-300 rounded-xl px-4 py-3 font-bold text-lg hover:border-green-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[140px]">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <input type="text" id="customTokenOut" placeholder="Paste token address (0x...)" class="hidden w-full mt-3 px-3 py-2 border-2 border-green-200 rounded-lg text-sm">
                            <div id="priceInfo" class="mt-3 space-y-1 text-sm hidden bg-green-50 p-3 rounded-lg border border-green-200">
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Exchange Rate:</span>
                                    <span id="exchangeRate" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Min received (<span id="slippageDisplay">5</span>% slippage) <button id="editSlippageBtn" class="text-orange-600 hover:text-orange-700 ml-1">‚öôÔ∏è</button>:</span>
                                    <span id="minReceived" class="font-bold">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-3 border-yellow-300 rounded-2xl p-4 mt-6 shadow-lg transition-colors duration-300">
                            <h3 class="font-bold text-orange-800 mb-3 text-lg">‚è∞ Execution Time</h3>
                            <div class="space-y-2 mb-3">
                                <label class="flex items-center space-x-3 cursor-pointer bg-white p-3 rounded-xl hover:bg-yellow-50 transition border-2 border-yellow-200">
                                    <input type="radio" name="timeOption" value="now" id="timeNow" class="w-5 h-5 text-orange-600">
                                    <span class="font-bold text-gray-800">Execute Now (Instant Swap)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer bg-white p-3 rounded-xl hover:bg-yellow-50 transition border-2 border-yellow-200">
                                    <input type="radio" name="timeOption" value="scheduled" id="timeScheduled" checked class="w-5 h-5 text-orange-600">
                                    <span class="font-bold text-gray-800">Schedule for Later</span>
                                </label>
                            </div>
                            <div id="scheduledTimeInputs" class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-bold text-orange-700 mb-1">Date</label>
                                    <input type="date" id="executionDate" class="w-full px-3 py-2 border-3 border-orange-200 rounded-xl font-semibold">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-orange-700 mb-1">Time</label>
                                    <input type="time" id="executionTime" class="w-full px-3 py-2 border-3 border-orange-200 rounded-xl font-semibold">
                                </div>
                            </div>
                            <p id="scheduledTimeNote" class="text-sm text-orange-800 mt-2 font-medium">Executes automatically at this time (within 1 hour window)</p>
                            <p id="instantTimeNote" class="text-sm text-orange-800 mt-2 font-medium hidden">Swap executes immediately after confirmation</p>
                        </div>

                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-4 border-2 border-green-300 transition-colors duration-300">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-green-800 font-semibold">Platform Fee</span>
                                <span class="font-bold text-green-900">0.3%</span>
                            </div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-green-800 font-semibold">Execution Fee</span>
                                <span class="font-bold text-green-900">0.2%</span>
                            </div>
                            <div class="flex justify-between text-sm pt-2 border-t-2 border-green-300">
                                <span class="font-bold text-green-900">Total Fee</span>
                                <span class="font-bold text-orange-600 text-lg">0.5%</span>
                            </div>
                        </div>

                        <button id="scheduleSwapBtn" class="w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 hover:from-orange-600 hover:via-yellow-600 hover:to-green-600 text-white font-black py-5 rounded-2xl transition text-xl shadow-2xl transform hover:scale-105 border-4 border-white disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btnText">üîó Connect Wallet to Swap</span>
                        </button>
                        
                        <!-- Approval Flow Indicator -->
                        <div id="approvalIndicator" class="hidden mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div id="step1" class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">1</div>
                                        <span class="font-semibold text-blue-900">Approve Token</span>
                                    </div>
                                    <div class="text-blue-400">‚Üí</div>
                                    <div id="step2" class="flex items-center gap-2 opacity-50">
                                        <div class="w-8 h-8 rounded-full bg-gray-300 text-white flex items-center justify-center font-bold">2</div>
                                        <span class="font-semibold text-gray-600">Schedule Swap</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm text-blue-800">üí° First time swapping this token? You'll need to approve it first (one-time transaction).</p>
                        </div>
                    </div>
                </div>

                <div id="swapsContent" class="p-6 hidden transition-colors duration-300">
                    <div id="swapsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0xde6d1499acfb534b36b31e2f1efff90d5af819d7';
        const BASE_CHAIN_ID = '0x2105';
        const ABI = ["function scheduleSwap(address,address,uint256,uint256,uint256) external payable returns(uint256)","function cancelSwap(uint256) external","function getSwap(uint256) external view returns(tuple(uint256,address,address,address,uint256,uint256,uint256,uint8,uint256,uint256))","function getUserSwaps(address) external view returns(uint256[])","function getTotalSwaps() external view returns(uint256)","function withdrawFees() external","function owner() external view returns(address)"];

        const TOKENS = {'0x0000000000000000000000000000000000000000':'ETH','0x4200000000000000000000000000000000000006':'WETH','0x833589fcd6edb6e08f4c7c32d4f71b54bda02913':'USDC','0x50c5725949a6f0c72e6c4a641f24049a917db0cb':'DAI','0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf':'cbBTC','0x532f27101965dd16442e59d40670faf5ebb142e4':'BRETT','0x940181a94a35a4569e4529a3cdfb74e38fd98631':'AERO','0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4':'TOSHI','0x4ed4e862860bed51a9570b96d89af5e1b0efefed':'DEGEN','0xa88594d404727625a9437c3f886c7643872296ae':'WELL','0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b':'VIRTUAL','0x78a087d713be963bf307b18f2ff8122ef9a63ae9':'ZORA','0x58d97b57bb95320f9a05dc918aef65434969c2b2':'MORPHO'};

        const WETH = '0x4200000000000000000000000000000000000006';
        let provider, signer, contract, account, isOwner = false;
        let quoteTimeout;
        let selectedWallet = null;
        let isConnected = false;
        
        // Settings state
        let slippageTolerance = 5;
        let userBalanceFrom = 0;
        let currentPriceUSD = 0;

        // ERC20 ABI for balance and approval
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) returns (bool)"
        ];

        // Load saved settings
        function loadSettings() {
            const savedSlippage = localStorage.getItem('mangoswap_slippage') || '5';
            slippageTolerance = parseFloat(savedSlippage);
            updateSlippageUI();
        }

        // Update slippage UI
        function updateSlippageUI() {
            document.querySelectorAll('.slippage-btn').forEach(btn => {
                const value = parseFloat(btn.dataset.value);
                if (value === slippageTolerance) {
                    btn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.remove('border-orange-200');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.add('border-orange-200');
                }
            });
            document.getElementById('slippageDisplay').textContent = slippageTolerance;
            localStorage.setItem('mangoswap_slippage', slippageTolerance.toString());
        }

        // Initialize settings
        loadSettings();
        
        // Disable button initially
        document.getElementById('scheduleSwapBtn').disabled = true;

        // Edit slippage button
        document.getElementById('editSlippageBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('hidden');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        // Slippage buttons
        document.querySelectorAll('.slippage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                slippageTolerance = parseFloat(btn.dataset.value);
                updateSlippageUI();
                getQuote();
            });
        });

        // Custom slippage input
        document.getElementById('customSlippage').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value && value > 0 && value <= 50) {
                slippageTolerance = value;
                updateSlippageUI();
                getQuote();
            }
        });

        document.getElementById('connectBtn').addEventListener('click', showWalletModal);
        document.getElementById('closeModal').addEventListener('click', hideWalletModal);
        document.getElementById('connectMetaMask').addEventListener('click', () => connectWallet('metamask'));
        document.getElementById('connectPhantom').addEventListener('click', () => connectWallet('phantom'));
        document.getElementById('scheduleTab').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('swapsTab').addEventListener('click', () => switchTab('swaps'));
        document.getElementById('scheduleSwapBtn').addEventListener('click', scheduleSwap);
        
        document.getElementById('amountIn').addEventListener('input', debounceQuote);
        document.getElementById('tokenIn').addEventListener('change', () => {
            getQuote();
            if (isConnected) updateBalance();
        });
        document.getElementById('tokenOut').addEventListener('change', getQuote);
        
        document.getElementById('maxBtn').addEventListener('click', () => {
            if (!isConnected) {
                alert('Please connect your wallet first');
                return;
            }
            document.getElementById('amountIn').value = userBalanceFrom;
            getQuote();
        });
        
        document.getElementById('swapArrow').addEventListener('click', function() {
            const tokenInSelect = document.getElementById('tokenIn');
            const tokenOutSelect = document.getElementById('tokenOut');
            const tempValue = tokenInSelect.value;
            tokenInSelect.value = tokenOutSelect.value;
            tokenOutSelect.value = tempValue;
            getQuote();
        });
        
        document.getElementById('tokenIn').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customTokenIn').classList.remove('hidden');
            } else {
                document.getElementById('customTokenIn').classList.add('hidden');
            }
        });
        
        document.getElementById('tokenOut').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customTokenOut').classList.remove('hidden');
            } else {
                document.getElementById('customTokenOut').classList.add('hidden');
            }
        });
        
        document.getElementById('timeNow').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.add('hidden');
                document.getElementById('scheduledTimeNote').classList.add('hidden');
                document.getElementById('instantTimeNote').classList.remove('hidden');
            }
        });
        
        document.getElementById('timeScheduled').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.remove('hidden');
                document.getElementById('scheduledTimeNote').classList.remove('hidden');
                document.getElementById('instantTimeNote').classList.add('hidden');
            }
        });

        function showWalletModal() {
            document.getElementById('walletModal').classList.remove('hidden');
        }

        function hideWalletModal() {
            document.getElementById('walletModal').classList.add('hidden');
        }

        async function connectWallet(walletType) {
            console.log('Attempting to connect:', walletType);
            selectedWallet = walletType;
            hideWalletModal();

            let ethereum;
            
            if (walletType === 'phantom') {
                if (window.phantom?.ethereum) {
                    ethereum = window.phantom.ethereum;
                } else {
                    alert('Phantom wallet not installed! Visit phantom.app to install.');
                    return;
                }
            } else {
                // MetaMask - simplified detection
                console.log('window.ethereum exists:', !!window.ethereum);
                
                if (!window.ethereum) {
                    alert('No wallet detected! Please install MetaMask from metamask.io');
                    return;
                }
                
                // Use window.ethereum directly
                ethereum = window.ethereum;
                console.log('Using ethereum provider:', ethereum);
            }

            if (!ethereum) {
                alert('Wallet provider not found!');
                return;
            }
            
            try {
                console.log('Requesting accounts...');
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                console.log('Accounts received:', accounts);
                
                console.log('Checking chain ID...');
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId, 'Expected:', BASE_CHAIN_ID);
                
                if (chainId !== BASE_CHAIN_ID) {
                    console.log('Wrong network, switching to Base...');
                    try {
                        await ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        console.log('Switch error:', switchError);
                        if (switchError.code === 4902) {
                            console.log('Network not added, adding Base network...');
                            await ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                account = accounts[0];
                console.log('Connected account:', account);
                
                provider = new ethers.providers.Web3Provider(ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                isConnected = true;
                
                console.log('Provider initialized');
                
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('accountInfo').classList.remove('hidden');
                document.getElementById('accountAddress').textContent = account.slice(0, 6) + '...' + account.slice(-4);
                document.getElementById('balanceSection').style.display = 'block';
                document.getElementById('scheduleSwapBtn').disabled = false;
                document.getElementById('btnText').textContent = 'ü•≠ Schedule Swap üå¥';
                
                console.log('Checking if owner...');
                const owner = await contract.owner();
                isOwner = owner.toLowerCase() === account.toLowerCase();
                if (isOwner) {
                    document.getElementById('ownerStats').classList.remove('hidden');
                    document.getElementById('withdrawBtn').style.display = 'block';
                }
                
                console.log('Loading data...');
                loadData();
                updateBalance();
                console.log('Connection complete!');
            } catch (e) {
                console.error('Connection error details:', e);
                alert('Failed to connect: ' + e.message + '\n\nCheck browser console (F12) for details.');
            }
        }

        async function loadData() {
            try {
                const total = await contract.getTotalSwaps();
                document.getElementById('totalSwaps').textContent = total.toString();
                
                const ids = await contract.getUserSwaps(account);
                const swaps = await Promise.all(ids.map(async id => {
                    const s = await contract.getSwap(id);
                    return {
                        id: s[0].toString(),
                        user: s[1],
                        tokenIn: s[2],
                        tokenOut: s[3],
                        amountIn: ethers.utils.formatEther(s[4]),
                        minAmountOut: ethers.utils.formatEther(s[5]),
                        executionTime: new Date(s[6].toNumber() * 1000),
                        status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][s[7]],
                        executedAt: s[8].toNumber(),
                        amountOut: ethers.utils.formatEther(s[9])
                    };
                }));
                
                const scheduled = swaps.filter(s => s.status === 'Scheduled').length;
                const executed = swaps.filter(s => s.status === 'Executed').length;
                document.getElementById('scheduledCount').textContent = scheduled;
                document.getElementById('executedCount').textContent = executed;
                displaySwaps(swaps);
            } catch (e) {
                console.error('Load data error:', e);
            }
        }

        function displaySwaps(swaps) {
            const list = document.getElementById('swapsList');
            if (swaps.length === 0) {
                list.innerHTML = '<div class="text-center py-12 text-gray-500"><p>No swaps scheduled yet!</p></div>';
                return;
            }
            list.innerHTML = swaps.map(s => {
                const tokenInName = TOKENS[s.tokenIn.toLowerCase()] || s.tokenIn.slice(0, 6) + '...';
                const tokenOutName = TOKENS[s.tokenOut.toLowerCase()] || s.tokenOut.slice(0, 6) + '...';
                return `
                <div class="border-2 border-orange-200 rounded-xl p-6 mb-4 bg-white shadow-lg">
                    <div class="flex justify-between mb-4">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${s.status === 'Scheduled' ? 'bg-yellow-100 text-yellow-800' : s.status === 'Executed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${s.status}</span>
                        <div class="text-right">
                            <div class="font-bold text-lg">${s.amountIn} ${tokenInName} ‚Üí ${tokenOutName}</div>
                            <div class="text-sm text-gray-600">Min: ${s.minAmountOut} ${tokenOutName}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div><span class="text-gray-600">Executes:</span><div class="font-semibold">${s.executionTime.toLocaleString()}</div></div>
                        ${s.status === 'Executed' ? `<div><span class="text-gray-600">Received:</span><div class="font-semibold text-green-600">${s.amountOut} ${tokenOutName}</div></div>` : ''}
                    </div>
                    ${s.status === 'Scheduled' ? `<button onclick="cancelSwap(${s.id})" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition">Cancel Swap</button>` : ''}
                </div>
            `;
            }).join('');
        }

        async function scheduleSwap() {
            if (!isConnected) {
                alert('Please connect your wallet first');
                showWalletModal();
                return;
            }
            
            let tokenIn = document.getElementById('tokenIn').value;
            let tokenOut = document.getElementById('tokenOut').value;
            
            if (tokenIn === 'custom') {
                tokenIn = document.getElementById('customTokenIn').value.trim();
                if (!tokenIn || !tokenIn.startsWith('0x') || tokenIn.length !== 42) {
                    alert('Invalid token address for From Token');
                    return;
                }
            }
            
            if (tokenOut === 'custom') {
                tokenOut = document.getElementById('customTokenOut').value.trim();
                if (!tokenOut || !tokenOut.startsWith('0x') || tokenOut.length !== 42) {
                    alert('Invalid token address for To Token');
                    return;
                }
            }
            
            const amount = document.getElementById('amountIn').value;
            const minOut = document.getElementById('minAmountOut').value;
            
            if (!amount || !minOut) {
                alert('Fill all fields');
                return;
            }
            
            if (parseFloat(amount) > userBalanceFrom && tokenIn !== 'custom') {
                alert(`Insufficient balance. You have ${userBalanceFrom.toFixed(4)} tokens.`);
                return;
            }
            
            if (tokenIn === tokenOut) {
                alert('Select different tokens');
                return;
            }
            
            const isInstant = document.getElementById('timeNow').checked;
            let execTime;
            
            if (isInstant) {
                execTime = Math.floor(Date.now() / 1000) + 60;
            } else {
                const date = document.getElementById('executionDate').value;
                const time = document.getElementById('executionTime').value;
                if (!date || !time) {
                    alert('Please set execution date and time');
                    return;
                }
                execTime = Math.floor(new Date(date + ' ' + time).getTime() / 1000);
            }
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                const minOutWei = ethers.utils.parseEther(minOut);
                const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                    await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime, { value: amountWei }) :
                    await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime);
                await tx.wait();
                alert(isInstant ? 'Swap scheduled for immediate execution!' : 'Swap scheduled!');
                document.getElementById('amountIn').value = '';
                document.getElementById('minAmountOut').value = '';
                document.getElementById('executionDate').value = '';
                document.getElementById('executionTime').value = '';
                loadData();
            } catch (e) {
                console.error('Schedule swap error:', e);
                alert('Failed: ' + e.message);
            }
        }

        async function cancelSwap(id) {
            try {
                const tx = await contract.cancelSwap(id);
                await tx.wait();
                alert('Cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel swap error:', e);
                alert('Failed: ' + e.message);
            }
        }

        function switchTab(tab) {
            if (tab === 'schedule') {
                document.getElementById('scheduleTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.remove('text-gray-600');
                document.getElementById('swapsTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.add('text-gray-600');
                document.getElementById('scheduleContent').classList.remove('hidden');
                document.getElementById('swapsContent').classList.add('hidden');
            } else {
                document.getElementById('swapsTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.remove('text-gray-600');
                document.getElementById('scheduleTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.add('text-gray-600');
                document.getElementById('swapsContent').classList.remove('hidden');
                document.getElementById('scheduleContent').classList.add('hidden');
            }
        }

        document.getElementById('withdrawBtn')?.addEventListener('click', async () => {
            try {
                const tx = await contract.withdrawFees();
                await tx.wait();
                alert('Fees withdrawn!');
            } catch (e) {
                console.error('Withdraw error:', e);
                alert('Failed: ' + e.message);
            }
        });

        function debounceQuote() {
            clearTimeout(quoteTimeout);
            quoteTimeout = setTimeout(getQuote, 500);
        }

        async function updateBalance() {
            if (!provider || !account) return;
            
            const tokenIn = document.getElementById('tokenIn').value;
            if (tokenIn === 'custom') return;
            
            try {
                let balance;
                if (tokenIn === '0x0000000000000000000000000000000000000000') {
                    balance = await provider.getBalance(account);
                    userBalanceFrom = parseFloat(ethers.utils.formatEther(balance));
                } else {
                    const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, provider);
                    balance = await tokenContract.balanceOf(account);
                    const decimals = await tokenContract.decimals();
                    userBalanceFrom = parseFloat(ethers.utils.formatUnits(balance, decimals));
                }
                
                const tokenName = TOKENS[tokenIn.toLowerCase()] || 'Token';
                document.getElementById('balanceFrom').textContent = `${userBalanceFrom.toFixed(4)} ${tokenName}`;
                
                if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                    document.getElementById('approvalIndicator').classList.remove('hidden');
                } else {
                    document.getElementById('approvalIndicator').classList.add('hidden');
                }
            } catch (e) {
                console.error('Balance fetch error:', e);
                document.getElementById('balanceFrom').textContent = '-';
            }
        }

        async function getQuote() {
            const amountIn = document.getElementById('amountIn').value;
            let tokenIn = document.getElementById('tokenIn').value;
            let tokenOut = document.getElementById('tokenOut').value;

            if (!amountIn || amountIn <= 0 || tokenIn === tokenOut) {
                document.getElementById('estimatedAmount').textContent = '0.0';
                document.getElementById('priceInfo').classList.add('hidden');
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                return;
            }

            if (tokenIn === 'custom') tokenIn = document.getElementById('customTokenIn').value.trim();
            if (tokenOut === 'custom') tokenOut = document.getElementById('customTokenOut').value.trim();
            if (!tokenIn || !tokenOut) return;

            try {
                document.getElementById('priceLoading').classList.remove('hidden');
                document.getElementById('priceInfo').classList.add('hidden');

                const tokenInAddr = tokenIn === '0x0000000000000000000000000000000000000000' ? WETH : tokenIn;
                const tokenOutAddr = tokenOut === '0x0000000000000000000000000000000000000000' ? WETH : tokenOut;

                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenInAddr}`);
                const data = await response.json();
                
                let price = 0;
                if (data && data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    price = parseFloat(pair.priceUsd);
                }

                const response2 = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenOutAddr}`);
                const data2 = await response2.json();
                
                let price2 = 0;
                if (data2 && data2.pairs && data2.pairs.length > 0) {
                    const pair2 = data2.pairs[0];
                    price2 = parseFloat(pair2.priceUsd);
                }

                if (price > 0 && price2 > 0) {
                    const estimated = (parseFloat(amountIn) * price) / price2;
                    const slippageMultiplier = (100 - slippageTolerance) / 100;
                    const minOut = estimated * slippageMultiplier;
                    
                    currentPriceUSD = price;
                    const outputPriceUSD = price2;
                    
                    const usdIn = parseFloat(amountIn) * price;
                    const usdOut = estimated * outputPriceUSD;
                    document.getElementById('usdValueIn').textContent = `${usdIn.toFixed(2)}`;
                    document.getElementById('usdValueOut').textContent = `${usdOut.toFixed(2)}`;
                    
                    document.getElementById('estimatedAmount').textContent = estimated.toFixed(6);
                    document.getElementById('minAmountOut').value = minOut.toFixed(6);
                    
                    const tokenInName = TOKENS[tokenIn.toLowerCase()] || 'Token';
                    const tokenOutName = TOKENS[tokenOut.toLowerCase()] || 'Token';
                    const rate = (estimated / parseFloat(amountIn)).toFixed(6);
                    
                    document.getElementById('exchangeRate').textContent = `1 ${tokenInName} = ${rate} ${tokenOutName}`;
                    document.getElementById('minReceived').textContent = `${minOut.toFixed(6)} ${tokenOutName}`;
                    document.getElementById('priceInfo').classList.remove('hidden');
                } else {
                    document.getElementById('estimatedAmount').textContent = '0.0';
                    document.getElementById('usdValueIn').textContent = '$0.00';
                    document.getElementById('usdValueOut').textContent = '$0.00';
                }

                document.getElementById('priceLoading').classList.add('hidden');
            } catch (error) {
                console.error('Price fetch error:', error);
                document.getElementById('estimatedAmount').textContent = '~';
                document.getElementById('priceLoading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
