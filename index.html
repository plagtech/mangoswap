<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoSwap - Automate Your Trades</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•≠</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-100 via-yellow-50 to-green-100 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-4 max-w-3xl">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4 border-2 border-orange-300 transition-colors duration-300">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <h1 class="text-3xl font-bold"><span class="inline-block">ü•≠</span> <span class="bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 bg-clip-text text-transparent">MangoSwap</span></h1>
                    <p class="text-gray-600 text-sm font-medium">Sweet Swaps on Base üå¥</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="connectBtn" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white px-5 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105">Connect Wallet</button>
                </div>
                
                <!-- Slippage Settings Modal -->
                <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 border-4 border-orange-300 transition-colors duration-300">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">üìä Slippage Settings</h3>
                        <div class="mb-6 p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl border-2 border-orange-200">
                            <label class="block text-sm font-bold text-orange-900 mb-3">Slippage Tolerance</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="0.5">0.5%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="1">1%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition bg-orange-500 text-white border-2 border-orange-500" data-value="5">5%</button>
                                <button class="slippage-btn py-2 px-3 rounded-lg font-semibold transition border-2 border-orange-200 hover:border-orange-400" data-value="10">10%</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="customSlippage" placeholder="Custom" step="0.1" min="0" max="50" class="flex-1 px-3 py-2 border-2 border-orange-200 rounded-lg font-semibold text-center">
                                <span class="font-bold text-orange-900">%</span>
                            </div>
                            <p class="text-xs text-orange-700 mt-2">‚ö†Ô∏è High slippage may result in unfavorable rates</p>
                        </div>
                        <button id="closeSettings" class="w-full bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition">
                            Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- Wallet Modal -->
                <div id="walletModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 border-4 border-orange-300 transition-colors duration-300">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Connect Wallet</h3>
                        <div class="space-y-3">
                            <button id="connectMetaMask" class="w-full bg-gradient-to-r from-orange-400 to-yellow-400 hover:from-orange-500 hover:to-yellow-500 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                ü¶ä MetaMask
                            </button>
                            <button id="connectCoinbase" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                üîµ Coinbase Wallet
                            </button>
                            <button id="connectPhantom" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                üëª Phantom
                            </button>
                        </div>
                        <button id="closeModal" class="mt-4 w-full text-gray-600 hover:text-gray-800 font-semibold">Cancel</button>
                    </div>
                </div>
                <div id="accountInfo" class="hidden text-right">
                    <div class="text-xs text-gray-600">Connected</div>
                    <div id="accountAddress" class="font-mono text-xs bg-orange-100 px-2 py-1 rounded border border-orange-300"></div>
                </div>
            </div>
        </div>

        <div id="mainContent">
            <div class="bg-white rounded-xl shadow-xl overflow-hidden border-2 border-orange-300 transition-colors duration-300">
                <div class="flex border-b-2 border-orange-200">
    <button id="scheduleTab" class="flex-1 px-3 py-2 font-bold bg-gradient-to-r from-orange-500 to-yellow-500 text-white text-xs sm:text-sm">Swap</button>
    <button id="limitTab" class="flex-1 px-3 py-2 font-bold text-gray-600 hover:bg-orange-50 transition text-xs sm:text-sm">Limit Order</button>
    <button id="swapsTab" class="flex-1 px-3 py-2 font-bold text-gray-600 hover:bg-orange-50 transition text-xs sm:text-sm">My Orders</button>
</div>

                <div id="scheduleContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 transition-colors duration-300">
                    <div class="max-w-md mx-auto space-y-3">
                        <div class="bg-white border-2 border-orange-300 rounded-xl p-3 shadow-md transition-colors duration-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-orange-700">From</label>
                                <div class="text-right" id="balanceSection" style="display:none;">
                                    <div class="text-xs text-gray-600">Balance: <span id="balanceFrom" class="font-semibold">-</span></div>
                                    <button id="maxBtn" class="text-xs bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold px-2 py-0.5 rounded transition">MAX</button>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <input type="number" step="0.001" id="amountIn" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none text-gray-800">
                                    <div id="usdValueIn" class="text-xs text-gray-500 mt-1">$0.00</div>
                                </div>
                                <select id="tokenIn" class="bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-orange-300 rounded-lg px-3 py-2 font-bold hover:border-orange-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[120px]">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <input type="text" id="customTokenIn" placeholder="Paste token address (0x...)" class="hidden w-full mt-2 px-2 py-1 border border-orange-200 rounded text-xs">
                        </div>

                        <div class="flex justify-center -my-1 relative z-10">
                            <button id="swapArrow" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white rounded-lg p-2 shadow-lg transition transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="bg-white border-2 border-green-300 rounded-xl p-3 shadow-md transition-colors duration-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-green-700">To (estimated)</label>
                                <div id="priceLoading" class="hidden text-xs text-orange-600 font-semibold">Fetching...</div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <div class="text-2xl font-bold text-gray-800" id="estimatedAmount">0.0</div>
                                    <div id="usdValueOut" class="text-xs text-gray-500 mt-1">$0.00</div>
                                </div>
                                <input type="number" step="0.001" id="minAmountOut" placeholder="0.0" class="hidden">
                                <select id="tokenOut" class="bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold hover:border-green-400 transition cursor-pointer w-full sm:w-auto sm:flex-shrink-0 sm:min-w-[120px]">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <input type="text" id="customTokenOut" placeholder="Paste token address (0x...)" class="hidden w-full mt-2 px-2 py-1 border border-green-200 rounded text-xs">
                            <div id="priceInfo" class="mt-2 space-y-1 text-xs hidden bg-green-50 p-2 rounded border border-green-200">
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Rate:</span>
                                    <span id="exchangeRate" class="font-bold">-</span>
                                </div>
                                <div class="flex justify-between text-green-800">
                                    <span class="font-semibold">Min (<span id="slippageDisplay">5</span>% slippage) <button id="editSlippageBtn" class="text-orange-600 hover:text-orange-700">‚öôÔ∏è</button>:</span>
                                    <span id="minReceived" class="font-bold">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3 shadow-md transition-colors duration-300">
                            <h3 class="font-bold text-orange-800 mb-2 text-sm">‚è∞ Execution Time</h3>
                            <div class="space-y-2 mb-2">
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg hover:bg-yellow-50 transition border border-yellow-200">
                                    <input type="radio" name="timeOption" value="now" id="timeNow" checked class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Swap Now ‚ö°</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg hover:bg-yellow-50 transition border border-yellow-200">
                                    <input type="radio" name="timeOption" value="scheduled" id="timeScheduled" class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Schedule for Later üìÖ</span>
                                </label>
                            </div>
                            <div id="scheduledTimeInputs" class="grid grid-cols-2 gap-2 hidden">
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">Date</label>
                                    <input type="date" id="executionDate" class="w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm font-semibold">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-orange-700 mb-1">Time</label>
                                    <input type="time" id="executionTime" class="w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm font-semibold">
                                </div>
                            </div>
                            <p id="instantTimeNote" class="text-xs text-orange-800 mt-2">‚ú® Swap executes immediately</p>
                            <p id="scheduledTimeNote" class="text-xs text-orange-800 mt-2 hidden">üìÖ Swap will execute automatically at scheduled time</p>
                        </div>

                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg p-3 border border-green-300 transition-colors duration-300">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-800 font-semibold">Platform Fee</span>
                                <span class="font-bold text-green-900">0.5%</span>
                            </div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-800 font-semibold">Network Fee</span>
                                <span class="font-bold text-green-900">0.3%</span>
                            </div>
                            <div class="flex justify-between text-xs pt-1 border-t border-green-300">
                                <span class="font-bold text-green-900">Total Fee</span>
                                <span class="font-bold text-orange-600">~0.8%</span>
                            </div>
                        </div>

                        <button id="scheduleSwapBtn" class="w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 hover:from-orange-600 hover:via-yellow-600 hover:to-green-600 text-white font-black py-3 rounded-xl transition shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btnText">üîó Connect Wallet to Swap</span>
                        </button>
                        
                        <!-- Approval Flow Indicator -->
                        <div id="approvalIndicator" class="hidden mt-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div id="step1" class="flex items-center gap-1">
                                        <div class="w-6 h-6 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">1</div>
                                        <span class="font-semibold text-blue-900 text-xs">Approve</span>
                                    </div>
                                    <div class="text-blue-400 text-xs">‚Üí</div>
                                    <div id="step2" class="flex items-center gap-1 opacity-50">
                                        <div class="w-6 h-6 rounded-full bg-gray-300 text-white flex items-center justify-center font-bold text-xs">2</div>
                                        <span class="font-semibold text-gray-600 text-xs">Swap</span>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-blue-800">üí° First time? Approve token once.</p>
                        </div>
                    </div>
                </div>

                <div id="swapsContent" class="p-4 hidden transition-colors duration-300">
                    <!-- Stats Bar on My Swaps Page -->
                    <div class="flex justify-end gap-3 mb-4 text-xs">
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-orange-200">
                            <span class="text-gray-600">Total:</span>
                            <span id="totalSwaps" class="font-bold text-orange-600 ml-1">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-yellow-200">
                            <span class="text-gray-600">Scheduled:</span>
                            <span id="scheduledCount" class="font-bold text-yellow-600 ml-1">0</span>
                        </div>
                        <div class="bg-white rounded-lg shadow px-3 py-1 border border-green-200">
                            <span class="text-gray-600">Executed:</span>
                            <span id="executedCount" class="font-bold text-green-600 ml-1">0</span>
                        </div>
                        <div id="ownerStats" class="bg-white rounded-lg shadow px-3 py-1 border border-emerald-200 hidden">
                            <button id="withdrawBtn" class="text-xs bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-2 py-1 rounded font-bold transition" style="display:none;">üí∞ Withdraw</button>
                        </div>
                    </div>
                    
                    <div id="swapsList"></div>
                </div>
                <!-- LIMIT ORDER TAB -->
<div id="limitContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 transition-colors duration-300 hidden">
    <div class="max-w-md mx-auto space-y-3">
        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-300 rounded-xl p-3 mb-3">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üéØ</span>
                <div>
                    <h3 class="font-bold text-orange-900 text-sm">Limit Order</h3>
                    <p class="text-xs text-orange-700">Set your target price, execute automatically</p>
                </div>
            </div>
        </div>

        <div class="bg-white border-2 border-orange-300 rounded-xl p-3 shadow-md">
            <label class="text-xs font-bold text-orange-700 mb-2 block">You Pay</label>
            <div class="flex flex-col gap-2">
                <input type="number" step="0.001" id="amountInLimit" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none">
                <select id="tokenInLimit" class="w-full bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-orange-300 rounded-lg px-3 py-2 font-bold">
                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                </select>
            </div>
        </div>

        <div class="flex justify-center -my-1 relative z-10">
            <button id="swapArrowLimit" class="bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white rounded-lg p-2 shadow-lg transition transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                </svg>
            </button>
        </div>

        <div class="bg-white border-2 border-green-300 rounded-xl p-3 shadow-md">
            <label class="text-xs font-bold text-green-700 mb-2 block">You Receive</label>
            <select id="tokenOutLimit" class="w-full bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold">
                <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                <option value="0x0000000000000000000000000000000000000000">ETH</option>
                <option value="0x4200000000000000000000000000000000000006">WETH</option>
                <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
            </select>
        </div>

        <!-- Current Market Price Display -->
        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-blue-800">üìä Current Market Price</span>
                <button id="refreshPriceBtn" class="text-blue-600 hover:text-blue-800 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
            <div id="currentMarketPrice" class="text-center">
                <div class="text-xs text-blue-600 mb-1">
                    1 <span id="marketTokenIn">ETH</span> 
                    <span class="text-blue-400" id="marketTokenInFull">(Ethereum)</span> =
                </div>
                <div class="text-2xl font-bold text-blue-900" id="marketPriceValue">Loading...</div>
                <div class="text-xs text-blue-600 mb-1">
                    <span id="marketTokenOut">USDC</span>
                    <span class="text-blue-400" id="marketTokenOutFull">(USD Coin)</span>
                </div>
                <div class="text-xs text-blue-500 mt-1" id="marketPriceUSD"></div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3">
            <h3 class="font-bold text-orange-800 mb-2 text-sm">üéØ Target Price</h3>
            <div class="flex items-center gap-1 sm:gap-2 mb-2 flex-wrap sm:flex-nowrap">
                <span class="text-xs font-semibold text-orange-700 whitespace-nowrap">When 1</span>
                <span id="targetTokenIn" class="text-xs font-bold text-orange-900 whitespace-nowrap">ETH</span>
                <span id="targetTokenInFull" class="text-xs text-orange-500"></span>
                <span class="text-xs font-semibold text-orange-700">=</span>
                <input type="number" step="0.000001" id="targetPrice" placeholder="0.0" class="flex-1 min-w-0 px-2 sm:px-3 py-2 border-2 border-yellow-200 rounded-lg font-bold text-center text-sm sm:text-base">
                <span id="targetTokenOut" class="text-xs font-bold text-orange-900 whitespace-nowrap">USDC</span>
                <span id="targetTokenOutFull" class="text-xs text-orange-500"></span>
            </div>
            
            <!-- Your Order Rate Display -->
            <div id="orderRateInfo" class="bg-white border-2 border-orange-200 rounded-lg p-2 mb-2 hidden">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold text-gray-700">Your Order Rate:</span>
                    <span class="text-xs font-bold text-orange-900" id="orderRateValue">-</span>
                </div>
                <div id="priceDifference" class="text-xs text-center mt-1 font-semibold">-</div>
            </div>
            
            <p class="text-xs text-orange-700 bg-yellow-100 p-2 rounded mb-2">üí° Order executes automatically when market reaches your target price</p>
            
            <!-- Expiration Options -->
            <div class="mt-3">
                <label class="text-xs font-bold text-orange-800 mb-2 block">‚è∞ Order Expiration</label>
                <select id="expirationSelect" class="w-full bg-white border-2 border-yellow-200 rounded-lg px-3 py-2 text-sm font-semibold">
                    <option value="0">Never (Good til Cancelled)</option>
                    <option value="600">10 Minutes</option>
                    <option value="3600">1 Hour</option>
                    <option value="86400">1 Day</option>
                    <option value="259200">3 Days</option>
                    <option value="604800">7 Days</option>
                    <option value="custom">Custom...</option>
                </select>
                <div id="customExpirationInput" class="mt-2 hidden">
                    <label class="text-xs text-orange-700 block mb-1">Custom Expiration (hours):</label>
                    <input type="number" id="customExpirationHours" min="1" max="720" placeholder="Hours" class="w-full px-3 py-2 border-2 border-yellow-200 rounded-lg text-sm">
                </div>
                <div id="expirationPreview" class="text-xs text-orange-600 mt-1 hidden"></div>
            </div>
        </div>

        <button id="createLimitBtn" class="w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-orange-500 hover:from-orange-600 hover:via-yellow-600 hover:to-orange-600 text-white font-black py-3 rounded-xl transition shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="limitBtnText">üîó Connect Wallet</span>
        </button>
    </div>
</div>
            </div>
        </div>

        <!-- Security Info Banner -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-md p-3 mt-6 border-2 border-green-300">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üîí</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Smart Contract</div>
                            <a href="https://basescan.org/address/0x33b9AFAD31861DE0b83F651eFe92E0461c807011" target="_blank" rel="noopener noreferrer" class="font-mono text-xs text-green-700 hover:text-green-900 hover:underline">
                                0x33b9...7011
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">‚úÖ</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Verified Contract</div>
                            <div class="text-xs text-green-700">View on Basescan</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xl">üìä</span>
                        <div>
                            <div class="text-xs font-semibold text-green-800">Total Swaps</div>
                            <div class="text-xs text-green-700" id="totalSwapsHeader">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0x33b9AFAD31861DE0b83F651eFe92E0461c807011'; // MangoSwap V2 - Secure
        const BASE_CHAIN_ID = '0x2105';
        const ABI = [
    "function instantSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut) external payable returns (uint256)",
    "function scheduleSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut, uint256 executionTime) external payable returns (uint256)",
    "function createLimitOrder(address tokenIn, address tokenOut, uint256 amountIn, uint256 targetPrice, uint256 expiryTime) external payable returns (uint256)",
    "function executeScheduledSwap(uint256 swapId) external",
    "function executeLimitOrder(uint256 orderId) external",
    "function cancelSwap(uint256 swapId) external",
    "function cancelLimitOrder(uint256 orderId) external",
    "function getCurrentPrice(address tokenIn, address tokenOut, uint256 amountIn) external view returns (uint256)",
    "function getSwap(uint256 swapId) external view returns (tuple(uint256 id, address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut, uint256 executionTime, uint8 status, uint256 executedAt, uint256 amountOut, uint8 orderType))",
    "function getLimitOrder(uint256 orderId) external view returns (tuple(uint256 id, address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 targetPrice, uint256 expiryTime, uint8 status, uint256 createdAt, uint256 executedAt, uint256 amountOut))",
    "function getUserSwaps(address user) external view returns (uint256[])",
    "function getUserLimitOrders(address user) external view returns (uint256[])",
    "function getTotalSwaps() external view returns (uint256)",
    "function getTotalLimitOrders() external view returns (uint256)",
    "function updatePlatformFee(uint256 newFee) external",
    "function withdrawFees() external",
    "function owner() external view returns (address)",
    "function platformFee() external view returns (uint256)"
];

        const TOKENS = {'0x0000000000000000000000000000000000000000':'ETH','0x4200000000000000000000000000000000000006':'WETH','0x833589fcd6edb6e08f4c7c32d4f71b54bda02913':'USDC','0x50c5725949a6f0c72e6c4a641f24049a917db0cb':'DAI','0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf':'cbBTC','0x532f27101965dd16442e59d40670faf5ebb142e4':'BRETT','0x940181a94a35a4569e4529a3cdfb74e38fd98631':'AERO','0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4':'TOSHI','0x4ed4e862860bed51a9570b96d89af5e1b0efefed':'DEGEN','0xa88594d404727625a9437c3f886c7643872296ae':'WELL','0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b':'VIRTUAL','0x78a087d713be963bf307b18f2ff8122ef9a63ae9':'ZORA','0x58d97b57bb95320f9a05dc918aef65434969c2b2':'MORPHO'};

        // CoinGecko token ID mapping for accurate market prices
        const COINGECKO_IDS = {
            '0x0000000000000000000000000000000000000000': 'ethereum',
            '0x4200000000000000000000000000000000000006': 'ethereum',
            '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913': 'usd-coin',
            '0x50c5725949a6f0c72e6c4a641f24049a917db0cb': 'dai',
            '0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf': 'bitcoin',
            '0x532f27101965dd16442e59d40670faf5ebb142e4': 'based-brett',
            '0x940181a94a35a4569e4529a3cdfb74e38fd98631': 'aerodrome-finance',
            '0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4': 'toshi-base',
            '0x4ed4e862860bed51a9570b96d89af5e1b0efefed': 'degen-base',
            '0xa88594d404727625a9437c3f886c7643872296ae': 'well',
            '0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b': 'virtual-protocol',
            '0x78a087d713be963bf307b18f2ff8122ef9a63ae9': 'zora',
            '0x58d97b57bb95320f9a05dc918aef65434969c2b2': 'morpho'
        };

        // Full token names for clarity
        const TOKEN_NAMES = {
            '0x0000000000000000000000000000000000000000': 'Ethereum',
            '0x4200000000000000000000000000000000000006': 'Wrapped Ether',
            '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913': 'USD Coin',
            '0x50c5725949a6f0c72e6c4a641f24049a917db0cb': 'Dai Stablecoin',
            '0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf': 'Coinbase Wrapped BTC',
            '0x532f27101965dd16442e59d40670faf5ebb142e4': 'Brett',
            '0x940181a94a35a4569e4529a3cdfb74e38fd98631': 'Aerodrome Finance',
            '0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4': 'Toshi',
            '0x4ed4e862860bed51a9570b96d89af5e1b0efefed': 'Degen',
            '0xa88594d404727625a9437c3f886c7643872296ae': 'Moonwell',
            '0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b': 'Virtual Protocol',
            '0x78a087d713be963bf307b18f2ff8122ef9a63ae9': 'Zora',
            '0x58d97b57bb95320f9a05dc918aef65434969c2b2': 'Morpho'
        };

        const WETH = '0x4200000000000000000000000000000000000006';
        let provider, signer, contract, account, isOwner = false;
        let quoteTimeout;
        let selectedWallet = null;
        let isConnected = false;
        
        // Settings state
        let slippageTolerance = 5;
        let userBalanceFrom = 0;
        let currentPriceUSD = 0;

        // ERC20 ABI for balance and approval
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) returns (bool)"
        ];

        // Load saved settings
        function loadSettings() {
            const savedSlippage = localStorage.getItem('mangoswap_slippage') || '5';
            slippageTolerance = parseFloat(savedSlippage);
            updateSlippageUI();
        }

        // Update slippage UI
        function updateSlippageUI() {
            document.querySelectorAll('.slippage-btn').forEach(btn => {
                const value = parseFloat(btn.dataset.value);
                if (value === slippageTolerance) {
                    btn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.remove('border-orange-200');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.add('border-orange-200');
                }
            });
            document.getElementById('slippageDisplay').textContent = slippageTolerance;
            localStorage.setItem('mangoswap_slippage', slippageTolerance.toString());
        }

        // Initialize settings
        loadSettings();
        
        // Disable button initially
        document.getElementById('scheduleSwapBtn').disabled = true;
        document.getElementById('createLimitBtn').disabled = true;

        // Function to update all button states when wallet connects/disconnects
        function updateButtonStates() {
            if (isConnected) {
                document.getElementById('scheduleSwapBtn').disabled = false;
                document.getElementById('btnText').textContent = 'ü•≠ Schedule Swap üå¥';
                document.getElementById('createLimitBtn').disabled = false;
                document.getElementById('limitBtnText').textContent = 'üéØ Create Limit Order';
            } else {
                document.getElementById('scheduleSwapBtn').disabled = true;
                document.getElementById('btnText').textContent = 'üîó Connect Wallet to Swap';
                document.getElementById('createLimitBtn').disabled = true;
                document.getElementById('limitBtnText').textContent = 'üîó Connect Wallet';
            }
        }

        // Function to update target price labels
        function updateTargetPriceLabels() {
            const tokenInLimit = document.getElementById('tokenInLimit').value;
            const tokenOutLimit = document.getElementById('tokenOutLimit').value;
            
            const tokenInName = TOKENS[tokenInLimit.toLowerCase()] || 'Token';
            const tokenOutName = TOKENS[tokenOutLimit.toLowerCase()] || 'Token';
            const tokenInFullName = TOKEN_NAMES[tokenInLimit.toLowerCase()] || '';
            const tokenOutFullName = TOKEN_NAMES[tokenOutLimit.toLowerCase()] || '';
            
            document.getElementById('targetTokenIn').textContent = tokenInName;
            document.getElementById('targetTokenOut').textContent = tokenOutName;
            document.getElementById('targetTokenInFull').textContent = tokenInFullName ? `(${tokenInFullName})` : '';
            document.getElementById('targetTokenOutFull').textContent = tokenOutFullName ? `(${tokenOutFullName})` : '';
        }

        // Edit slippage button
        document.getElementById('editSlippageBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('hidden');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        // Slippage buttons
        document.querySelectorAll('.slippage-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                slippageTolerance = parseFloat(btn.dataset.value);
                updateSlippageUI();
                getQuote();
            });
        });

        // Custom slippage input
        document.getElementById('customSlippage').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value && value > 0 && value <= 50) {
                slippageTolerance = value;
                updateSlippageUI();
                getQuote();
            }
        });

        document.getElementById('connectBtn').addEventListener('click', showWalletModal);
        document.getElementById('closeModal').addEventListener('click', hideWalletModal);
        document.getElementById('connectMetaMask').addEventListener('click', () => connectWallet('metamask'));
        document.getElementById('connectCoinbase').addEventListener('click', () => connectWallet('coinbase'));
        document.getElementById('connectPhantom').addEventListener('click', () => connectWallet('phantom'));
        document.getElementById('scheduleTab').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('swapsTab').addEventListener('click', () => switchTab('swaps'));
        document.getElementById('limitTab').addEventListener('click', () => switchTab('limit'));
        document.getElementById('createLimitBtn').addEventListener('click', createLimitOrder);
        document.getElementById('scheduleSwapBtn').addEventListener('click', scheduleSwap);
        
        // Update target price labels when limit order tokens change
        document.getElementById('tokenInLimit').addEventListener('change', updateTargetPriceLabels);
        document.getElementById('tokenOutLimit').addEventListener('change', updateTargetPriceLabels);
        
        document.getElementById('amountIn').addEventListener('input', debounceQuote);
        document.getElementById('tokenIn').addEventListener('change', () => {
            getQuote();
            if (isConnected) updateBalance();
        });
        document.getElementById('tokenOut').addEventListener('change', getQuote);
        
        document.getElementById('maxBtn').addEventListener('click', () => {
            if (!isConnected) {
                alert('Please connect your wallet first');
                return;
            }
            document.getElementById('amountIn').value = userBalanceFrom;
            getQuote();
        });
        
        document.getElementById('swapArrow').addEventListener('click', function() {
            const tokenInSelect = document.getElementById('tokenIn');
            const tokenOutSelect = document.getElementById('tokenOut');
            const tempValue = tokenInSelect.value;
            tokenInSelect.value = tokenOutSelect.value;
            tokenOutSelect.value = tempValue;
            getQuote();
        });
        
        document.getElementById('tokenIn').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customTokenIn').classList.remove('hidden');
            } else {
                document.getElementById('customTokenIn').classList.add('hidden');
            }
        });
        
        document.getElementById('tokenOut').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customTokenOut').classList.remove('hidden');
            } else {
                document.getElementById('customTokenOut').classList.add('hidden');
            }
        });
        
        document.getElementById('timeNow').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.add('hidden');
                document.getElementById('scheduledTimeNote').classList.add('hidden');
                document.getElementById('instantTimeNote').classList.remove('hidden');
            }
        });
        
        document.getElementById('timeScheduled').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('scheduledTimeInputs').classList.remove('hidden');
                document.getElementById('scheduledTimeNote').classList.remove('hidden');
                document.getElementById('instantTimeNote').classList.add('hidden');
            }
        });

        function showWalletModal() {
            document.getElementById('walletModal').classList.remove('hidden');
        }

        function hideWalletModal() {
            document.getElementById('walletModal').classList.add('hidden');
        }

        async function connectWallet(walletType) {
            console.log('Attempting to connect:', walletType);
            selectedWallet = walletType;
            hideWalletModal();

            let ethereum;
            
            if (walletType === 'phantom') {
                if (window.phantom?.ethereum) {
                    ethereum = window.phantom.ethereum;
                } else {
                    alert('Phantom wallet not installed! Visit phantom.app to install.');
                    return;
                }
            } else {
                console.log('window.ethereum exists:', !!window.ethereum);
                
                if (!window.ethereum) {
                    alert('No wallet detected! Please install MetaMask from metamask.io');
                    return;
                }
                
                ethereum = window.ethereum;
                console.log('Using ethereum provider:', ethereum);
            }

            if (!ethereum) {
                alert('Wallet provider not found!');
                return;
            }
            
            try {
                console.log('Requesting accounts...');
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                console.log('Accounts received:', accounts);
                
                console.log('Checking chain ID...');
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId, 'Expected:', BASE_CHAIN_ID);
                
                if (chainId !== BASE_CHAIN_ID) {
                    console.log('Wrong network, switching to Base...');
                    try {
                        await ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        console.log('Switch error:', switchError);
                        if (switchError.code === 4902) {
                            console.log('Network not added, adding Base network...');
                            await ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                
                account = accounts[0];
                console.log('Connected account:', account);
                
                provider = new ethers.providers.Web3Provider(ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                isConnected = true;
                
                console.log('Provider initialized');
                
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('accountInfo').classList.remove('hidden');
                document.getElementById('accountAddress').textContent = account.slice(0, 6) + '...' + account.slice(-4);
                document.getElementById('balanceSection').style.display = 'block';
                
                // Update all button states
                updateButtonStates();
                
                console.log('Checking if owner...');
                const owner = await contract.owner();
                isOwner = owner.toLowerCase() === account.toLowerCase();
                if (isOwner) {
                    document.getElementById('ownerStats').classList.remove('hidden');
                    document.getElementById('withdrawBtn').style.display = 'block';
                }
                
                console.log('Loading data...');
                loadData();
                updateBalance();
                console.log('Connection complete!');
            } catch (e) {
                console.error('Connection error details:', e);
                alert('Failed to connect: ' + e.message + '\n\nCheck browser console (F12) for details.');
            }
        }

        async function loadData() {
            try {
                const total = await contract.getTotalSwaps();
                document.getElementById('totalSwaps').textContent = total.toString();
                document.getElementById('totalSwapsHeader').textContent = total.toString() + ' completed';
                
                const ids = await contract.getUserSwaps(account);
                const swaps = await Promise.all(ids.map(async id => {
                    const s = await contract.getSwap(id);
                    return {
                        id: s[0].toString(),
                        user: s[1],
                        tokenIn: s[2],
                        tokenOut: s[3],
                        amountIn: ethers.utils.formatEther(s[4]),
                        minAmountOut: ethers.utils.formatEther(s[5]),
                        executionTime: new Date(s[6].toNumber() * 1000),
                        status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][s[7]],
                        executedAt: s[8].toNumber(),
                        amountOut: ethers.utils.formatEther(s[9])
                    };
                }));
                
                const limitIds = await contract.getUserLimitOrders(account);
                const limitOrders = await Promise.all(limitIds.map(async id => {
                    const lo = await contract.getLimitOrder(id);
                    return {
                        id: lo[0].toString(),
                        tokenIn: lo[2],
                        tokenOut: lo[3],
                        amountIn: ethers.utils.formatEther(lo[4]),
                        targetPrice: ethers.utils.formatEther(lo[5]),
                        status: ['Active', 'Executed', 'Cancelled', 'Failed'][lo[7]],
                        createdAt: new Date(lo[8].toNumber() * 1000),
                        type: 'limit'
                    };
                }));

                const allOrders = [...swaps, ...limitOrders];

                const scheduled = swaps.filter(s => s.status === 'Scheduled').length;
                const executed = swaps.filter(s => s.status === 'Executed').length;
                document.getElementById('scheduledCount').textContent = scheduled;
                document.getElementById('executedCount').textContent = executed;
                displaySwaps(allOrders);
            } catch (e) {
                console.error('Load data error:', e);
            }
        }

        function displaySwaps(orders) {
            const list = document.getElementById('swapsList');
            if (orders.length === 0) {
                list.innerHTML = '<div class="text-center py-12 text-gray-500"><p>No orders yet!</p></div>';
                return;
            }
            list.innerHTML = orders.map(s => {
                const tokenInName = TOKENS[s.tokenIn.toLowerCase()] || s.tokenIn.slice(0, 6) + '...';
                const tokenOutName = TOKENS[s.tokenOut.toLowerCase()] || s.tokenOut.slice(0, 6) + '...';
                
                if (s.type === 'limit') {
                    return `
                    <div class="border-2 border-indigo-200 rounded-xl p-6 mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 shadow-lg">
                        <div class="flex justify-between items-start mb-4">
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${s.status === 'Active' ? 'bg-indigo-100 text-indigo-800' : s.status === 'Executed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">üéØ ${s.status} Limit</span>
                            <div class="text-right">
                                <div class="font-bold text-lg">${s.amountIn} ${tokenInName} ‚Üí ${tokenOutName}</div>
                                <div class="text-sm text-indigo-700">Target: 1 ${tokenInName} = ${s.targetPrice} ${tokenOutName}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-3">Created: ${s.createdAt.toLocaleString()}</div>
                        ${s.status === 'Active' ? `<button onclick="cancelLimitOrder(${s.id})" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition">Cancel Order</button>` : ''}
                    </div>
                    `;
                }
                
                return `
                <div class="border-2 border-orange-200 rounded-xl p-6 mb-4 bg-white shadow-lg">
                    <div class="flex justify-between mb-4">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${s.status === 'Scheduled' ? 'bg-yellow-100 text-yellow-800' : s.status === 'Executed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${s.status}</span>
                        <div class="text-right">
                            <div class="font-bold text-lg">${s.amountIn} ${tokenInName} ‚Üí ${tokenOutName}</div>
                            <div class="text-sm text-gray-600">Min: ${s.minAmountOut} ${tokenOutName}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div><span class="text-gray-600">Executes:</span><div class="font-semibold">${s.executionTime.toLocaleString()}</div></div>
                        ${s.status === 'Executed' ? `<div><span class="text-gray-600">Received:</span><div class="font-semibold text-green-600">${s.amountOut} ${tokenOutName}</div></div>` : ''}
                    </div>
                    ${s.status === 'Scheduled' ? `<button onclick="cancelSwap(${s.id})" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 rounded-lg font-bold transition">Cancel Swap</button>` : ''}
                </div>
            `;
            }).join('');
        }

        async function scheduleSwap() {
            if (!isConnected) {
                alert('Please connect your wallet first');
                showWalletModal();
                return;
            }
            
            let tokenIn = document.getElementById('tokenIn').value;
            let tokenOut = document.getElementById('tokenOut').value;
            
            if (tokenIn === 'custom') {
                tokenIn = document.getElementById('customTokenIn').value.trim();
                if (!tokenIn || !tokenIn.startsWith('0x') || tokenIn.length !== 42) {
                    alert('Invalid token address for From Token');
                    return;
                }
            }
            
            if (tokenOut === 'custom') {
                tokenOut = document.getElementById('customTokenOut').value.trim();
                if (!tokenOut || !tokenOut.startsWith('0x') || tokenOut.length !== 42) {
                    alert('Invalid token address for To Token');
                    return;
                }
            }
            
            const amount = document.getElementById('amountIn').value;
            const minOut = document.getElementById('minAmountOut').value;
            
            if (!amount || !minOut) {
                alert('Fill all fields');
                return;
            }
            
            if (parseFloat(amount) > userBalanceFrom && tokenIn !== 'custom') {
                alert(`Insufficient balance. You have ${userBalanceFrom.toFixed(4)} tokens.`);
                return;
            }
            
            if (tokenIn === tokenOut) {
                alert('Select different tokens');
                return;
            }
            
            const isInstant = document.getElementById('timeNow').checked;
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                const minOutWei = ethers.utils.parseEther(minOut);
                
                if (isInstant) {
                    console.log('Executing instant swap...');
                    console.log('Token In:', tokenIn);
                    console.log('Token Out:', tokenOut);
                    console.log('Amount:', amount);
                    console.log('Min Out:', minOut);
                    
                    if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                        console.log('Approving token...');
                        const tokenContract = new ethers.Contract(
                            tokenIn,
                            ['function approve(address spender, uint256 amount) external returns (bool)'],
                            signer
                        );
                        
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                        document.getElementById('btnText').textContent = 'Approving... ‚è≥';
                        document.getElementById('scheduleSwapBtn').disabled = true;
                        await approveTx.wait();
                        console.log('Token approved');
                    }
                    
                    document.getElementById('btnText').textContent = 'Swapping... ‚è≥';
                    document.getElementById('scheduleSwapBtn').disabled = true;
                    
                    const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                        await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, { 
                            value: amountWei,
                            gasLimit: 500000 
                        }) :
                        await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, {
                            gasLimit: 500000
                        });
                    
                    console.log('Transaction sent:', tx.hash);
                    const receipt = await tx.wait();
                    console.log('Transaction confirmed:', receipt);
                    
                    document.getElementById('btnText').textContent = 'ü•≠ Schedule Swap üå¥';
                    document.getElementById('scheduleSwapBtn').disabled = false;
                    
                    alert('‚úÖ Swap executed successfully! Check your wallet for tokens.');
                    
                } else {
                    const date = document.getElementById('executionDate').value;
                    const time = document.getElementById('executionTime').value;
                    if (!date || !time) {
                        alert('Please set execution date and time');
                        return;
                    }
                    const execTime = Math.floor(new Date(date + ' ' + time).getTime() / 1000);
                    
                    if (execTime <= Math.floor(Date.now() / 1000)) {
                        alert('Execution time must be in the future');
                        return;
                    }
                    
                    if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                        console.log('Approving token for scheduled swap...');
                        const tokenContract = new ethers.Contract(
                            tokenIn,
                            ['function approve(address spender, uint256 amount) external returns (bool)'],
                            signer
                        );
                        
                        const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                        document.getElementById('btnText').textContent = 'Approving... ‚è≥';
                        document.getElementById('scheduleSwapBtn').disabled = true;
                        await approveTx.wait();
                        console.log('Token approved');
                    }
                    
                    document.getElementById('btnText').textContent = 'Scheduling... ‚è≥';
                    
                    const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                        await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime, { value: amountWei }) :
                        await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime);
                    
                    await tx.wait();
                    
                    document.getElementById('btnText').textContent = 'ü•≠ Schedule Swap üå¥';
                    document.getElementById('scheduleSwapBtn').disabled = false;
                    
                    alert('üìÖ Swap scheduled! It will execute automatically at the scheduled time.');
                }
                
                document.getElementById('amountIn').value = '';
                document.getElementById('minAmountOut').value = '';
                document.getElementById('executionDate').value = '';
                document.getElementById('executionTime').value = '';
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                
                if (isConnected) {
                    loadData();
                    updateBalance();
                }
            } catch (e) {
                console.error('Swap error:', e);
                console.error('Error details:', e.error);
                console.error('Error data:', e.data);
                
                document.getElementById('btnText').textContent = 'ü•≠ Schedule Swap üå¥';
                document.getElementById('scheduleSwapBtn').disabled = false;
                
                let errorMsg = 'Swap failed: ';
                
                if (e.code === 'INSUFFICIENT_FUNDS') {
                    errorMsg += 'Insufficient funds for gas or swap amount';
                } else if (e.message.includes('user rejected')) {
                    errorMsg += 'Transaction was rejected';
                } else if (e.reason) {
                    errorMsg += e.reason;
                } else if (e.error?.message) {
                    errorMsg += e.error.message;
                } else {
                    errorMsg += e.message || 'Unknown error';
                }
                
                errorMsg += '\n\nCheck browser console (F12) for detailed error logs.';
                
                alert(errorMsg);
            }
        }

        async function cancelSwap(id) {
            try {
                const tx = await contract.cancelSwap(id);
                await tx.wait();
                alert('Cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel swap error:', e);
                alert('Failed: ' + e.message);
            }
        }

        async function cancelLimitOrder(id) {
            try {
                const tx = await contract.cancelLimitOrder(id);
                await tx.wait();
                alert('Limit order cancelled!');
                loadData();
            } catch (e) {
                console.error('Cancel limit order error:', e);
                alert('Failed: ' + e.message);
            }
        }

        function switchTab(tab) {
            if (tab === 'schedule') {
                document.getElementById('scheduleTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.remove('text-gray-600');
                document.getElementById('limitTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('limitTab').classList.add('text-gray-600');
                document.getElementById('swapsTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.add('text-gray-600');
                document.getElementById('scheduleContent').classList.remove('hidden');
                document.getElementById('limitContent').classList.add('hidden');
                document.getElementById('swapsContent').classList.add('hidden');
            } else if (tab === 'limit') {
                document.getElementById('limitTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('limitTab').classList.remove('text-gray-600');
                document.getElementById('scheduleTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.add('text-gray-600');
                document.getElementById('swapsTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.add('text-gray-600');
                document.getElementById('limitContent').classList.remove('hidden');
                document.getElementById('scheduleContent').classList.add('hidden');
                document.getElementById('swapsContent').classList.add('hidden');
            } else {
                document.getElementById('swapsTab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('swapsTab').classList.remove('text-gray-600');
                document.getElementById('scheduleTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('scheduleTab').classList.add('text-gray-600');
                document.getElementById('limitTab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById('limitTab').classList.add('text-gray-600');
                document.getElementById('swapsContent').classList.remove('hidden');
                document.getElementById('scheduleContent').classList.add('hidden');
                document.getElementById('limitContent').classList.add('hidden');
            }
        }
        
        document.getElementById('withdrawBtn')?.addEventListener('click', async () => {
            try {
                const tx = await contract.withdrawFees();
                await tx.wait();
                alert('Fees withdrawn!');
            } catch (e) {
                console.error('Withdraw error:', e);
                alert('Failed: ' + e.message);
            }
        });

        function debounceQuote() {
            clearTimeout(quoteTimeout);
            quoteTimeout = setTimeout(getQuote, 500);
        }

        async function updateBalance() {
            if (!provider || !account) return;
            
            const tokenIn = document.getElementById('tokenIn').value;
            if (tokenIn === 'custom') return;
            
            try {
                let balance;
                if (tokenIn === '0x0000000000000000000000000000000000000000') {
                    balance = await provider.getBalance(account);
                    userBalanceFrom = parseFloat(ethers.utils.formatEther(balance));
                } else {
                    const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, provider);
                    balance = await tokenContract.balanceOf(account);
                    const decimals = await tokenContract.decimals();
                    userBalanceFrom = parseFloat(ethers.utils.formatUnits(balance, decimals));
                }
                
                const tokenName = TOKENS[tokenIn.toLowerCase()] || 'Token';
                document.getElementById('balanceFrom').textContent = `${userBalanceFrom.toFixed(4)} ${tokenName}`;
                
                if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                    document.getElementById('approvalIndicator').classList.remove('hidden');
                } else {
                    document.getElementById('approvalIndicator').classList.add('hidden');
                }
            } catch (e) {
                console.error('Balance fetch error:', e);
                document.getElementById('balanceFrom').textContent = '-';
            }
        }

        async function getQuote() {
            const amountIn = document.getElementById('amountIn').value;
            let tokenIn = document.getElementById('tokenIn').value;
            let tokenOut = document.getElementById('tokenOut').value;

            if (!amountIn || amountIn <= 0 || tokenIn === tokenOut) {
                document.getElementById('estimatedAmount').textContent = '0.0';
                document.getElementById('priceInfo').classList.add('hidden');
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                return;
            }

            if (tokenIn === 'custom') tokenIn = document.getElementById('customTokenIn').value.trim();
            if (tokenOut === 'custom') tokenOut = document.getElementById('customTokenOut').value.trim();
            if (!tokenIn || !tokenOut) return;

            try {
                document.getElementById('priceLoading').classList.remove('hidden');
                document.getElementById('priceInfo').classList.add('hidden');

                const tokenInAddr = tokenIn === '0x0000000000000000000000000000000000000000' ? WETH : tokenIn;
                const tokenOutAddr = tokenOut === '0x0000000000000000000000000000000000000000' ? WETH : tokenOut;

                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenInAddr}`);
                const data = await response.json();
                
                let price = 0;
                if (data && data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    price = parseFloat(pair.priceUsd);
                }

                const response2 = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenOutAddr}`);
                const data2 = await response2.json();
                
                let price2 = 0;
                if (data2 && data2.pairs && data2.pairs.length > 0) {
                    const pair2 = data2.pairs[0];
                    price2 = parseFloat(pair2.priceUsd);
                }

                if (price > 0 && price2 > 0) {
                    const estimated = (parseFloat(amountIn) * price) / price2;
                    const slippageMultiplier = (100 - slippageTolerance) / 100;
                    const minOut = estimated * slippageMultiplier;
                    
                    currentPriceUSD = price;
                    const outputPriceUSD = price2;
                    
                    const usdIn = parseFloat(amountIn) * price;
                    const usdOut = estimated * outputPriceUSD;
                    document.getElementById('usdValueIn').textContent = `${usdIn.toFixed(2)}`;
                    document.getElementById('usdValueOut').textContent = `${usdOut.toFixed(2)}`;
                    
                    document.getElementById('estimatedAmount').textContent = estimated.toFixed(6);
                    document.getElementById('minAmountOut').value = minOut.toFixed(6);
                    
                    const tokenInName = TOKENS[tokenIn.toLowerCase()] || 'Token';
                    const tokenOutName = TOKENS[tokenOut.toLowerCase()] || 'Token';
                    const rate = (estimated / parseFloat(amountIn)).toFixed(6);
                    
                    document.getElementById('exchangeRate').textContent = `1 ${tokenInName} = ${rate} ${tokenOutName}`;
                    document.getElementById('minReceived').textContent = `${minOut.toFixed(6)} ${tokenOutName}`;
                    document.getElementById('priceInfo').classList.remove('hidden');
                } else {
                    document.getElementById('estimatedAmount').textContent = '0.0';
                    document.getElementById('usdValueIn').textContent = '$0.00';
                    document.getElementById('usdValueOut').textContent = '$0.00';
                }

                document.getElementById('priceLoading').classList.add('hidden');
            } catch (error) {
                console.error('Price fetch error:', error);
                document.getElementById('estimatedAmount').textContent = '~';
                document.getElementById('priceLoading').classList.add('hidden');
            }
        }

        // Market Price and Limit Order Features
        let currentMarketPriceValue = 0;

        async function updateMarketPrice() {
            const tokenIn = document.getElementById('tokenInLimit').value;
            const tokenOut = document.getElementById('tokenOutLimit').value;
            
            const tokenInName = TOKENS[tokenIn.toLowerCase()] || 'Token';
            const tokenOutName = TOKENS[tokenOut.toLowerCase()] || 'Token';
            const tokenInFullName = TOKEN_NAMES[tokenIn.toLowerCase()] || '';
            const tokenOutFullName = TOKEN_NAMES[tokenOut.toLowerCase()] || '';
            
            document.getElementById('marketTokenIn').textContent = tokenInName;
            document.getElementById('marketTokenOut').textContent = tokenOutName;
            document.getElementById('marketTokenInFull').textContent = tokenInFullName ? `(${tokenInFullName})` : '';
            document.getElementById('marketTokenOutFull').textContent = tokenOutFullName ? `(${tokenOutFullName})` : '';
            document.getElementById('marketPriceValue').textContent = 'Loading...';
            document.getElementById('marketPriceUSD').textContent = '';
            
            try {
                // Get CoinGecko IDs for both tokens
                const coinGeckoIdIn = COINGECKO_IDS[tokenIn.toLowerCase()];
                const coinGeckoIdOut = COINGECKO_IDS[tokenOut.toLowerCase()];
                
                if (!coinGeckoIdIn || !coinGeckoIdOut) {
                    throw new Error('Token not in CoinGecko mapping');
                }
                
                // Fetch prices from CoinGecko using contract addresses for Base tokens
                // This ensures we get Base-specific prices
                const response = await fetch(
                    `https://api.coingecko.com/api/v3/simple/token_price/base?contract_addresses=${tokenIn},${tokenOut}&vs_currencies=usd`
                );
                
                if (!response.ok) {
                    throw new Error('CoinGecko API error');
                }
                
                const data = await response.json();
                
                const priceIn = data[tokenIn.toLowerCase()]?.usd;
                const priceOut = data[tokenOut.toLowerCase()]?.usd;
                
                if (priceIn && priceOut && priceOut > 0) {
                    // Calculate how many tokenOut you get for 1 tokenIn
                    currentMarketPriceValue = priceIn / priceOut;
                    
                    // Format based on size for better readability
                    let displayPrice;
                    if (currentMarketPriceValue >= 1) {
                        displayPrice = currentMarketPriceValue.toFixed(6);
                    } else if (currentMarketPriceValue >= 0.000001) {
                        displayPrice = currentMarketPriceValue.toFixed(8);
                    } else {
                        displayPrice = currentMarketPriceValue.toExponential(4);
                    }
                    
                    document.getElementById('marketPriceValue').textContent = displayPrice;
                    
                    // Also show USD values for context
                    document.getElementById('marketPriceUSD').textContent = `$${priceIn.toFixed(priceIn < 0.01 ? 6 : 2)} / $${priceOut.toFixed(priceOut < 0.01 ? 6 : 2)}`;
                } else {
                    throw new Error('Invalid price data');
                }
            } catch (error) {
                console.error('Failed to get market price:', error);
                
                // Fallback 1: Try DexScreener API (better for Base tokens)
                try {
                    const dexResponse = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenIn}`);
                    const dexData = await dexResponse.json();
                    
                    if (dexData?.pairs && dexData.pairs.length > 0) {
                        const pair = dexData.pairs.find(p => 
                            p.chainId === 'base' && 
                            (p.quoteToken.address.toLowerCase() === tokenOut.toLowerCase() ||
                             p.baseToken.address.toLowerCase() === tokenOut.toLowerCase())
                        );
                        
                        if (pair) {
                            const priceIn = parseFloat(pair.priceUsd);
                            
                            // Get tokenOut price
                            const dexResponse2 = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenOut}`);
                            const dexData2 = await dexResponse2.json();
                            
                            if (dexData2?.pairs && dexData2.pairs.length > 0) {
                                const pair2 = dexData2.pairs.find(p => p.chainId === 'base');
                                const priceOut = pair2 ? parseFloat(pair2.priceUsd) : 1;
                                
                                if (priceIn > 0 && priceOut > 0) {
                                    currentMarketPriceValue = priceIn / priceOut;
                                    
                                    let displayPrice;
                                    if (currentMarketPriceValue >= 1) {
                                        displayPrice = currentMarketPriceValue.toFixed(6);
                                    } else if (currentMarketPriceValue >= 0.000001) {
                                        displayPrice = currentMarketPriceValue.toFixed(8);
                                    } else {
                                        displayPrice = currentMarketPriceValue.toExponential(4);
                                    }
                                    
                                    document.getElementById('marketPriceValue').textContent = displayPrice;
                                    document.getElementById('marketPriceUSD').textContent = `$${priceIn.toFixed(priceIn < 0.01 ? 6 : 2)} / $${priceOut.toFixed(priceOut < 0.01 ? 6 : 2)}`;
                                    return;
                                }
                            }
                        }
                    }
                } catch (dexError) {
                    console.error('DexScreener fallback failed:', dexError);
                }
                
                // Fallback 2: Try contract method
                document.getElementById('marketPriceValue').textContent = 'Error';
                
                try {
                    if (contract) {
                        const amount = ethers.utils.parseEther('1');
                        const price = await contract.getCurrentPrice(tokenIn, tokenOut, amount);
                        const priceFormatted = parseFloat(ethers.utils.formatEther(price));
                        
                        if (priceFormatted > 0) {
                            currentMarketPriceValue = priceFormatted;
                            document.getElementById('marketPriceValue').textContent = priceFormatted.toFixed(6);
                        }
                    }
                } catch (fallbackError) {
                    console.error('Fallback price fetch failed:', fallbackError);
                }
            }
        }

        function updateOrderRateInfo() {
            const targetPrice = parseFloat(document.getElementById('targetPrice').value);
            const tokenInName = TOKENS[document.getElementById('tokenInLimit').value.toLowerCase()] || 'Token';
            const tokenOutName = TOKENS[document.getElementById('tokenOutLimit').value.toLowerCase()] || 'Token';
            
            if (targetPrice > 0 && currentMarketPriceValue > 0) {
                document.getElementById('orderRateInfo').classList.remove('hidden');
                document.getElementById('orderRateValue').textContent = `1 ${tokenInName} = ${targetPrice.toFixed(6)} ${tokenOutName}`;
                
                // Calculate difference
                const difference = ((targetPrice - currentMarketPriceValue) / currentMarketPriceValue) * 100;
                const diffElement = document.getElementById('priceDifference');
                
                if (Math.abs(difference) < 0.1) {
                    diffElement.textContent = '‚âà At Market Price';
                    diffElement.className = 'text-xs text-center mt-1 font-semibold text-gray-600';
                } else if (difference > 0) {
                    diffElement.textContent = `${difference.toFixed(2)}% above market üìà`;
                    diffElement.className = 'text-xs text-center mt-1 font-semibold text-green-600';
                } else {
                    diffElement.textContent = `${Math.abs(difference).toFixed(2)}% below market üìâ`;
                    diffElement.className = 'text-xs text-center mt-1 font-semibold text-red-600';
                }
            } else {
                document.getElementById('orderRateInfo').classList.add('hidden');
            }
        }

        function updateExpirationPreview() {
            const select = document.getElementById('expirationSelect');
            const customInput = document.getElementById('customExpirationInput');
            const preview = document.getElementById('expirationPreview');
            
            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                preview.classList.add('hidden');
            } else {
                customInput.classList.add('hidden');
                
                if (select.value === '0') {
                    preview.classList.add('hidden');
                } else {
                    const seconds = parseInt(select.value);
                    const expiryDate = new Date(Date.now() + seconds * 1000);
                    preview.textContent = `Expires: ${expiryDate.toLocaleString()}`;
                    preview.classList.remove('hidden');
                }
            }
        }

        function getExpirationTime() {
            const select = document.getElementById('expirationSelect');
            
            if (select.value === 'custom') {
                const hours = parseInt(document.getElementById('customExpirationHours').value) || 0;
                if (hours > 0) {
                    return Math.floor(Date.now() / 1000) + (hours * 3600);
                }
                return 0;
            } else if (select.value === '0') {
                return 0; // Never expires
            } else {
                return Math.floor(Date.now() / 1000) + parseInt(select.value);
            }
        }

        // Event listeners for limit order features
        document.getElementById('tokenInLimit').addEventListener('change', () => {
            updateTargetPriceLabels();
            updateMarketPrice();
        });
        
        document.getElementById('tokenOutLimit').addEventListener('change', () => {
            updateTargetPriceLabels();
            updateMarketPrice();
        });
        
        document.getElementById('targetPrice').addEventListener('input', updateOrderRateInfo);
        
        document.getElementById('refreshPriceBtn').addEventListener('click', updateMarketPrice);
        
        document.getElementById('expirationSelect').addEventListener('change', updateExpirationPreview);
        
        document.getElementById('customExpirationHours').addEventListener('input', () => {
            const hours = parseInt(document.getElementById('customExpirationHours').value);
            if (hours > 0) {
                const expiryDate = new Date(Date.now() + hours * 3600000);
                document.getElementById('expirationPreview').textContent = `Expires: ${expiryDate.toLocaleString()}`;
                document.getElementById('expirationPreview').classList.remove('hidden');
            }
        });

        // Update market price when limit tab is opened
        document.getElementById('limitTab').addEventListener('click', () => {
            setTimeout(updateMarketPrice, 500);
        });

        async function createLimitOrder() {
            if (!isConnected) {
                alert('Please connect your wallet first');
                showWalletModal();
                return;
            }
            
            const tokenIn = document.getElementById('tokenInLimit').value;
            const tokenOut = document.getElementById('tokenOutLimit').value;
            const amount = document.getElementById('amountInLimit').value;
            const targetPrice = document.getElementById('targetPrice').value;
            
            if (!amount || !targetPrice) {
                alert('Please fill in all fields');
                return;
            }
            
            if (tokenIn === tokenOut) {
                alert('Please select different tokens');
                return;
            }
            
            try {
                const amountWei = ethers.utils.parseEther(amount);
                const targetPriceWei = ethers.utils.parseEther(targetPrice);
                
                document.getElementById('limitBtnText').textContent = 'Creating...‚è≥';
                document.getElementById('createLimitBtn').disabled = true;
                
                if (tokenIn !== '0x0000000000000000000000000000000000000000') {
                    console.log('Approving token...');
                    const tokenContract = new ethers.Contract(
                        tokenIn,
                        ['function approve(address spender, uint256 amount) external returns (bool)'],
                        signer
                    );
                    
                    const approveTx = await tokenContract.approve(CONTRACT_ADDRESS, amountWei);
                    document.getElementById('limitBtnText').textContent = 'Approving...‚è≥';
                    await approveTx.wait();
                    console.log('Token approved');
                }
                
                document.getElementById('limitBtnText').textContent = 'Creating Order...‚è≥';
                
                const expiryTime = getExpirationTime();
                
                const tx = tokenIn === '0x0000000000000000000000000000000000000000' ?
                    await contract.createLimitOrder(tokenIn, tokenOut, amountWei, targetPriceWei, expiryTime, {
                        value: amountWei,
                        gasLimit: 500000
                    }) :
                    await contract.createLimitOrder(tokenIn, tokenOut, amountWei, targetPriceWei, expiryTime, {
                        gasLimit: 500000
                    });
                
                console.log('Transaction sent:', tx.hash);
                await tx.wait();
                console.log('Limit order created!');
                
                alert('üéØ Limit order created successfully! It will execute automatically when the price reaches your target.');
                
                document.getElementById('amountInLimit').value = '';
                document.getElementById('targetPrice').value = '';
                
                loadData();
            } catch (e) {
                console.error('Limit order error:', e);
                alert('Failed to create limit order: ' + (e.reason || e.message));
            } finally {
                document.getElementById('limitBtnText').textContent = 'üéØ Create Limit Order';
                document.getElementById('createLimitBtn').disabled = false;
            }
        }
    </script>
</body>
</html>


