<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoSwap - Automate Your Trades</title>
    <link rel="icon" type="image/png" href="mango-logo.png">
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/viem@2.21.0/dist/viem.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk@0.1.2/dist/index.umd.js"></script>
    
    <script type="module">
        import { sdk as farcasterSdk } from 'https://esm.sh/@farcaster/miniapp-sdk@0.1.2';
        window.farcasterSdkESM = farcasterSdk;
        if (farcasterSdk && farcasterSdk.actions && farcasterSdk.actions.ready) {
            farcasterSdk.actions.ready().then(() => console.log('‚úÖ ESM ready()')).catch(e => console.error(e));
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <meta property="og:title" content="MangoSwap" />
    <meta property="og:description" content="Automated trading on Base with limit orders and scheduled swaps" />
    <meta property="og:image" content="https://mangoswap.xyz/og-image.png" />
    <meta property="og:url" content="https://mangoswap.xyz" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="MangoSwap" />
    <meta name="twitter:description" content="Automated trading on Base with limit orders and scheduled swaps" />
    <meta name="twitter:image" content="https://mangoswap.xyz/og-image.png" />
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://mangoswap.xyz/preview.png","button":{"title":"Launch MangoSwap","action":{"type":"launch_frame","name":"MangoSwap","url":"https://mangoswap.xyz","splashImageUrl":"https://mangoswap.xyz/splash.png","splashBackgroundColor":"#f18435"}}}' />
    <style>
        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        :root {
            --bg-primary: #fef3c7; --bg-secondary: #ffffff;
            --bg-gradient-start: #fed7aa; --bg-gradient-mid: #fef3c7; --bg-gradient-end: #d9f99d;
            --text-primary: #1f2937; --text-secondary: #4b5563;
            --border-color: #fdba74; --card-bg: #ffffff; --modal-bg: #ffffff; --input-bg: #ffffff;
        }
        body.dark-mode {
            --bg-primary: #006D77; --bg-secondary: #006D77;
            --bg-gradient-start: #006D77; --bg-gradient-mid: #006D77; --bg-gradient-end: #006D77;
            --text-primary: #e5e7eb; --text-secondary: #d1d5db;
            --border-color: #ff8c42; --card-bg: #006D77; --modal-bg: #006D77; --input-bg: #0f3460;
        }
        body.dark-mode #scheduleContent, body.dark-mode #limitContent { background: #006d77 !important; }
        body.dark-mode #scheduleContent label, body.dark-mode #limitContent label { color: #ffffff !important; }
        body.dark-mode select { color: #1f2937 !important; }
        body.dark-mode select option { color: #1f2937 !important; background-color: #fef3c7 !important; }
        body { background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); color: var(--text-primary); min-height: 100vh; }
        .card-bg { background-color: var(--card-bg); }
        .modal-bg { background-color: var(--modal-bg); }
        .input-bg { background-color: var(--input-bg); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-custom { border-color: var(--border-color); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background-color: var(--modal-bg); border-radius: 1rem; padding: 1.5rem; max-width: 28rem; width: 90%; margin: 1rem; border: 4px solid var(--border-color); }
        .spinner { border: 3px solid rgba(255, 140, 66, 0.3); border-top: 3px solid #ff8c42; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button, .touch-target { min-height: 44px; min-width: 44px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        .custom-token-input { transition: border-color 0.3s ease; }
        .custom-token-input.valid { border-color: #86efac !important; }
        .custom-token-input.invalid { border-color: #fca5a5 !important; }
        .custom-token-input.loading { border-color: #fdba74 !important; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeInUp 0.3s ease-in; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        .success-modal-content { animation: slideUp 0.4s ease-out; }
        .confetti { position: absolute; width: 10px; height: 10px; background: #f0f; animation: confettiFall 3s linear forwards; }
        @keyframes confettiFall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .onboarding-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 99999; }
        .onboarding-overlay.hidden { display: none; }
        .onboarding-container { max-width: 340px; width: 85%; background: rgba(255, 140, 66, 0.95); border: 2px solid rgba(255, 107, 53, 0.3); border-radius: 20px; padding: 20px; position: relative; }
        .onboarding-close-btn { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border: none; background: rgba(26, 26, 46, 0.15); border-radius: 50%; color: #1a1a2e; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .onboarding-logo { display: flex; justify-content: center; margin-bottom: 12px; }
        .onboarding-logo img { width: 64px; height: 64px; }
        .onboarding-screen { display: none; text-align: center; color: #1a1a2e; }
        .onboarding-screen.active { display: block; }
        .onboarding-screen h1 { font-size: 28px; margin-bottom: 8px; font-weight: 700; }
        .onboarding-subtitle { font-size: 15px; color: rgba(26, 26, 46, 0.8); margin-bottom: 18px; }
        .onboarding-feature { background: rgba(255, 255, 255, 0.5); border-radius: 12px; padding: 12px; margin-bottom: 10px; text-align: left; }
        .onboarding-feature-content { display: flex; align-items: flex-start; }
        .onboarding-number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: linear-gradient(135deg, #ff6b35, #ff8c42); border-radius: 50%; font-weight: 700; font-size: 12px; margin-right: 10px; }
        .onboarding-feature h3 { font-size: 15px; margin-bottom: 4px; font-weight: 600; }
        .onboarding-feature p { font-size: 13px; color: rgba(26, 26, 46, 0.75); }
        .onboarding-dots { display: flex; justify-content: center; gap: 6px; margin: 16px 0 12px; }
        .onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(26, 26, 46, 0.3); }
        .onboarding-dot.active { background: #1a1a2e; width: 24px; border-radius: 4px; }
        .onboarding-buttons { display: flex; gap: 12px; justify-content: center; }
        .onboarding-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .onboarding-btn-skip { background: rgba(255, 255, 255, 0.6); color: #1a1a2e; }
        .onboarding-btn-next { background: linear-gradient(135deg, #16213e, #1a1a2e); color: white; flex: 1; max-width: 160px; }
    </style>
</head>
<body>
    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingModal">
        <div class="onboarding-container">
            <button class="onboarding-close-btn" onclick="closeOnboarding()">√ó</button>
            <div class="onboarding-logo"><img src="white-outline-mango.png" alt="MangoSwap"></div>
            <div class="onboarding-screen active" data-screen="1">
                <h1>Welcome to MangoSwap</h1>
                <p class="onboarding-subtitle">Trade tokens on Base in seconds</p>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">1</span><div><h3>Select your tokens</h3><p>Choose what you want to swap</p></div></div></div>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">2</span><div><h3>Enter amount</h3><p>Type how much you want to trade</p></div></div></div>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">3</span><div><h3>Swap instantly üîÑ</h3><p>Your trade executes in seconds</p></div></div></div>
                <div class="onboarding-dots"><div class="onboarding-dot active"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div></div>
                <div class="onboarding-buttons"><button class="onboarding-btn onboarding-btn-skip" onclick="closeOnboarding()">Skip</button><button class="onboarding-btn onboarding-btn-next" onclick="nextOnboardingScreen()">Next ‚Üí</button></div>
            </div>
            <div class="onboarding-screen" data-screen="2">
                <h1>Set Your Price</h1>
                <p class="onboarding-subtitle">Buy or sell at exactly the price you want</p>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">1</span><div><h3>Choose your target price üéØ</h3><p>Set the exact price where you want to trade</p></div></div></div>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">2</span><div><h3>Create the limit order</h3><p>Your order waits until the market hits your price</p></div></div></div>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">3</span><div><h3>Automatic execution</h3><p>When the price matches, your trade happens automatically</p></div></div></div>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot active"></div><div class="onboarding-dot"></div></div>
                <div class="onboarding-buttons"><button class="onboarding-btn onboarding-btn-skip" onclick="closeOnboarding()">Skip</button><button class="onboarding-btn onboarding-btn-next" onclick="nextOnboardingScreen()">Next ‚Üí</button></div>
            </div>
            <div class="onboarding-screen" data-screen="3">
                <h1>Schedule Your Trades</h1>
                <p class="onboarding-subtitle">Buy automatically on a regular schedule</p>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">1</span><div><h3>Pick your schedule üìÖ</h3><p>Choose daily, weekly, or monthly</p></div></div></div>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">2</span><div><h3>Set the amount</h3><p>Decide how much to invest each time</p></div></div></div>
                <div class="onboarding-feature"><div class="onboarding-feature-content"><span class="onboarding-number">3</span><div><h3>Sit back and relax</h3><p>Your trades execute automatically</p></div></div></div>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot active"></div></div>
                <div class="onboarding-buttons"><button class="onboarding-btn onboarding-btn-next" style="max-width:100%;" onclick="closeOnboarding()">Get Started ü•≠</button></div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 max-w-3xl">
        <div class="card-bg rounded-xl shadow-lg p-4 mb-4 border-2 border-custom">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-1">
                        <img src="mango-logo.png" alt="MangoSwap" class="w-10 h-10"> 
                        <span class="bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 bg-clip-text text-transparent">MangoSwap</span>
                    </h1>
                    <p class="text-secondary text-sm font-medium">Sweet Swaps on Base üü¶</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="shareBtn" class="touch-target bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-2 rounded-lg font-bold shadow-md" style="display:none;">üì¢</button>
                    <button id="themeToggle" class="touch-target bg-gradient-to-r from-orange-400 to-yellow-400 text-white px-4 py-2 rounded-lg font-bold shadow-md"><span id="themeIcon">üåô</span></button>
                    <button id="connectBtn" class="touch-target bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-5 py-2 rounded-lg font-bold shadow-md">Connect Wallet</button>
                </div>
                
                <!-- Slippage Settings Modal -->
                <div id="settingsModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-primary mb-4">üìä Slippage Settings</h3>
                        <div class="mb-6 p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl border-2 border-custom">
                            <label class="block text-sm font-bold text-primary mb-3">Slippage Tolerance</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold border-2 border-custom" data-value="0.5">0.5%</button>
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold border-2 border-custom" data-value="1">1%</button>
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold bg-orange-500 text-white border-2 border-orange-500" data-value="5">5%</button>
                                <button class="slippage-btn touch-target py-2 px-3 rounded-lg font-semibold border-2 border-custom" data-value="10">10%</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="customSlippage" placeholder="Custom" step="0.1" min="0" max="50" class="flex-1 px-3 py-2 border-2 border-custom rounded-lg font-semibold text-center input-bg text-primary">
                                <span class="font-bold text-primary">%</span>
                            </div>
                        </div>
                        <button id="closeSettings" class="touch-target w-full bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-bold py-3 rounded-xl">Save Settings</button>
                    </div>
                </div>
                
                <!-- Wallet Modal -->
                <div id="walletModal" class="modal-overlay hidden">
                    <div class="modal-content max-w-sm">
                        <h3 class="text-2xl font-bold text-primary mb-4">Connect Wallet</h3>
                        <div class="space-y-3">
                            <button id="connectMetaMask" class="touch-target w-full bg-gradient-to-r from-orange-400 to-yellow-400 text-white font-bold py-3 rounded-xl">ü¶ä MetaMask</button>
                            <button id="connectCoinbase" class="touch-target w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold py-3 rounded-xl">üîµ Base Wallet</button>
                            <button id="connectPhantom" class="touch-target w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-3 rounded-xl">üëª Phantom</button>
                        </div>
                        <button id="closeModal" class="touch-target mt-4 w-full text-secondary font-semibold">Cancel</button>
                    </div>
                </div>
                
                <!-- Success Modal -->
                <div id="successModal" class="modal-overlay hidden">
                    <div class="modal-content max-w-md success-modal-content relative overflow-hidden">
                        <div class="absolute inset-0 pointer-events-none" id="confettiContainer"></div>
                        <div class="text-center relative z-10">
                            <div class="text-6xl mb-4 animate-bounce">üéâ</div>
                            <h3 class="text-2xl font-bold text-primary mb-2">Swap Successful!</h3>
                            <p class="text-secondary mb-4">Your swap has been completed</p>
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border-2 border-green-200">
                                <div class="text-sm text-gray-600 mb-1">You received</div>
                                <div class="text-2xl font-bold text-green-600" id="successAmount">-</div>
                            </div>
                            <button id="basescanLink" class="touch-target block w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold py-3 rounded-xl mb-3">View on Basescan üîç</button>
                            <button id="closeSuccessModal" class="touch-target w-full bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-bold py-3 rounded-xl">Done ü•≠</button>
                        </div>
                    </div>
                </div>
                
                <div id="accountInfo" class="hidden flex items-center gap-2">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="text-right">
                        <div class="text-xs text-secondary">Connected</div>
                        <div id="accountUsername" class="font-semibold text-sm text-primary"><span id="usernameText">User</span><span id="authBadge" class="hidden text-green-500 text-xs">‚úì</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="mainContent">
            <div class="card-bg rounded-xl shadow-xl overflow-hidden border-2 border-custom">
                <div class="flex border-b-2 border-custom">
                    <button id="scheduleTab" class="touch-target flex-1 px-3 py-2 font-bold bg-gradient-to-r from-orange-500 to-yellow-500 text-white text-xs sm:text-sm">Swap</button>
                    <button id="limitTab" class="touch-target flex-1 px-3 py-2 font-bold text-secondary hover:bg-orange-50 text-xs sm:text-sm">Limit Order</button>
                    <button id="swapsTab" class="touch-target flex-1 px-3 py-2 font-bold text-secondary hover:bg-orange-50 text-xs sm:text-sm">My Orders</button>
                </div>

                <!-- SWAP TAB -->
                <div id="scheduleContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50">
                    <div class="max-w-md mx-auto space-y-3">
                        <!-- FROM Token -->
                        <div class="card-bg border-2 border-custom rounded-xl p-3 shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-orange-700">From</label>
                                <div class="text-right" id="balanceSection" style="display:none;">
                                    <div class="text-xs text-secondary">Balance: <span id="balanceFrom" class="font-semibold">-</span></div>
                                    <button id="maxBtn" class="text-xs bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold px-2 py-0.5 rounded">MAX</button>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <input type="number" step="0.001" id="amountIn" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none text-primary">
                                    <div id="usdValueIn" class="text-xs text-secondary mt-1">$0.00</div>
                                </div>
                                <select id="tokenIn" class="touch-target bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-custom rounded-lg px-3 py-2 font-bold cursor-pointer w-full sm:w-auto sm:min-w-[120px]">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom Token...</option>
                                </select>
                            </div>
                            <!-- FIXED: Custom Token Input Container -->
                            <div id="customTokenInContainer" class="hidden mt-3">
                                <input type="text" id="customTokenIn" placeholder="Paste token contract address (0x...)" class="custom-token-input w-full px-3 py-2 border-2 border-custom rounded-lg text-sm input-bg text-primary font-mono">
                                <div id="customTokenInInfo" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Swap Arrow -->
                        <div class="flex justify-center -my-1 relative z-10">
                            <button id="swapArrow" class="touch-target bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-lg p-2 shadow-lg transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                            </button>
                        </div>

                        <!-- TO Token -->
                        <div class="card-bg border-2 border-green-300 rounded-xl p-3 shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-green-700">To (estimated)</label>
                                <div id="priceLoading" class="hidden text-xs text-orange-600 font-semibold flex items-center gap-2"><span class="spinner"></span> Fetching...</div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <div class="flex-1">
                                    <div class="text-2xl font-bold text-primary" id="estimatedAmount">0.0</div>
                                    <div id="usdValueOut" class="text-xs text-secondary mt-1">$0.00</div>
                                </div>
                                <input type="number" step="0.001" id="minAmountOut" placeholder="0.0" class="hidden">
                                <select id="tokenOut" class="touch-target bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold cursor-pointer w-full sm:w-auto sm:min-w-[120px]">
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom Token...</option>
                                </select>
                            </div>
                            <!-- FIXED: Custom Token Input Container -->
                            <div id="customTokenOutContainer" class="hidden mt-3">
                                <input type="text" id="customTokenOut" placeholder="Paste token contract address (0x...)" class="custom-token-input w-full px-3 py-2 border-2 border-green-200 rounded-lg text-sm input-bg text-primary font-mono">
                                <div id="customTokenOutInfo" class="mt-2"></div>
                            </div>
                            <div id="priceInfo" class="mt-2 space-y-1 text-xs hidden bg-green-50 p-2 rounded border border-green-200">
                                <div class="flex justify-between text-green-800"><span class="font-semibold">Rate:</span><span id="exchangeRate" class="font-bold">-</span></div>
                                <div class="flex justify-between text-green-800"><span class="font-semibold">Min (<span id="slippageDisplay">5</span>% slippage) <button id="editSlippageBtn" class="text-orange-600">‚öôÔ∏è</button>:</span><span id="minReceived" class="font-bold">-</span></div>
                            </div>
                        </div>

                        <!-- Execution Time -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3 shadow-md">
                            <h3 class="font-bold text-orange-800 mb-2 text-sm">‚è∞ Execution Time</h3>
                            <div class="space-y-2 mb-2">
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg border border-yellow-200">
                                    <input type="radio" name="timeOption" value="now" id="timeNow" checked class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Swap Now ‚ö°</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg border border-yellow-200">
                                    <input type="radio" name="timeOption" value="scheduled" id="timeScheduled" class="w-4 h-4 text-orange-600">
                                    <span class="font-bold text-gray-800 text-sm">Schedule for Later üìÖ</span>
                                </label>
                            </div>
                            <div id="scheduledTimeInputs" class="grid grid-cols-2 gap-2 hidden">
                                <div><label class="block text-xs font-bold text-orange-700 mb-1">Date</label><input type="date" id="executionDate" class="touch-target w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm input-bg text-primary"></div>
                                <div><label class="block text-xs font-bold text-orange-700 mb-1">Time</label><input type="time" id="executionTime" class="touch-target w-full px-2 py-1 border-2 border-orange-200 rounded-lg text-sm input-bg text-primary"></div>
                            </div>
                            <p id="instantTimeNote" class="text-xs text-orange-800 mt-2">‚ú® Swap executes immediately</p>
                            <p id="scheduledTimeNote" class="text-xs text-orange-800 mt-2 hidden">üìÖ Swap will execute at the time you select</p>
                        </div>

                        <!-- Fee Breakdown -->
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg p-3 border border-green-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-green-800">Fee Breakdown</span>
                                <div class="flex gap-2">
                                    <span id="gasFreeLabel" class="hidden bg-gradient-to-r from-green-500 to-emerald-500 text-white px-2 py-0.5 rounded-full text-xs font-bold">‚ú® GAS FREE</span>
                                    <span id="oneClickLabel" class="hidden bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-2 py-0.5 rounded-full text-xs font-bold">‚ö° ONE-CLICK</span>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-green-800 font-semibold">Platform Fee</span><span class="font-bold text-green-900">0.5%</span></div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-green-800 font-semibold">Network Fee</span><span class="font-bold text-green-900" id="networkFeeText">~0.3%</span></div>
                            <div class="flex justify-between text-xs pt-1 border-t border-green-300"><span class="font-bold text-green-900">Total Fee</span><span class="font-bold text-orange-600" id="totalFeeText">~0.8%</span></div>
                        </div>

                        <button id="scheduleSwapBtn" class="touch-target w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-green-500 text-white font-black py-3 rounded-xl shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btnText">üîó Connect Wallet to Swap</span>
                        </button>
                        
                        <div id="approvalIndicator" class="hidden mt-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-3">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="flex items-center gap-1"><div class="w-6 h-6 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">1</div><span class="font-semibold text-blue-900 text-xs">Approve</span></div>
                                <div class="text-blue-400 text-xs">‚Üí</div>
                                <div class="flex items-center gap-1 opacity-50"><div class="w-6 h-6 rounded-full bg-gray-300 text-white flex items-center justify-center font-bold text-xs">2</div><span class="font-semibold text-gray-600 text-xs">Swap</span></div>
                            </div>
                            <p class="text-xs text-blue-800">üí° First time? Approve token once.</p>
                        </div>
                    </div>
                </div>
                <!-- MY ORDERS TAB -->
                <div id="swapsContent" class="p-4 hidden">
                    <div class="flex justify-end gap-3 mb-4 text-xs flex-wrap">
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom"><span class="text-secondary">Total Swaps:</span><span id="totalSwaps" class="font-bold text-orange-600 ml-1">0</span></div>
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom"><span class="text-secondary">Limit Orders:</span><span id="totalLimitOrders" class="font-bold text-indigo-600 ml-1">0</span></div>
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom"><span class="text-secondary">Scheduled:</span><span id="scheduledCount" class="font-bold text-yellow-600 ml-1">0</span></div>
                        <div class="card-bg rounded-lg shadow px-3 py-1 border border-custom"><span class="text-secondary">Executed:</span><span id="executedCount" class="font-bold text-green-600 ml-1">0</span></div>
                        <div id="ownerStats" class="card-bg rounded-lg shadow px-3 py-1 border border-custom hidden"><button id="withdrawBtn" class="text-xs bg-gradient-to-r from-green-500 to-emerald-500 text-white px-2 py-1 rounded font-bold" style="display:none;">üí∞ Withdraw</button></div>
                    </div>
                    <div id="swapsList"></div>
                </div>

                <!-- LIMIT ORDER TAB -->
                <div id="limitContent" class="p-4 bg-gradient-to-br from-orange-50 to-yellow-50 hidden">
                    <div class="max-w-md mx-auto space-y-3">
                        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-custom rounded-xl p-3 mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üéØ</span>
                                <div><h3 class="font-bold text-orange-900 text-sm">Limit Order</h3><p class="text-xs text-orange-700">Set your target price, execute automatically</p></div>
                            </div>
                        </div>

                        <!-- You Pay -->
                        <div class="card-bg border-2 border-custom rounded-xl p-3 shadow-md">
                            <label class="text-xs font-bold text-orange-700 mb-2 block">You Pay</label>
                            <div class="flex flex-col gap-2">
                                <input type="number" step="0.001" id="amountInLimit" placeholder="0.0" class="w-full text-2xl font-bold bg-transparent border-none outline-none text-primary">
                                <select id="tokenInLimit" class="touch-target w-full bg-gradient-to-r from-orange-100 to-yellow-100 border-2 border-custom rounded-lg px-3 py-2 font-bold">
                                    <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                    <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                    <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                    <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                    <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                    <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                    <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                    <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                    <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                    <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                    <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                    <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                    <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                    <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                    <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                    <option value="custom">Custom Token...</option>
                                </select>
                                <!-- FIXED: Custom Token Input for Limit Order From -->
                                <div id="customTokenInLimitContainer" class="hidden">
                                    <input type="text" id="customTokenInLimit" placeholder="Paste token contract address (0x...)" class="custom-token-input w-full px-3 py-2 border-2 border-custom rounded-lg text-sm input-bg text-primary font-mono">
                                    <div id="customTokenInLimitInfo" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Swap Arrow -->
                        <div class="flex justify-center -my-1 relative z-10">
                            <button id="swapArrowLimit" class="touch-target bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-lg p-2 shadow-lg transform hover:scale-110 hover:rotate-180 duration-300 border-2 border-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                            </button>
                        </div>

                        <!-- You Receive -->
                        <div class="card-bg border-2 border-green-300 rounded-xl p-3 shadow-md">
                            <label class="text-xs font-bold text-green-700 mb-2 block">You Receive</label>
                            <select id="tokenOutLimit" class="touch-target w-full bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg px-3 py-2 font-bold">
                                <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC</option>
                                <option value="0x0000000000000000000000000000000000000000">ETH</option>
                                <option value="0x4200000000000000000000000000000000000006">WETH</option>
                                <option value="0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb">DAI</option>
                                <option value="0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf">cbBTC</option>
                                <option value="0x532f27101965dd16442E59d40670FaF5eBB142E4">BRETT</option>
                                <option value="0x940181a94A35A4569E4529A3CDfB74e38FD98631">AERO</option>
                                <option value="0xAC1Bd2486aAf3B5C0fc3Fd868558b082a531B2B4">TOSHI</option>
                                <option value="0x4ed4E862860beD51a9570b96d89aF5E1B0Efefed">DEGEN</option>
                                <option value="0xA88594D404727625A9437C3f886C7643872296AE">WELL</option>
                                <option value="0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b">VIRTUAL</option>
                                <option value="0x78a087d713Be963Bf307b18F2Ff8122EF9A63ae9">ZORA</option>
                                <option value="0x58D97B57BB95320F9a05dC918Aef65434969c2B2">MORPHO</option>
                                <option value="0x22af33fe49fd1fa80c7149773dde5890d3c76f3b">BANKR</option>
                                <option value="0xb1a03eda10342529bbf8eb700a06c60441fef25d">MIGGLES</option>
                                <option value="custom">Custom Token...</option>
                            </select>
                            <!-- FIXED: Custom Token Input for Limit Order To -->
                            <div id="customTokenOutLimitContainer" class="hidden mt-2">
                                <input type="text" id="customTokenOutLimit" placeholder="Paste token contract address (0x...)" class="custom-token-input w-full px-3 py-2 border-2 border-green-200 rounded-lg text-sm input-bg text-primary font-mono">
                                <div id="customTokenOutLimitInfo" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Current Market Price -->
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-bold text-blue-800">üìä Current Market Price</span>
                                <button id="refreshPriceBtn" class="text-blue-600 hover:text-blue-800 text-xs">üîÑ</button>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-blue-600 mb-1">1 <span id="marketTokenIn">ETH</span> =</div>
                                <div class="text-2xl font-bold text-blue-900" id="marketPriceValue">Loading...</div>
                                <div class="text-xs text-blue-600"><span id="marketTokenOut">USDC</span></div>
                            </div>
                        </div>

                        <!-- Target Price -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-3">
                            <h3 class="font-bold text-orange-800 mb-2 text-sm">üéØ Target Price</h3>
                            <div class="flex items-center gap-1 sm:gap-2 mb-2 flex-wrap sm:flex-nowrap">
                                <span class="text-xs font-semibold text-orange-700">When 1</span>
                                <span id="targetTokenIn" class="text-xs font-bold text-orange-900">ETH</span>
                                <span class="text-xs font-semibold text-orange-700">=</span>
                                <input type="number" step="0.000001" id="targetPrice" placeholder="0.0" class="w-24 sm:w-32 px-2 py-2 border-2 border-yellow-200 rounded-lg font-bold text-center text-sm input-bg text-primary">
                                <span id="targetTokenOut" class="text-xs font-bold text-orange-900">USDC</span>
                            </div>
                            <div id="orderRateInfo" class="card-bg border-2 border-orange-200 rounded-lg p-2 mb-2 hidden">
                                <div class="flex items-center justify-between"><span class="text-xs font-semibold text-secondary">Your Order Rate:</span><span class="text-xs font-bold text-orange-900" id="orderRateValue">-</span></div>
                                <div id="priceDifference" class="text-xs text-center mt-1 font-semibold">-</div>
                            </div>
                            <p class="text-xs text-orange-700 bg-yellow-100 p-2 rounded mb-2">üí° Order executes automatically when market reaches your target price</p>
                            <div class="mt-3">
                                <label class="text-xs font-bold text-orange-800 mb-2 block">‚è∞ Order Expiration</label>
                                <select id="expirationSelect" class="touch-target w-full bg-white border-2 border-yellow-200 rounded-lg px-3 py-2 text-sm font-semibold input-bg text-primary">
                                    <option value="0">Never (Good til Cancelled)</option>
                                    <option value="600">10 Minutes</option>
                                    <option value="3600">1 Hour</option>
                                    <option value="86400">1 Day</option>
                                    <option value="259200">3 Days</option>
                                    <option value="604800">7 Days</option>
                                    <option value="custom">Custom...</option>
                                </select>
                                <div id="customExpirationInput" class="mt-2 hidden">
                                    <label class="text-xs text-orange-700 block mb-1">Custom Expiration (hours):</label>
                                    <input type="number" id="customExpirationHours" min="1" max="720" placeholder="Hours" class="touch-target w-full px-3 py-2 border-2 border-yellow-200 rounded-lg text-sm input-bg text-primary">
                                </div>
                                <div id="expirationPreview" class="text-xs text-orange-600 mt-1 hidden"></div>
                            </div>
                        </div>

                        <button id="createLimitBtn" class="touch-target w-full bg-gradient-to-r from-orange-500 via-yellow-500 to-orange-500 text-white font-black py-3 rounded-xl shadow-xl transform hover:scale-105 border-2 border-white disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="limitBtnText">üîó Connect Wallet</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Info Banner -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-md p-3 mt-6 border-2 border-green-300">
            <div class="flex items-center gap-4 flex-wrap">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üîí</span>
                    <div><div class="text-xs font-semibold text-green-800">Smart Contract V4</div><button id="contractLink" class="font-mono text-xs text-green-700 hover:text-green-900 hover:underline bg-transparent border-none cursor-pointer p-0">0xb81f...4D16</button></div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xl">‚úÖ</span>
                    <div><div class="text-xs font-semibold text-green-800">Verified Contract</div><div class="text-xs text-green-700">View on Basescan</div></div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xl">üìä</span>
                    <div><div class="text-xs font-semibold text-green-800">Total Swaps</div><div class="text-xs text-green-700" id="totalSwapsHeader">Loading...</div></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONTRACT_ADDRESS = '0xb81fea65B45D743AB62a1A2B351f4f92fb1d4D16';
        const BASE_CHAIN_ID = '0x2105';
        const GAS_BUFFER_ETH = 0.001;
        const PAYMASTER_URL = 'https://api.developer.coinbase.com/rpc/v1/base/0XFTXVSOwf0H30PN84h07BmJgiJhNtRw';
        const WETH = '0x4200000000000000000000000000000000000006';

        // Token registry - dynamically updated with custom tokens
        const TOKENS = {
            '0x0000000000000000000000000000000000000000': 'ETH',
            '0x4200000000000000000000000000000000000006': 'WETH',
            '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913': 'USDC',
            '0x50c5725949a6f0c72e6c4a641f24049a917db0cb': 'DAI',
            '0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf': 'cbBTC',
            '0x532f27101965dd16442e59d40670faf5ebb142e4': 'BRETT',
            '0x940181a94a35a4569e4529a3cdfb74e38fd98631': 'AERO',
            '0xac1bd2486aaf3b5c0fc3fd868558b082a531b2b4': 'TOSHI',
            '0x4ed4e862860bed51a9570b96d89af5e1b0efefed': 'DEGEN',
            '0xa88594d404727625a9437c3f886c7643872296ae': 'WELL',
            '0x0b3e328455c4059eeb9e3f84b5543f74e24e7e1b': 'VIRTUAL',
            '0x78a087d713be963bf307b18f2ff8122ef9a63ae9': 'ZORA',
            '0x58d97b57bb95320f9a05dc918aef65434969c2b2': 'MORPHO',
            '0x22af33fe49fd1fa80c7149773dde5890d3c76f3b': 'BANKR',
            '0xb1a03eda10342529bbf8eb700a06c60441fef25d': 'MIGGLES'
        };

        // ABI definitions
        const ABI = [
            "function instantSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut) external payable returns (uint256)",
            "function scheduleSwap(address tokenIn, address tokenOut, uint256 amountIn, uint256 minOut, uint256 time) external payable returns (uint256)",
            "function createLimitOrder(address tokenIn, address tokenOut, uint256 amountIn, uint256 price, uint256 expiry) external payable returns (uint256)",
            "function cancelSwap(uint256 swapId) external",
            "function cancelLimitOrder(uint256 orderId) external",
            "function getSwap(uint256 id) external view returns (tuple(address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 minAmountOut, uint256 executionTime, uint8 status, uint256 amountOut))",
            "function getLimitOrder(uint256 id) external view returns (tuple(address user, address tokenIn, address tokenOut, uint256 amountIn, uint256 targetPrice, uint256 expiryTime, uint8 status, uint256 amountOut))",
            "function getUserSwaps(address user) external view returns (uint256[])",
            "function getUserLimitOrders(address user) external view returns (uint256[])",
            "function getTotalSwaps() external view returns (uint256)",
            "function getTotalLimitOrders() external view returns (uint256)",
            "function withdrawFees() external",
            "function owner() external view returns (address)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function name() view returns (string)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) returns (bool)"
        ];

        // ============================================
        // GLOBAL STATE
        // ============================================
        let provider, signer, contract, account, isOwner = false;
        let quoteTimeout, selectedWallet = null, isConnected = false;
        let slippageTolerance = 5, userBalanceFrom = 0, currentPriceUSD = 0, currentMarketPriceValue = 0;
        let sdk = null, miniAppContext = null, isInMiniApp = false;
        let authToken = null, authenticatedUser = null, isAuthenticated = false;
        let baseAccountCapabilities = { atomicBatch: false, paymasterService: false, auxiliaryFunds: false };
        const customTokenCache = {};

        // ============================================
        // CUSTOM TOKEN SYSTEM - KEY FIX
        // ============================================
        
        function isValidAddress(address) {
            return address && /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        async function fetchTokenMetadata(address) {
            if (!isValidAddress(address)) {
                return { valid: false, error: 'Invalid address format. Must be 0x followed by 40 hex characters.' };
            }
            const cacheKey = address.toLowerCase();
            if (customTokenCache[cacheKey]) return customTokenCache[cacheKey];

            try {
                const rpcProvider = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                const tokenContract = new ethers.Contract(address, ERC20_ABI, rpcProvider);
                const [name, symbol, decimals] = await Promise.all([
                    tokenContract.name().catch(() => 'Unknown'),
                    tokenContract.symbol().catch(() => 'UNKNOWN'),
                    tokenContract.decimals().catch(() => 18)
                ]);
                const result = { valid: true, address, name, symbol, decimals };
                customTokenCache[cacheKey] = result;
                TOKENS[cacheKey] = symbol;
                return result;
            } catch (error) {
                console.error('Token metadata fetch error:', error);
                return { valid: false, error: 'Unable to read token contract. Make sure this is a valid ERC20 token on Base.' };
            }
        }

        // KEY FUNCTION: Get actual token address from select + custom input
        function getTokenAddress(selectElement, customInputElement) {
            const selectValue = selectElement.value;
            if (selectValue === 'custom') {
                const customAddress = customInputElement.value.trim();
                return isValidAddress(customAddress) ? customAddress : null;
            }
            return selectValue;
        }

        function getTokenSymbol(address) {
            if (!address) return 'Token';
            return TOKENS[address.toLowerCase()] || address.slice(0, 6) + '...' + address.slice(-4);
        }

        function displayTokenInfo(inputElement, infoContainerId, metadata) {
            const infoContainer = document.getElementById(infoContainerId);
            if (!infoContainer) return;
            infoContainer.innerHTML = '';
            inputElement.classList.remove('valid', 'invalid', 'loading');
            
            if (metadata.valid) {
                inputElement.classList.add('valid');
                infoContainer.innerHTML = `<div class="p-2 bg-green-50 border border-green-300 rounded-lg text-xs animate-fadeIn"><div class="flex items-center gap-2"><span class="text-green-600 font-bold">‚úì Token Found:</span><span class="font-bold text-gray-800">${metadata.symbol}</span></div><div class="text-gray-600 mt-1">${metadata.name}</div></div>`;
            } else {
                inputElement.classList.add('invalid');
                infoContainer.innerHTML = `<div class="p-2 bg-red-50 border border-red-300 rounded-lg text-xs animate-fadeIn"><span class="text-red-600 font-bold">‚úó Error:</span><div class="text-red-700 mt-1">${metadata.error}</div></div>`;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function setupCustomTokenHandler(selectId, containerId, inputId, infoId, onValidCallback) {
            const select = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            if (!select || !container || !input) { console.error('Missing elements:', selectId); return; }

            select.addEventListener('change', function() {
                if (this.value === 'custom') {
                    container.classList.remove('hidden');
                    input.focus();
                } else {
                    container.classList.add('hidden');
                    document.getElementById(infoId).innerHTML = '';
                    input.value = '';
                    input.classList.remove('valid', 'invalid', 'loading');
                }
                if (onValidCallback) onValidCallback();
            });

            const validateInput = debounce(async function() {
                const address = input.value.trim();
                if (!address || address.length < 42) {
                    input.classList.remove('valid', 'invalid', 'loading');
                    document.getElementById(infoId).innerHTML = '';
                    return;
                }
                input.classList.add('loading');
                document.getElementById(infoId).innerHTML = '<div class="p-2 text-xs text-orange-600"><span class="spinner"></span> Validating...</div>';
                const metadata = await fetchTokenMetadata(address);
                displayTokenInfo(input, infoId, metadata);
                if (metadata.valid && onValidCallback) onValidCallback();
            }, 800);

            input.addEventListener('input', validateInput);
            input.addEventListener('paste', () => setTimeout(validateInput, 100));
        }
D4f71b54bdA02913';
                document.getElementById('orderRateInfo').classList.remove('hidden');
                document.getElementById('orderRateValue').textContent = `1 ${getTokenSymbol(tokenIn)} = ${target.toFixed(6)} ${getTokenSymbol(tokenOut)}`;
                const diff = ((target - currentMarketPriceValue) / currentMarketPriceValue) * 100;
                const diffEl = document.getElementById('priceDifference');
                if (Math.abs(diff) < 0.1) { diffEl.textContent = '‚âà At Market Price'; diffEl.className = 'text-xs text-center mt-1 font-semibold text-gray-600'; }
                else if (diff > 0) { diffEl.textContent = `${diff.toFixed(2)}% above market üìà`; diffEl.className = 'text-xs text-center mt-1 font-semibold text-green-600'; }
                else { diffEl.textContent = `${Math.abs(diff).toFixed(2)}% below market üìâ`; diffEl.className = 'text-xs text-center mt-1 font-semibold text-red-600'; }
            } else document.getElementById('orderRateInfo').classList.add('hidden');
        }

        function updateExpirationPreview() {
            const sel = document.getElementById('expirationSelect');
            const custom = document.getElementById('customExpirationInput');
            const preview = document.getElementById('expirationPreview');
            if (sel.value === 'custom') { custom.classList.remove('hidden'); preview.classList.add('hidden'); }
            else { custom.classList.add('hidden'); if (sel.value === '0') preview.classList.add('hidden'); else { preview.textContent = `Expires: ${new Date(Date.now() + parseInt(sel.value) * 1000).toLocaleString()}`; preview.classList.remove('hidden'); } }
        }

        function updateCustomExpiration() {
            const hours = parseInt(document.getElementById('customExpirationHours').value);
            if (hours > 0) { document.getElementById('expirationPreview').textContent = `Expires: ${new Date(Date.now() + hours * 3600000).toLocaleString()}`; document.getElementById('expirationPreview').classList.remove('hidden'); }
        }

        function getExpirationTime() {
            const sel = document.getElementById('expirationSelect');
            if (sel.value === 'custom') { const h = parseInt(document.getElementById('customExpirationHours').value) || 0; return h > 0 ? Math.floor(Date.now() / 1000) + h * 3600 : 0; }
            return sel.value === '0' ? 0 : Math.floor(Date.now() / 1000) + parseInt(sel.value);
        }

        // ============================================
        // SWAP EXECUTION
        // ============================================
        async function executeBatchedSwap(tokenIn, tokenOut, amountWei, minOutWei) {
            try {
                const calls = [];
                const isNative = tokenIn === '0x0000000000000000000000000000000000000000';
                if (!isNative) {
                    calls.push({ to: tokenIn, data: viem.encodeFunctionData({ abi: [{ inputs: [{ name: 'spender', type: 'address' }, { name: 'amount', type: 'uint256' }], name: 'approve', outputs: [{ type: 'bool' }], stateMutability: 'nonpayable', type: 'function' }], functionName: 'approve', args: [CONTRACT_ADDRESS, amountWei.toString()] }), value: '0x0' });
                }
                calls.push({ to: CONTRACT_ADDRESS, data: viem.encodeFunctionData({ abi: [{ inputs: [{ name: 'tokenIn', type: 'address' }, { name: 'tokenOut', type: 'address' }, { name: 'amountIn', type: 'uint256' }, { name: 'minAmountOut', type: 'uint256' }], name: 'instantSwap', outputs: [{ type: 'uint256' }], stateMutability: 'payable', type: 'function' }], functionName: 'instantSwap', args: [tokenIn, tokenOut, amountWei.toString(), minOutWei.toString()] }), value: isNative ? `0x${amountWei.toString(16)}` : '0x0' });
                const caps = await window.ethereum.request({ method: 'wallet_getCapabilities', params: [account] }).catch(() => null);
                if (caps?.['0x2105']?.atomicBatch?.supported && PAYMASTER_URL !== 'YOUR_PAYMASTER_URL_HERE') {
                    const result = await window.ethereum.request({ method: 'wallet_sendCalls', params: [{ from: account, calls, capabilities: { paymasterService: { url: PAYMASTER_URL } } }] });
                    return { hash: result, batched: true };
                }
                return null;
            } catch (e) { console.error('Batched swap error:', e); return null; }
        }

        async function scheduleSwap() {
            if (!isConnected) { alert('Please connect your wallet first'); showWalletModal(); return; }
            const tokenIn = getTokenAddress(document.getElementById('tokenIn'), document.getElementById('customTokenIn'));
            const tokenOut = getTokenAddress(document.getElementById('tokenOut'), document.getElementById('customTokenOut'));
            if (!tokenIn) { alert('Please enter a valid "From" token address'); return; }
            if (!tokenOut) { alert('Please enter a valid "To" token address'); return; }
            const amount = document.getElementById('amountIn').value;
            const minOut = document.getElementById('minAmountOut').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Please enter an amount'); return; }
            if (!minOut || parseFloat(minOut) <= 0) { alert('Unable to get price quote'); return; }
            if (tokenIn === tokenOut) { alert('Please select different tokens'); return; }
            const isNative = tokenIn === '0x0000000000000000000000000000000000000000';
            if (isNative && parseFloat(amount) > userBalanceFrom - GAS_BUFFER_ETH) { alert(`Insufficient balance. Max: ${(userBalanceFrom - GAS_BUFFER_ETH).toFixed(4)} ETH`); return; }
            const isInstant = document.getElementById('timeNow').checked;

            try {
                const amountWei = ethers.utils.parseEther(amount);
                const minOutWei = ethers.utils.parseEther(minOut);
                if (isInstant) {
                    document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Swapping...';
                    document.getElementById('scheduleSwapBtn').disabled = true;
                    const batched = await executeBatchedSwap(tokenIn, tokenOut, amountWei, minOutWei);
                    if (batched?.batched) {
                        updateButtonStates();
                        showSuccessModal(batched.hash, document.getElementById('estimatedAmount').textContent, getTokenSymbol(tokenOut));
                    } else {
                        if (!isNative) {
                            const tc = new ethers.Contract(tokenIn, ['function approve(address,uint256) returns (bool)'], signer);
                            document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Approving...';
                            await (await tc.approve(CONTRACT_ADDRESS, amountWei)).wait();
                        }
                        document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Swapping...';
                        const tx = isNative ? await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, { value: amountWei, gasLimit: 500000 }) : await contract.instantSwap(tokenIn, tokenOut, amountWei, minOutWei, { gasLimit: 500000 });
                        await tx.wait();
                        updateButtonStates();
                        showSuccessModal(tx.hash, document.getElementById('estimatedAmount').textContent, getTokenSymbol(tokenOut));
                    }
                } else {
                    const date = document.getElementById('executionDate').value, time = document.getElementById('executionTime').value;
                    if (!date || !time) { alert('Please set execution date and time'); return; }
                    const execTime = Math.floor(new Date(date + ' ' + time).getTime() / 1000);
                    if (execTime <= Math.floor(Date.now() / 1000)) { alert('Execution time must be in the future'); return; }
                    if (!isNative) { const tc = new ethers.Contract(tokenIn, ['function approve(address,uint256) returns (bool)'], signer); document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Approving...'; document.getElementById('scheduleSwapBtn').disabled = true; await (await tc.approve(CONTRACT_ADDRESS, amountWei)).wait(); }
                    document.getElementById('btnText').innerHTML = '<span class="spinner"></span> Scheduling...';
                    const tx = isNative ? await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime, { value: amountWei }) : await contract.scheduleSwap(tokenIn, tokenOut, amountWei, minOutWei, execTime);
                    await tx.wait();
                    updateButtonStates();
                    alert('üìÖ Swap scheduled!');
                }
                document.getElementById('amountIn').value = '';
                document.getElementById('minAmountOut').value = '';
                document.getElementById('estimatedAmount').textContent = '0.0';
                document.getElementById('usdValueIn').textContent = '$0.00';
                document.getElementById('usdValueOut').textContent = '$0.00';
                if (isConnected) { loadData(); updateBalance(); }
            } catch (e) {
                console.error('Swap error:', e);
                updateButtonStates();
                alert('Swap failed: ' + (e.reason || e.message));
            }
        }

        async function createLimitOrder() {
            if (!isConnected) { alert('Please connect your wallet first'); showWalletModal(); return; }
            const tokenIn = getTokenAddress(document.getElementById('tokenInLimit'), document.getElementById('customTokenInLimit'));
            const tokenOut = getTokenAddress(document.getElementById('tokenOutLimit'), document.getElementById('customTokenOutLimit'));
            if (!tokenIn) { alert('Please enter a valid "You Pay" token address'); return; }
            if (!tokenOut) { alert('Please enter a valid "You Receive" token address'); return; }
            const amount = document.getElementById('amountInLimit').value;
            const target = document.getElementById('targetPrice').value;
            if (!amount || parseFloat(amount) <= 0) { alert('Please enter an amount'); return; }
            if (!target || parseFloat(target) <= 0) { alert('Please enter a target price'); return; }
            if (tokenIn === tokenOut) { alert('Please select different tokens'); return; }

            try {
                const amountWei = ethers.utils.parseEther(amount);
                const targetWei = ethers.utils.parseEther(target);
                document.getElementById('limitBtnText').innerHTML = '<span class="spinner"></span> Creating...';
                document.getElementById('createLimitBtn').disabled = true;
                const isNative = tokenIn === '0x0000000000000000000000000000000000000000';
                if (!isNative) { const tc = new ethers.Contract(tokenIn, ['function approve(address,uint256) returns (bool)'], signer); document.getElementById('limitBtnText').innerHTML = '<span class="spinner"></span> Approving...'; await (await tc.approve(CONTRACT_ADDRESS, amountWei)).wait(); }
                document.getElementById('limitBtnText').innerHTML = '<span class="spinner"></span> Creating Order...';
                const expiry = getExpirationTime();
                const tx = isNative ? await contract.createLimitOrder(tokenIn, tokenOut, amountWei, targetWei, expiry, { value: amountWei, gasLimit: 500000 }) : await contract.createLimitOrder(tokenIn, tokenOut, amountWei, targetWei, expiry, { gasLimit: 500000 });
                await tx.wait();
                alert('üéØ Limit order created!');
                document.getElementById('amountInLimit').value = '';
                document.getElementById('targetPrice').value = '';
                loadData();
            } catch (e) { console.error('Limit order error:', e); alert('Failed: ' + (e.reason || e.message)); }
            finally { document.getElementById('limitBtnText').textContent = 'üéØ Create Limit Order'; document.getElementById('createLimitBtn').disabled = false; }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            try {
                const [total, totalOrders] = await Promise.all([contract.getTotalSwaps(), contract.getTotalLimitOrders()]);
                document.getElementById('totalSwaps').textContent = total.toString();
                document.getElementById('totalLimitOrders').textContent = totalOrders.toString();
                document.getElementById('totalSwapsHeader').textContent = total.toString() + ' completed';
                const [ids, limitIds] = await Promise.all([contract.getUserSwaps(account), contract.getUserLimitOrders(account)]);
                const swaps = await Promise.all(ids.map(async id => { const s = await contract.getSwap(id); return { id: id.toString(), tokenIn: s[1], tokenOut: s[2], amountIn: ethers.utils.formatEther(s[3]), minAmountOut: ethers.utils.formatEther(s[4]), executionTime: new Date(s[5].toNumber() * 1000), status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][s[6]], amountOut: ethers.utils.formatEther(s[7]), type: 'swap' }; }));
                const limits = await Promise.all(limitIds.map(async id => { const lo = await contract.getLimitOrder(id); return { id: id.toString(), tokenIn: lo[1], tokenOut: lo[2], amountIn: ethers.utils.formatEther(lo[3]), targetPrice: ethers.utils.formatEther(lo[4]), expiryTime: lo[5].toNumber() === 0 ? 0 : new Date(lo[5].toNumber() * 1000), status: ['Scheduled', 'Executed', 'Cancelled', 'Failed'][lo[6]], amountOut: ethers.utils.formatEther(lo[7]), type: 'limit' }; }));
                const all = [...swaps, ...limits].sort((a, b) => (b.type === 'swap' ? b.executionTime : b.expiryTime || new Date()) - (a.type === 'swap' ? a.executionTime : a.expiryTime || new Date()));
                document.getElementById('scheduledCount').textContent = swaps.filter(s => s.status === 'Scheduled').length + limits.filter(l => l.status === 'Scheduled').length;
                document.getElementById('executedCount').textContent = swaps.filter(s => s.status === 'Executed').length + limits.filter(l => l.status === 'Executed').length;
                displaySwaps(all);
            } catch (e) { console.error('Load data error:', e); }
        }

        function displaySwaps(orders) {
            const list = document.getElementById('swapsList');
            if (!orders.length) { list.innerHTML = '<div class="text-center py-12 text-secondary"><p>No orders yet! ü•≠</p></div>'; return; }
            list.innerHTML = orders.map(s => {
                const inName = getTokenSymbol(s.tokenIn), outName = getTokenSymbol(s.tokenOut);
                if (s.type === 'limit') {
                    const color = s.status === 'Scheduled' ? 'indigo' : s.status === 'Executed' ? 'green' : 'gray';
                    return `<div class="border-2 border-${color}-200 rounded-xl p-4 mb-3 card-bg shadow-lg"><div class="flex justify-between items-start mb-3"><span class="px-3 py-1 rounded-full text-xs font-semibold bg-${color}-100 text-${color}-800">üéØ ${s.status} Limit Order</span><div class="text-right"><div class="font-bold text-lg text-primary">${parseFloat(s.amountIn).toFixed(4)} ${inName} ‚Üí ${outName}</div><div class="text-sm text-${color}-700">Target: ${parseFloat(s.targetPrice).toFixed(6)} ${outName}</div></div></div><div class="text-xs text-secondary mb-2">${s.expiryTime === 0 ? 'Never expires' : 'Expires: ' + s.expiryTime.toLocaleString()}</div>${s.status === 'Executed' ? `<div class="text-xs text-green-700 font-semibold mb-2">‚úÖ Received: ${parseFloat(s.amountOut).toFixed(6)} ${outName}</div>` : ''}${s.status === 'Scheduled' ? `<button onclick="cancelLimitOrder(${s.id})" class="touch-target w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-2 rounded-lg font-bold text-sm">Cancel Order</button>` : ''}</div>`;
                }
                const color = s.status === 'Scheduled' ? 'yellow' : s.status === 'Executed' ? 'green' : 'gray';
                return `<div class="border-2 border-${color}-200 rounded-xl p-4 mb-3 card-bg shadow-lg"><div class="flex justify-between items-start mb-3"><span class="px-3 py-1 rounded-full text-xs font-semibold bg-${color}-100 text-${color}-800">${s.status} Swap</span><div class="text-right"><div class="font-bold text-lg text-primary">${parseFloat(s.amountIn).toFixed(4)} ${inName} ‚Üí ${outName}</div><div class="text-sm text-secondary">Min: ${parseFloat(s.minAmountOut).toFixed(6)} ${outName}</div></div></div><div class="text-xs text-secondary mb-2">Executes: ${s.executionTime.toLocaleString()}</div>${s.status === 'Executed' ? `<div class="text-xs text-green-700 font-semibold mb-2">‚úÖ Received: ${parseFloat(s.amountOut).toFixed(6)} ${outName}</div>` : ''}${s.status === 'Scheduled' ? `<button onclick="cancelSwap(${s.id})" class="touch-target w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-2 rounded-lg font-bold text-sm">Cancel Swap</button>` : ''}</div>`;
            }).join('');
        }

        async function cancelSwap(id) { try { await (await contract.cancelSwap(id)).wait(); alert('Swap cancelled!'); loadData(); } catch (e) { alert('Failed: ' + e.message); } }
        async function cancelLimitOrder(id) { try { await (await contract.cancelLimitOrder(id)).wait(); alert('Limit order cancelled!'); loadData(); } catch (e) { alert('Failed: ' + e.message); } }
        async function withdrawFees() { try { await (await contract.withdrawFees()).wait(); alert('Fees withdrawn!'); } catch (e) { alert('Failed: ' + e.message); } }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function switchTab(tab) {
            ['schedule', 'limit', 'swaps'].forEach(t => {
                document.getElementById(t + 'Tab').classList.remove('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
                document.getElementById(t + 'Tab').classList.add('text-secondary');
                document.getElementById(t + 'Content').classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.add('bg-gradient-to-r', 'from-orange-500', 'to-yellow-500', 'text-white');
            document.getElementById(tab + 'Tab').classList.remove('text-secondary');
            document.getElementById(tab + 'Content').classList.remove('hidden');
            if (tab === 'limit') updateMarketPrice();
            if (tab === 'swaps' && isConnected) loadData();
        }

        // ============================================
        // MODALS
        // ============================================
        function showSuccessModal(txHash, amountOut, tokenOut) {
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successAmount').textContent = `${parseFloat(amountOut).toFixed(6)} ${tokenOut}`;
            document.getElementById('basescanLink').onclick = () => window.open(`https://basescan.org/tx/${txHash}`, '_blank');
            createConfetti();
        }
        function hideSuccessModal() { document.getElementById('successModal').classList.add('hidden'); }
        function createConfetti() {
            const c = document.getElementById('confettiContainer'); c.innerHTML = '';
            const colors = ['#ff6b35', '#f7931e', '#fdc830', '#37b34a', '#4facfe', '#a78bfa'];
            for (let i = 0; i < 50; i++) { const d = document.createElement('div'); d.className = 'confetti'; d.style.left = Math.random() * 100 + '%'; d.style.animationDelay = Math.random() * 0.5 + 's'; d.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; c.appendChild(d); }
            setTimeout(() => c.innerHTML = '', 3000);
        }

        // ============================================
        // FARCASTER MINI APP
        // ============================================
        async function loadMiniAppContext() {
            try {
                if (window.FarcasterMiniAppSDK?.sdk) { sdk = window.FarcasterMiniAppSDK.sdk; isInMiniApp = await sdk.isInMiniApp(); if (isInMiniApp) miniAppContext = await sdk.context; }
            } catch (e) { console.error('Mini app context error:', e); }
        }
        async function initializeApp() {
            await new Promise(r => setTimeout(r, 500));
            try { if (window.FarcasterMiniAppSDK?.sdk?.actions?.ready) await window.FarcasterMiniAppSDK.sdk.actions.ready(); } catch (e) { console.error('Ready error:', e); }
        }

        // ============================================
        // ONBOARDING
        // ============================================
        let currentOnboardingScreen = 1;
        function closeOnboarding() { document.getElementById('onboardingModal').classList.add('hidden'); localStorage.setItem('mangoswapOnboardingComplete', 'true'); }
        function nextOnboardingScreen() {
            document.querySelector('.onboarding-screen.active').classList.remove('active');
            currentOnboardingScreen++;
            document.querySelector(`[data-screen="${currentOnboardingScreen}"]`).classList.add('active');
        }
        if (localStorage.getItem('mangoswapOnboardingComplete') === 'true') document.getElementById('onboardingModal')?.classList.add('hidden');

        window.cancelSwap = cancelSwap;
        window.cancelLimitOrder = cancelLimitOrder;
        window.closeOnboarding = closeOnboarding;
        window.nextOnboardingScreen = nextOnboardingScreen;
    </script>
</body>
</html>
